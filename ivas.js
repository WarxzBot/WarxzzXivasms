
/* * PROJECT: WARXZZ NEW 
 * PROTECTED MANUAL 
 */
eval(Buffer.from('Ci8qICogUFJPSkVDVDogV0FSWFpaIE5FVyAKICogUFJPVEVDVEVEIE1BTlVBTCAKICovIApjb25zdCB7IFRlbGVncmFmLCBNYXJrdXAgfSA9IHJlcXVpcmUoJ3RlbGVncmFmJyk7CmNvbnN0IHB1cHBldGVlciA9IHJlcXVpcmUoJ3B1cHBldGVlci1leHRyYScpOwpjb25zdCBwdXBwZXRlZXJFeHRyYSA9IHJlcXVpcmUoJ3B1cHBldGVlci1leHRyYScpOwpjb25zdCBTdGVhbHRoUGx1Z2luID0gcmVxdWlyZSgncHVwcGV0ZWVyLWV4dHJhLXBsdWdpbi1zdGVhbHRoJyk7CmNvbnN0IHsgcGFyc2VQaG9uZU51bWJlciB9ID0gcmVxdWlyZSgnbGlicGhvbmVudW1iZXItanMnKTsKY29uc3QgZnMgPSByZXF1aXJlKCdmcycpOwpjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpOwpjb25zdCBybCA9IHJlcXVpcmUoJ3JlYWRsaW5lL3Byb21pc2VzJyk7CmNvbnN0IHNldHRpbmdzID0gcmVxdWlyZSgnLi9zZXR0aW5ncycpOwpjb25zdCBYTFNYID0gcmVxdWlyZSgneGxzeCcpOwpjb25zdCBjc3YgPSByZXF1aXJlKCdjc3YtcGFyc2VyJyk7CmNvbnN0IHsgUGFzc1Rocm91Z2ggfSA9IHJlcXVpcmUoJ3N0cmVhbScpOwpjb25zdCBjaGFsayA9IHJlcXVpcmUoJ2NoYWxrJyk7CmNvbnN0IGF4aW9zID0gcmVxdWlyZSgnYXhpb3MnKTsKCnB1cHBldGVlckV4dHJhLnVzZShTdGVhbHRoUGx1Z2luKCkpOwoKY29uc3QgQUxMT1dFRF9UT0tFTlNfVVJMID0gJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9XYXJ4ekJvdC9idWthbi1hcGEtYXBhL21haW4vYWxsb3dlZC10b2tlbnMuanNvbic7Cgphc3luYyBmdW5jdGlvbiBnZXRBbGxvd2VkVG9rZW5zKCkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLmdldChBTExPV0VEX1RPS0VOU19VUkwsIHsKICAgICAgICAgICAgdGltZW91dDogMTAwMDAsCiAgICAgICAgICAgIGhlYWRlcnM6IHsgJ1VzZXItQWdlbnQnOiAnTW96aWxsYS81LjAnIH0KICAgICAgICB9KTsKICAgICAgICBsZXQgYWxsb3dlZFRva2VucyA9IFtdOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3BvbnNlLmRhdGEpKSB7CiAgICAgICAgICAgIGFsbG93ZWRUb2tlbnMgPSByZXNwb25zZS5kYXRhOwogICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YSAmJiByZXNwb25zZS5kYXRhLmFsbG93ZWRfdG9rZW5zICYmIEFycmF5LmlzQXJyYXkocmVzcG9uc2UuZGF0YS5hbGxvd2VkX3Rva2VucykpIHsKICAgICAgICAgICAgYWxsb3dlZFRva2VucyA9IHJlc3BvbnNlLmRhdGEuYWxsb3dlZF90b2tlbnM7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVzcG9uc2UuZGF0YSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgYWxsb3dlZFRva2VucyA9IE9iamVjdC52YWx1ZXMocmVzcG9uc2UuZGF0YSkuZmlsdGVyKHRva2VuID0+IHR5cGVvZiB0b2tlbiA9PT0gJ3N0cmluZycgJiYgdG9rZW4ubGVuZ3RoID4gMTApOwogICAgICAgIH0KICAgICAgICBpZiAoYWxsb3dlZFRva2Vucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFtUT0tFTiBWQUxJREFUSU9OXSBEYWZ0YXIgdG9rZW4ga29zb25nIGRpIGRhdGFiYXNlYCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWxsb3dlZFRva2VuczsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFtUT0tFTiBWQUxJREFUSU9OXSBHYWdhbCBtZW5nYW1iaWwgZGFmdGFyIHRva2VuIGRhcmkgZGF0YWJhc2U6YCksIGVycm9yLm1lc3NhZ2UpOwogICAgICAgIHJldHVybiBbXTsKICAgIH0KfQoKCgovLyAtLS0gRlVOR1NJIFVQREFURSBUT0tFTiAoU2lrYXQgc2VtdWEgZHVwbGlrYXQpIC0tLQpmdW5jdGlvbiBzYXZlVG9rZW5Ub1NldHRpbmdzKHRva2VuKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IHNldHRpbmdzRmlsZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnc2V0dGluZ3MuanMnKTsKICAgICAgICBsZXQgZmlsZUNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoc2V0dGluZ3NGaWxlUGF0aCwgJ3V0ZjgnKTsKICAgICAgIAogICAgICAgIGNvbnN0IHRva2VuUmVnZXggPSAvKCJUT0tFTiJ8VE9LRU4pXHMqWzo9XVxzKlsnIl0oW14nIl0qKVsnIl0vZzsKICAgICAgICAKICAgICAgICBpZiAodG9rZW5SZWdleC50ZXN0KGZpbGVDb250ZW50KSkgewogICAgICAgICAgICBmaWxlQ29udGVudCA9IGZpbGVDb250ZW50LnJlcGxhY2UodG9rZW5SZWdleCwgKG1hdGNoLCBwMSkgPT4gYCR7cDF9OiAnJHt0b2tlbn0nYCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmlsZUNvbnRlbnQgPSBmaWxlQ29udGVudC5yZXBsYWNlKC99Oz9ccyokLywgYCAgVE9LRU46ICcke3Rva2VufScsXG59O2ApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHNldHRpbmdzRmlsZVBhdGgsIGZpbGVDb250ZW50LCAndXRmOCcpOwogICAgICAgIC8vIFVwZGF0ZSBtZW1vcmkgc3VwYXlhIGxhbmdzdW5nIHNpbmtyb24KICAgICAgICBzZXR0aW5ncy5UT0tFTiA9IHRva2VuOyAKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbigi4pyFIFRva2VuIGJlcmhhc2lsIGRpdXBkYXRlIGRpIHNldHRpbmdzLmpzIikpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZCgi4p2MIEdhZ2FsIG1lbnlpbXBhbiB0b2tlbjoiKSwgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9CgoKYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVCb3RUb2tlbih0b2tlbikgewogICAgY29uc3QgYWxsb3dlZFRva2VucyA9IGF3YWl0IGdldEFsbG93ZWRUb2tlbnMoKTsKICAgIGlmIChhbGxvd2VkVG9rZW5zLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoY2hhbGsucmVkKCdbVE9LRU4gVkFMSURBVElPTl0gVGlkYWsgZGFwYXQgbWVuZ2FtYmlsIGRhZnRhciB0b2tlbiBkYXJpIEdpdEh1YicpKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCBpc1ZhbGlkID0gYWxsb3dlZFRva2Vucy5pbmNsdWRlcyh0b2tlbi50cmltKCkpOwogICAgcmV0dXJuIGlzVmFsaWQ7Cn0KCmFzeW5jIGZ1bmN0aW9uIGFza0ZvclRva2VuKCkgewogICAgY29uc3QgcmVhZGxpbmUgPSBybC5jcmVhdGVJbnRlcmZhY2UoeyBpbnB1dDogcHJvY2Vzcy5zdGRpbiwgb3V0cHV0OiBwcm9jZXNzLnN0ZG91dCB9KTsKICAgIGNvbnNvbGUubG9nKGNoYWxrLmN5YW4oIuKVlOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVlyIpKTsKICAgIGNvbnNvbGUubG9nKGNoYWxrLmN5YW4oIuKVkSAgICAgIFNFVFVQIEJPVCBURUxFR1JBTSBUT0tFTiAgICAgICAg4pWRIikpOwogICAgY29uc29sZS5sb2coY2hhbGsuY3lhbigi4pWa4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWdIikpOwogICAgbGV0IHRva2VuID0gJyc7CiAgICB3aGlsZSAoIXRva2VuIHx8ICF0b2tlbi5pbmNsdWRlcygnOicpKSB7CiAgICAgICAgdG9rZW4gPSBhd2FpdCByZWFkbGluZS5xdWVzdGlvbihjaGFsay5jeWFuKCJNYXN1a2thbiBUb2tlbiBCb3QgKGRhcmkgQm90RmF0aGVyKTogIikpOwogICAgICAgIHRva2VuID0gdG9rZW4udHJpbSgpOwogICAgICAgIGlmICghdG9rZW4pIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgi4p2MIFRva2VuIHRpZGFrIGJvbGVoIGtvc29uZyIpKTsKICAgICAgICBlbHNlIGlmICghdG9rZW4uaW5jbHVkZXMoJzonKSkgY29uc29sZS5sb2coY2hhbGsucmVkKCLinYwgRm9ybWF0IHRva2VuIHRpZGFrIHZhbGlkISIpKTsKICAgIH0KICAgIHJlYWRsaW5lLmNsb3NlKCk7CiAgICByZXR1cm4gdG9rZW47Cn0KCgovLyAtLS0gRlVOR1NJIFVQREFURSBPV05FUiBJRCAoU2ltcGFuIGtlIGlkIG93bmVyL09XTkVSX0lEKSAtLS0KYXN5bmMgZnVuY3Rpb24gYXNrRm9yT3duZXJJZCgpIHsKICAgIGNvbnN0IHJlYWRsaW5lID0gcmwuY3JlYXRlSW50ZXJmYWNlKHsgaW5wdXQ6IHByb2Nlc3Muc3RkaW4sIG91dHB1dDogcHJvY2Vzcy5zdGRvdXQgfSk7CiAgICBjb25zb2xlLmxvZyhjaGFsay5jeWFuKCLilZTilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZciKSk7CiAgICBjb25zb2xlLmxvZyhjaGFsay5jeWFuKCLilZEgICAgICBTRVRVUCBJRCBURUxFR1JBTSBPV05FUiAgICAgICAgIOKVkSIpKTsKICAgIGNvbnNvbGUubG9nKGNoYWxrLmN5YW4oIuKVmuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVnSIpKTsKICAgIGxldCBvd25lcklkID0gJyc7CiAgICB3aGlsZSAoIW93bmVySWQgfHwgaXNOYU4ob3duZXJJZCkpIHsKICAgICAgICBvd25lcklkID0gYXdhaXQgcmVhZGxpbmUucXVlc3Rpb24oY2hhbGsuY3lhbigiTWFzdWtrYW4gSUQgVGVsZWdyYW0gQW5kYTogIikpOwogICAgICAgIG93bmVySWQgPSBvd25lcklkLnRyaW0oKTsKICAgICAgICBpZiAoIW93bmVySWQpIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgi4p2MIElEIHRpZGFrIGJvbGVoIGtvc29uZyIpKTsKICAgICAgICBlbHNlIGlmIChpc05hTihvd25lcklkKSkgY29uc29sZS5sb2coY2hhbGsucmVkKCLinYwgSUQgaGFydXMgYW5na2EhIikpOwogICAgfQogICAgcmVhZGxpbmUuY2xvc2UoKTsKICAgIHJldHVybiBvd25lcklkOwp9CgpmdW5jdGlvbiBzYXZlT3duZXJJZFRvU2V0dGluZ3Mob3duZXJJZCkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBzZXR0aW5nc0ZpbGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ3NldHRpbmdzLmpzJyk7CiAgICAgICAgbGV0IGZpbGVDb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKHNldHRpbmdzRmlsZVBhdGgsICd1dGY4Jyk7CiAgICAgICAgCiAgICAgICAgLy8gUGFzdGlrYW4gbmlsYWkgeWFuZyBkaXNpbXBhbiBhZGFsYWggYW5na2EsIGppa2Ega29zb25nIGphZGlrYW4gMAogICAgICAgIGNvbnN0IGZpbmFsSWQgPSAob3duZXJJZCAmJiAhaXNOYU4ob3duZXJJZCkpID8gb3duZXJJZCA6IDA7CgogICAgICAgIGNvbnN0IGlkUmVnZXggPSAvKCJPV05FUl9JRCJ8T1dORVJfSUQpXHMqWzo9XVxzKlsnIl0/KFteJyIsXHN9XSopWyciXT8vZzsKICAgICAgICAKICAgICAgICBpZiAoaWRSZWdleC50ZXN0KGZpbGVDb250ZW50KSkgewogICAgICAgICAgICAvLyBTaW1wYW4gU0VCQUdBSSBBTkdLQSAodGFucGEgdGFuZGEga3V0aXApCiAgICAgICAgICAgIGZpbGVDb250ZW50ID0gZmlsZUNvbnRlbnQucmVwbGFjZShpZFJlZ2V4LCBgIk9XTkVSX0lEIjogJHtmaW5hbElkfWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZpbGVDb250ZW50ID0gZmlsZUNvbnRlbnQucmVwbGFjZSgvfTs/XHMqJC8sIGAgICJPV05FUl9JRCI6ICR7ZmluYWxJZH0sXG59O2ApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHNldHRpbmdzRmlsZVBhdGgsIGZpbGVDb250ZW50LCAndXRmOCcpOwogICAgICAgIHNldHRpbmdzLk9XTkVSX0lEID0gTnVtYmVyKGZpbmFsSWQpOyAvLyBVcGRhdGUgbWVtb3JpIHNlYmFnYWkgYW5na2EKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9CgoKLy8gLS0tIEFMVVIgVkFMSURBU0kgVVRBTUEgLS0tCmFzeW5jIGZ1bmN0aW9uIHNldHVwQW5kVmFsaWRhdGVUb2tlbigpIHsKICAgIGNvbnNvbGUubG9nKGNoYWxrLmJsdWUoIuKVlOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVlyIpKTsKICAgIGNvbnNvbGUubG9nKGNoYWxrLmJsdWUoIuKVkSAgICAgVE9LRU4gVkFMSURBVElPTiBTWVNURU0gICAgICAgICAg4pWRIikpOwogICAgY29uc29sZS5sb2coY2hhbGsuYmx1ZSgi4pWa4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWdIikpOwogICAgCiAgICBsZXQgdG9rZW4gPSBzZXR0aW5ncy5UT0tFTiB8fCAnJzsKICAgIAogICAgLy8gMS4gQ2VrIFRva2VuCiAgICBpZiAoIXRva2VuIHx8IHRva2VuLmxlbmd0aCA8IDEwKSB7CiAgICAgICAgY29uc29sZS5sb2coY2hhbGsueWVsbG93KCLimqDvuI8gVG9rZW4gYmVsdW0gdmFsaWQgZGkgc2V0dGluZ3MuanMiKSk7CiAgICAgICAgdG9rZW4gPSBhd2FpdCBhc2tGb3JUb2tlbigpOwogICAgICAgIGlmICghdG9rZW4uaW5jbHVkZXMoJzonKSkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5yZWQoIuKdjCBGb3JtYXQgdG9rZW4gc2FsYWghIikpOwogICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNhdmVkID0gc2F2ZVRva2VuVG9TZXR0aW5ncyh0b2tlbik7CiAgICAgICAgaWYgKCFzYXZlZCkgcHJvY2Vzcy5leGl0KDEpOwogICAgfQogICAgCiAgICAvLyAyLiBWYWxpZGFzaSBUb2tlbiBrZSBTZXJ2ZXIKICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCB2YWxpZGF0ZUJvdFRva2VuKHRva2VuKTsKICAgIGlmICghaXNWYWxpZCkgewogICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgi4pWU4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWXIikpOwogICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgi4pWRICAgICBUT0tFTiBUSURBSyBURVJEQUZUQVIgICAgICAgICAgIOKVkSIpKTsKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5yZWQoIuKVmuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVnSIpKTsKICAgICAgICBwcm9jZXNzLmV4aXQoMSk7CiAgICB9CiAgICAKICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuKCLilZTilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZciKSk7CiAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbigi4pWRICAgICBUT0tFTiBWQUxJREFUSU9OIEJFUkhBU0lMICAgICAgICDilZEiKSk7CiAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbigi4pWa4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWdIikpOwoKICAgIGxldCBvd25lcklkID0gc2V0dGluZ3MuT1dORVJfSUQgfHwgJyc7CiAgICBpZiAoIW93bmVySWQgfHwgb3duZXJJZCA9PT0gJzAnIHx8IG93bmVySWQgPT09IDApIHsKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay55ZWxsb3coIuKaoO+4jyBPd25lciBJRCBiZWx1bSBkaXNldCEiKSk7CiAgICAgICAgb3duZXJJZCA9IGF3YWl0IGFza0Zvck93bmVySWQoKTsKICAgICAgICBjb25zdCBzYXZlZElkID0gc2F2ZU93bmVySWRUb1NldHRpbmdzKG93bmVySWQpOwogICAgICAgIGlmICghc2F2ZWRJZCkgcHJvY2Vzcy5leGl0KDEpOwogICAgfQogICAgCiAgICByZXR1cm4gdG9rZW47Cn0KCihhc3luYyAoKSA9PiB7CiAgICB0cnkgewogICAgICAgIGF3YWl0IHNldHVwQW5kVmFsaWRhdGVUb2tlbigpOwogICAgICAgIAogICAgICAgIGNvbnNvbGUuY2xlYXIoKTsgCiAgICAgICAgCiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZC55ZWxsb3coIuKVlOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVlyIpKTsKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkLnllbGxvdygi4pWRICAgICAgSVZBU01TIEJPVCBSRUNJRVZFIEFDVElWRUQgICAgICDilZEiKSk7CiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZC55ZWxsb3coIuKVmuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVnSIpKTsKICAgICAgICAKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkLmdyZWVuKCJcbvCfmoAgU0VNVUEgVkFMSURBU0kgQkVSSEFTSUwsIE1FTllBTEFLQU4gQk9ULi4uIikpOwoKICAgICAgICBhd2FpdCBpbml0aWFsaXplQm90KCk7CgogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoY2hhbGsucmVkKCLinYwgRVJST1I6IiksIGUubWVzc2FnZSk7CiAgICAgICAgcHJvY2Vzcy5leGl0KDEpOwogICAgfQp9KSgpOwoKCgpjb25zdCBzZXR0aW5nc0ZpbGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ3NldHRpbmdzLmpzJyk7CmNvbnN0IFRFTVBfRElSID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ3RlbXAnKTsKY29uc3QgU1NfRElSID0gcGF0aC5qb2luKFRFTVBfRElSLCAnc2NyZWVuc2hvdHMnKTsKY29uc3QgUFJPSkVDVF9OQU1FID0gc2V0dGluZ3MuUFJPSkVDVF9OQU1FIHx8ICJLSUxMVUEgTkVXIjsKY29uc3QgTElWRV9TTVNfVVJMID0gImh0dHBzOi8vd3d3Lml2YXNtcy5jb20vcG9ydGFsL2xpdmUvbXlfc21zIjsKY29uc3QgUkFOR0VfQkFTRV9VUkwgPSAiaHR0cHM6Ly93d3cuaXZhc21zLmNvbS9wb3J0YWwvc21zL3Rlc3Qvc21zIjsKY29uc3QgREFTSF9VUkwgPSAiaHR0cHM6Ly93d3cuaXZhc21zLmNvbS9wb3J0YWwiOwpjb25zdCBDSEVDS19JTlRFUlZBTF9NUyA9IDE1MDAwOwpjb25zdCBMT0dfSU5URVJWQUxfTVMgPSA1MDAwOwpjb25zdCBJTklUSUFMX0NPTk5FQ1RfVElNRU9VVF9NUyA9IDYwMDAwOwpjb25zdCBTQ1JFRU5TSE9UX1RJTUVPVVRfTVMgPSA2MDAwMDsKY29uc3QgTUFDQk9PS19VU0VSX0FHRU5UID0gIk1vemlsbGEvNS4wIChNYWNpbnRvc2g7IEludGVsIE1hYyBPUyBYIDEwXzE1XzcpIEFwcGxlV2ViS2l0LzYwNS4xLjE1IChLSFRNTCwgbGlrZSBHZWNrbykgVmVyc2lvbi8xNy4wIFNhZmFyaS82MDUuMS4xNSI7CmNvbnN0IE1BQ0JPT0tfVklFV1BPUlQgPSB7IHdpZHRoOiAxNDQwLCBoZWlnaHQ6IDkwMCB9OwoKbGV0IGlzUG9sbGluZ0FjdGl2ZSA9IGZhbHNlOwpsZXQgbGl2ZVNtc1BhZ2UgPSBudWxsOwpjb25zdCBzZW50T3RwcyA9IG5ldyBTZXQoKTsKbGV0IGxhc3RMb2dnZWRTdGF0dXMgPSAnSW5pdGlhbGl6aW5nJzsKbGV0IGxhc3RDaGVja1RpbWUgPSAiTi9BIjsKbGV0IGRpc2Nvbm5lY3RBbGVydFNlbnQgPSBmYWxzZTsKbGV0IGJvdFN0YXR1cyA9ICdJbml0aWFsaXppbmcnOwpsZXQgYnJvd3NlciA9IG51bGw7CmxldCBpc0Jyb3dzZXJSZWFkeSA9IGZhbHNlOwpsZXQgZGlzY29ubmVjdFJldHJ5Q291bnQgPSAwOwpjb25zdCBNQVhfRkFUQUxfRkFJTFVSRVMgPSA1Owpjb25zdCBib3QgPSBuZXcgVGVsZWdyYWYoc2V0dGluZ3MuVE9LRU4pOwpjb25zdCBPV05FUl9JRCA9IE51bWJlcihzZXR0aW5ncy5PV05FUl9JRCk7CmNvbnN0IENIQVRfSUQgPSBOdW1iZXIoc2V0dGluZ3MuQ0hBVF9JRCk7CmxldCBsYXN0U3RhdHVzTG9nID0gMDsKY29uc3QgU1RBVFVTX0xPR19JTlRFUlZBTCA9IDMwMDAwMDsKCmJvdC5jYXRjaCgoZXJyLCBjdHgpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoY2hhbGsucmVkKGBbQk9UIEVSUk9SXWApLCBlcnIpOwogICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFVwZGF0ZSB5YW5nIGVycm9yOmApLCBjdHgudXBkYXRlKTsKfSk7Cgpwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAocmVhc29uLCBwcm9taXNlKSA9PiB7CiAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZCgnVW5oYW5kbGVkIFJlamVjdGlvbiBhdDonKSwgcHJvbWlzZSwgJ3JlYXNvbjonLCByZWFzb24pOwp9KTsKCnByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycm9yKSA9PiB7CiAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZCgnW1NUQVRVU10gVW5jYXVnaHQgRXhjZXB0aW9uOicpLCBlcnJvcik7Cn0pOwoKY29uc3Qgb3duZXJPbmx5ID0gYXN5bmMgKGN0eCwgbmV4dCkgPT4gewogICAgY29uc3QgdXNlcklkID0gY3R4LmZyb20uaWQ7CiAgICBpZiAodXNlcklkID09PSBPV05FUl9JRCkgcmV0dXJuIG5leHQoKTsKICAgIGlmIChjdHgudXBkYXRlVHlwZSA9PT0gJ21lc3NhZ2UnIHx8IGN0eC51cGRhdGVUeXBlID09PSAnY2FsbGJhY2tfcXVlcnknKSB7CiAgICAgICAgaWYgKGN0eC5jYWxsYmFja1F1ZXJ5KSB7CiAgICAgICAgICAgIGF3YWl0IGN0eC5hbnN3ZXJDYlF1ZXJ5KCLimqDvuI8gQWtzZXMgRGl0b2xhay4gSGFueWEgT3duZXIgeWFuZyBiaXNhIG1lbmdndW5ha2FuIHBlcmludGFoIGluaS4iKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdHgucmVwbHkoIuKaoO+4jyBBa3NlcyBEaXRvbGFrLiBIYW55YSBPd25lciB5YW5nIGJpc2EgbWVuZ2d1bmFrYW4gcGVyaW50YWggaW5pLiIpOwogICAgICAgIH0KICAgIH0KfTsKCmNvbnN0IHJlcGx5SFRNTCA9IChjdHgsIHRleHQsIGtleWJvYXJkID0ge30pID0+IHsKICAgIHJldHVybiBjdHgucmVwbHlXaXRoSFRNTCh0ZXh0LCB7IAogICAgICAgIHJlcGx5X21hcmt1cDoga2V5Ym9hcmQucmVwbHlfbWFya3VwLAogICAgICAgIHJlcGx5X3RvX21lc3NhZ2VfaWQ6IGN0eC5tZXNzYWdlID8gY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZCA6IHVuZGVmaW5lZAogICAgfSkuY2F0Y2goZXJyID0+IHsKICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZChgW1JFUExZIEVSUk9SXSAke2Vyci5tZXNzYWdlfWApKTsKICAgICAgICAvLyBGYWxsYmFjazogY29iYSBraXJpbSB0YW5wYSByZXBseQogICAgICAgIHJldHVybiBjdHgucmVwbHlXaXRoSFRNTCh0ZXh0LCB7IAogICAgICAgICAgICByZXBseV9tYXJrdXA6IGtleWJvYXJkLnJlcGx5X21hcmt1cCAKICAgICAgICB9KS5jYXRjaChjb25zb2xlLmVycm9yKTsKICAgIH0pOwp9OwoKY29uc3QgZGVsZXRlTWVzc2FnZSA9IGFzeW5jIChjdHgpID0+IHsKICAgIHRyeSB7CiAgICAgICAgaWYgKGN0eC5tZXNzYWdlICYmIGN0eC5tZXNzYWdlLm1lc3NhZ2VfaWQpIHsKICAgICAgICAgICAgYXdhaXQgY3R4LmRlbGV0ZU1lc3NhZ2UoY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZCk7CiAgICAgICAgfSBlbHNlIGlmIChjdHguY2FsbGJhY2tRdWVyeSAmJiBjdHguY2FsbGJhY2tRdWVyeS5tZXNzYWdlKSB7CiAgICAgICAgICAgIGF3YWl0IGN0eC5kZWxldGVNZXNzYWdlKGN0eC5jYWxsYmFja1F1ZXJ5Lm1lc3NhZ2UubWVzc2FnZV9pZCk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkge30KfTsKCmNvbnN0IGVkaXRPclJlcGx5SFRNTCA9IGFzeW5jIChjdHgsIHRleHQsIGtleWJvYXJkLCBtZXNzYWdlSWRUb0VkaXQpID0+IHsKICAgIHRyeSB7CiAgICAgICAgaWYgKGN0eC5jYWxsYmFja1F1ZXJ5KSB7CiAgICAgICAgICAgIGF3YWl0IGN0eC5hbnN3ZXJDYlF1ZXJ5KCkuY2F0Y2goKCkgPT4ge30pOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZUlkVG9FZGl0KSB7CiAgICAgICAgICAgIGNvbnN0IGVkaXRlZE1lc3NhZ2UgPSBhd2FpdCBjdHgudGVsZWdyYW0uZWRpdE1lc3NhZ2VUZXh0KGN0eC5jaGF0LmlkLCBtZXNzYWdlSWRUb0VkaXQsIG51bGwsIHRleHQsIHsgcGFyc2VfbW9kZTogJ0hUTUwnLCByZXBseV9tYXJrdXA6IGtleWJvYXJkLnJlcGx5X21hcmt1cCB9KTsKICAgICAgICAgICAgcmV0dXJuIGVkaXRlZE1lc3NhZ2U7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkge30KICAgIHJldHVybiByZXBseUhUTUwoY3R4LCB0ZXh0LCBrZXlib2FyZCk7Cn07Cgpjb25zdCBjaHVua0FycmF5ID0gKGFyciwgc2l6ZSkgPT4gewogICAgY29uc3QgcmVzdWx0ID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkgKz0gc2l6ZSkgewogICAgICAgIHJlc3VsdC5wdXNoKGFyci5zbGljZShpLCBpICsgc2l6ZSkpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfTsKCmNvbnN0IGRvd25sb2FkRmlsZSA9IGFzeW5jIChmaWxlSWQsIGZpbGVOYW1lKSA9PiB7CiAgICBmcy5ta2RpclN5bmMoVEVNUF9ESVIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pOwogICAgY29uc3QgbG9jYWxQYXRoID0gcGF0aC5qb2luKFRFTVBfRElSLCBmaWxlTmFtZSk7CiAgICB0cnkgewogICAgICAgIGNvbnN0IGZpbGVMaW5rID0gYXdhaXQgYm90LnRlbGVncmFtLmdldEZpbGVMaW5rKGZpbGVJZCk7CiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcyh7CiAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgIHVybDogZmlsZUxpbmsuaHJlZiwKICAgICAgICAgICAgcmVzcG9uc2VUeXBlOiAnc3RyZWFtJwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHdyaXRlciA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGxvY2FsUGF0aCk7CiAgICAgICAgcmVzcG9uc2UuZGF0YS5waXBlKHdyaXRlcik7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgd3JpdGVyLm9uKCdmaW5pc2gnLCAoKSA9PiByZXNvbHZlKGxvY2FsUGF0aCkpOwogICAgICAgICAgICB3cml0ZXIub24oJ2Vycm9yJywgcmVqZWN0KTsKICAgICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhsb2NhbFBhdGgpKSB7CiAgICAgICAgICAgIHRyeSB7IGZzLnVubGlua1N5bmMobG9jYWxQYXRoKTsgfSBjYXRjaChlcnIpIHsgfQogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEdhZ2FsIG1lbmd1bmR1aCBmaWxlIGRhcmkgVGVsZWdyYW06ICR7ZS5tZXNzYWdlfWApOwogICAgfQp9OwoKY29uc3QgZGV0ZWN0VHlwZUJ5TmFtZSA9IChmaWxlTmFtZSkgPT4gewogICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVOYW1lKS50b0xvd2VyQ2FzZSgpOwogICAgaWYgKFsnLmNzdicsICcudHh0J10uaW5jbHVkZXMoZXh0KSkgcmV0dXJuICdjc3YnOwogICAgaWYgKFsnLnhsc3gnLCAnLnhscyddLmluY2x1ZGVzKGV4dCkpIHJldHVybiAneGxzeCc7CiAgICBpZiAoWycudmNmJywgJy52Y2FyZCddLmluY2x1ZGVzKGV4dCkpIHJldHVybiAndmNmJzsKICAgIHJldHVybiBudWxsOwp9OwoKY29uc3QgZ2V0Q291bnRyeUluZm8gPSAobnVtYmVyKSA9PiB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IG51bSA9IG51bWJlci5zdGFydHNXaXRoKCcrJykgPyBudW1iZXIgOiBgKyR7bnVtYmVyfWA7CiAgICAgICAgY29uc3QgcCA9IHBhcnNlUGhvbmVOdW1iZXIobnVtKTsKICAgICAgICBpZiAocCAmJiBwLmlzVmFsaWQoKSAmJiBwLmNvdW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnRsLkRpc3BsYXlOYW1lcyhbJ2VuJ10sIHsgdHlwZTogJ3JlZ2lvbicgfSkub2YocC5jb3VudHJ5KSB8fCBwLmNvdW50cnk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkge30KICAgIHJldHVybiAiVU5LTk9XTiI7Cn07Cgpjb25zdCBpc0xpa2VseVBob25lTnVtYmVyID0gKHZhbHVlKSA9PiB7CiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwogICAgY29uc3QgY2xlYW5WYWx1ZSA9IHZhbHVlLnRyaW0oKS5yZXBsYWNlKC9bXHNcKFwpLV0vZywgJycpOwogICAgcmV0dXJuIC9eXCs/XGR7OCwxNX0kLy50ZXN0KGNsZWFuVmFsdWUpOwp9OwoKY29uc3QgZ2V0Q291bnRyeUZsYWcgPSAoY291bnRyeU5hbWUpID0+IHsKICAgIGNvbnN0IGZsYWdNYXAgPSB7CiAgICAgICAgJ0lORE9ORVNJQSc6ICfwn4eu8J+HqScsICdNT1pBTUJJUVVFJzogJ/Cfh7Lwn4e/JywgJ1NSSSBMQU5LQSc6ICfwn4ex8J+HsCcsCiAgICAgICAgJ01BTEFZU0lBJzogJ/Cfh7Lwn4e+JywgJ1RIQUlMQU5EJzogJ/Cfh7nwn4etJywgJ1ZJRVROQU0nOiAn8J+Hu/Cfh7MnLAogICAgICAgICdQSElMSVBQSU5FUyc6ICfwn4e18J+HrScsICdTSU5HQVBPUkUnOiAn8J+HuPCfh6wnLCAnSU5ESUEnOiAn8J+HrvCfh7MnLAogICAgICAgICdQQUtJU1RBTic6ICfwn4e18J+HsCcsICdCQU5HTEFERVNIJzogJ/Cfh6fwn4epJywgJ05FUEFMJzogJ/Cfh7Pwn4e1JywKICAgICAgICAnQ0hJTkEnOiAn8J+HqPCfh7MnLCAnSkFQQU4nOiAn8J+Hr/Cfh7UnLCAnU09VVEggS09SRUEnOiAn8J+HsPCfh7cnLAogICAgICAgICdSVVNTSUEnOiAn8J+Ht/Cfh7onLCAnVUtSQUlORSc6ICfwn4e68J+HpicsICdQT0xBTkQnOiAn8J+HtfCfh7EnLAogICAgICAgICdHRVJNQU5ZJzogJ/Cfh6nwn4eqJywgJ0ZSQU5DRSc6ICfwn4er8J+HtycsICdJVEFMWSc6ICfwn4eu8J+HuScsCiAgICAgICAgJ1NQQUlOJzogJ/Cfh6rwn4e4JywgJ1BPUlRVR0FMJzogJ/Cfh7Xwn4e5JywgJ05FVEhFUkxBTkRTJzogJ/Cfh7Pwn4exJywKICAgICAgICAnQkVMR0lVTSc6ICfwn4en8J+HqicsICdTV0lUWkVSTEFORCc6ICfwn4eo8J+HrScsICdBVVNUUklBJzogJ/Cfh6bwn4e5JywKICAgICAgICAnVU5JVEVEIEtJTkdET00nOiAn8J+HrPCfh6cnLCAnSVJFTEFORCc6ICfwn4eu8J+HqicsICdTV0VERU4nOiAn8J+HuPCfh6onLAogICAgICAgICdOT1JXQVknOiAn8J+Hs/Cfh7QnLCAnREVOTUFSSyc6ICfwn4ep8J+HsCcsICdGSU5MQU5EJzogJ/Cfh6vwn4euJywKICAgICAgICAnVVNBJzogJ/Cfh7rwn4e4JywgJ0NBTkFEQSc6ICfwn4eo8J+HpicsICdNRVhJQ08nOiAn8J+HsvCfh70nLAogICAgICAgICdCUkFaSUwnOiAn8J+Hp/Cfh7cnLCAnQVJHRU5USU5BJzogJ/Cfh6bwn4e3JywgJ0NPTE9NQklBJzogJ/Cfh6jwn4e0JywKICAgICAgICAnUEVSVSc6ICfwn4e18J+HqicsICdDSElMRSc6ICfwn4eo8J+HsScsICdWRU5FWlVFTEEnOiAn8J+Hu/Cfh6onLAogICAgICAgICdTT1VUSCBBRlJJQ0EnOiAn8J+Hv/Cfh6YnLCAnTklHRVJJQSc6ICfwn4ez8J+HrCcsICdFR1lQVCc6ICfwn4eq8J+HrCcsCiAgICAgICAgJ0tFTllBJzogJ/Cfh7Dwn4eqJywgJ0VUSElPUElBJzogJ/Cfh6rwn4e5JywgJ0dIQU5BJzogJ/Cfh6zwn4etJywKICAgICAgICAnQVVTVFJBTElBJzogJ/Cfh6bwn4e6JywgJ05FVyBaRUFMQU5EJzogJ/Cfh7Pwn4e/JywKICAgICAgICAnQUZHSEFOSVNUQU4nOiAn8J+HpvCfh6snLCAnQUxCQU5JQSc6ICfwn4em8J+HsScsICdBTEdFUklBJzogJ/Cfh6nwn4e/JywKICAgICAgICAnQU5ET1JSQSc6ICfwn4em8J+HqScsICdBTkdPTEEnOiAn8J+HpvCfh7QnLCAnQU5USUdVQSBBTkQgQkFSQlVEQSc6ICfwn4em8J+HrCcsCiAgICAgICAgJ0FSTUVOSUEnOiAn8J+HpvCfh7InLCAnQVpFUkJBSUpBTic6ICfwn4em8J+HvycsICdCQUhBTUFTJzogJ/Cfh6fwn4e4JywKICAgICAgICAnQkFIUkFJTic6ICfwn4en8J+HrScsICdCQVJCQURPUyc6ICfwn4en8J+HpycsICdCRUxBUlVTJzogJ/Cfh6fwn4e+JywKICAgICAgICAnQkVMSVpFJzogJ/Cfh6fwn4e/JywgJ0JFTklOJzogJ/Cfh6fwn4evJywgJ0JIVVRBTic6ICfwn4en8J+HuScsCiAgICAgICAgJ0JPTElWSUEnOiAn8J+Hp/Cfh7QnLCAnQk9TTklBIEFORCBIRVJaRUdPVklOQSc6ICfwn4en8J+HpicsICdCT1RTV0FOQSc6ICfwn4en8J+HvCcsCiAgICAgICAgJ0JSVU5FSSc6ICfwn4en8J+HsycsICdCVUxHQVJJQSc6ICfwn4en8J+HrCcsICdCVVJLSU5BIEZBU08nOiAn8J+Hp/Cfh6snLAogICAgICAgICdCVVJVTkRJJzogJ/Cfh6fwn4euJywgJ0NBTUJPRElBJzogJ/Cfh7Dwn4etJywgJ0NBTUVST09OJzogJ/Cfh6jwn4eyJywKICAgICAgICAnQ0FQRSBWRVJERSc6ICfwn4eo8J+HuycsICdDRU5UUkFMIEFGUklDQU4gUkVQVUJMSUMnOiAn8J+HqPCfh6snLCAnQ0hBRCc6ICfwn4e58J+HqScsCiAgICAgICAgJ0NPTU9ST1MnOiAn8J+HsPCfh7InLCAnQ09OR08gKEJSQVpaQVZJTExFKSc6ICfwn4eo8J+HrCcsICdDT05HTyAoS0lOU0hBU0EpJzogJ/Cfh6jwn4epJywKICAgICAgICAnQ09TVEEgUklDQSc6ICfwn4eo8J+HtycsICdDUk9BVElBJzogJ/Cfh63wn4e3JywgJ0NVQkEnOiAn8J+HqPCfh7onLAogICAgICAgICdDWVBSVVMnOiAn8J+HqPCfh74nLCAnQ1pFQ0hJQSc6ICfwn4eo8J+HvycsICdESklCT1VUSSc6ICfwn4ep8J+HrycsCiAgICAgICAgJ0RPTUlOSUNBJzogJ/Cfh6nwn4eyJywgJ0RPTUlOSUNBTiBSRVBVQkxJQyc6ICfwn4ep8J+HtCcsICdFQVNUIFRJTU9SJzogJ/Cfh7nwn4exJywKICAgICAgICAnRUNVQURPUic6ICfwn4eq8J+HqCcsICdFTCBTQUxWQURPUic6ICfwn4e48J+HuycsICdFUVVBVE9SSUFMIEdVSU5FQSc6ICfwn4es8J+HticsCiAgICAgICAgJ0VSSVRSRUEnOiAn8J+HqvCfh7cnLCAnRVNUT05JQSc6ICfwn4eq8J+HqicsICdFU1dBVElOSSc6ICfwn4e48J+HvycsCiAgICAgICAgJ0ZJSkknOiAn8J+Hq/Cfh68nLCAnR0FCT04nOiAn8J+HrPCfh6YnLCAnR0FNQklBJzogJ/Cfh6zwn4eyJywKICAgICAgICAnR0VPUkdJQSc6ICfwn4es8J+HqicsICdHUkVFQ0UnOiAn8J+HrPCfh7cnLCAnR1JFTkFEQSc6ICfwn4es8J+HqScsCiAgICAgICAgJ0dVQVRFTUFMQSc6ICfwn4es8J+HuScsICdHVUlORUEnOiAn8J+HrPCfh7MnLCAnR1VJTkVBLUJJU1NBVSc6ICfwn4es8J+HvCcsCiAgICAgICAgJ0dVWUFOQSc6ICfwn4es8J+HvicsICdIQUlUSSc6ICfwn4et8J+HuScsICdIT05EVVJBUyc6ICfwn4et8J+HsycsCiAgICAgICAgJ0hVTkdBUlknOiAn8J+HrfCfh7onLCAnSUNFTEFORCc6ICfwn4eu8J+HuCcsICdJUkFOJzogJ/Cfh67wn4e3JywKICAgICAgICAnSVJBUSc6ICfwn4eu8J+HticsICdJU1JBRUwnOiAn8J+HrvCfh7EnLCAnSkFNQUlDQSc6ICfwn4ev8J+HsicsCiAgICAgICAgJ0pPUkRBTic6ICfwn4ev8J+HtCcsICdLQVpBS0hTVEFOJzogJ/Cfh7Dwn4e/JywgJ0tJUklCQVRJJzogJ/Cfh7Dwn4euJywKICAgICAgICAnS1VXQUlUJzogJ/Cfh7Dwn4e8JywgJ0tZUkdZWlNUQU4nOiAn8J+HsPCfh6wnLCAnTEFPUyc6ICfwn4ex8J+HpicsCiAgICAgICAgJ0xBVFZJQSc6ICfwn4ex8J+HuycsICdMRUJBTk9OJzogJ/Cfh7Hwn4enJywgJ0xFU09USE8nOiAn8J+HsfCfh7gnLAogICAgICAgICdMSUJFUklBJzogJ/Cfh7Hwn4e3JywgJ0xJQllBJzogJ/Cfh7Hwn4e+JywgJ0xJRUNIVEVOU1RFSU4nOiAn8J+HsfCfh64nLAogICAgICAgICdMSVRIVUFOSUEnOiAn8J+HsfCfh7knLCAnTFVYRU1CT1VSRyc6ICfwn4ex8J+HuicsICdNQURBR0FTQ0FSJzogJ/Cfh7Lwn4esJywKICAgICAgICAnTUFMQVdJJzogJ/Cfh7Lwn4e8JywgJ01BTERJVkVTJzogJ/Cfh7Lwn4e7JywgJ01BTEknOiAn8J+HsvCfh7EnLAogICAgICAgICdNQUxUQSc6ICfwn4ey8J+HuScsICdNQVJTSEFMTCBJU0xBTkRTJzogJ/Cfh7Lwn4etJywgJ01BVVJJVEFOSUEnOiAn8J+HsvCfh7cnLAogICAgICAgICdNQVVSSVRJVVMnOiAn8J+HsvCfh7onLCAnTUlDUk9ORVNJQSc6ICfwn4er8J+HsicsICdNT0xET1ZBJzogJ/Cfh7Lwn4epJywKICAgICAgICAnTU9OQUNPJzogJ/Cfh7Lwn4eoJywgJ01PTkdPTElBJzogJ/Cfh7Lwn4ezJywgJ01PTlRFTkVHUk8nOiAn8J+HsvCfh6onLAogICAgICAgICdNT1JPQ0NPJzogJ/Cfh7Lwn4emJywgJ01ZQU5NQVInOiAn8J+HsvCfh7InLCAnTkFNSUJJQSc6ICfwn4ez8J+HpicsCiAgICAgICAgJ05BVVJVJzogJ/Cfh7Pwn4e3JywgJ05JQ0FSQUdVQSc6ICfwn4ez8J+HricsICdOSUdFUic6ICfwn4ez8J+HqicsCiAgICAgICAgJ05PUlRIIEtPUkVBJzogJ/Cfh7Dwn4e1JywgJ05PUlRIIE1BQ0VET05JQSc6ICfwn4ey8J+HsCcsICdPTUFOJzogJ/Cfh7Twn4eyJywKICAgICAgICAnUEFMQVUnOiAn8J+HtfCfh7wnLCAnUEFOQU1BJzogJ/Cfh7Xwn4emJywgJ1BBUFVBIE5FVyBHVUlORUEnOiAn8J+HtfCfh6wnLAogICAgICAgICdQQVJBR1VBWSc6ICfwn4e18J+HvicsICdRQVRBUic6ICfwn4e28J+HpicsICdST01BTklBJzogJ/Cfh7fwn4e0JywKICAgICAgICAnUldBTkRBJzogJ/Cfh7fwn4e8JywgJ1NBSU5UIEtJVFRTIEFORCBORVZJUyc6ICfwn4ew8J+HsycsICdTQUlOVCBMVUNJQSc6ICfwn4ex8J+HqCcsCiAgICAgICAgJ1NBSU5UIFZJTkNFTlQgQU5EIFRIRSBHUkVOQURJTkVTJzogJ/Cfh7vwn4eoJywgJ1NBTU9BJzogJ/Cfh7zwn4e4JywgJ1NBTiBNQVJJTk8nOiAn8J+HuPCfh7InLAogICAgICAgICdTQU8gVE9NRSBBTkQgUFJJTkNJUEUnOiAn8J+HuPCfh7knLCAnU0FVREkgQVJBQklBJzogJ/Cfh7jwn4emJywgJ1NFTkVHQUwnOiAn8J+HuPCfh7MnLAogICAgICAgICdTRVJCSUEnOiAn8J+Ht/Cfh7gnLCAnU0VZQ0hFTExFUyc6ICfwn4e48J+HqCcsICdTSUVSUkEgTEVPTkUnOiAn8J+HuPCfh7EnLAogICAgICAgICdTTE9WQUtJQSc6ICfwn4e48J+HsCcsICdTTE9WRU5JQSc6ICfwn4e48J+HricsICdTT0xPTU9OIElTTEFORFMnOiAn8J+HuPCfh6cnLAogICAgICAgICdTT01BTElBJzogJ/Cfh7jwn4e0JywgJ1NPVVRIIFNVREFOJzogJ/Cfh7jwn4e4JywgJ1NVREFOJzogJ/Cfh7jwn4epJywKICAgICAgICAnU1VSSU5BTUUnOiAn8J+HuPCfh7cnLCAnU1lSSUEnOiAn8J+HuPCfh74nLCAnVEFKSUtJU1RBTic6ICfwn4e58J+HrycsCiAgICAgICAgJ1RBTlpBTklBJzogJ/Cfh7nwn4e/JywgJ1RPR08nOiAn8J+HufCfh6wnLCAnVE9OR0EnOiAn8J+HufCfh7QnLAogICAgICAgICdUUklOSURBRCBBTkQgVE9CQUdPJzogJ/Cfh7nwn4e5JywgJ1RVTklTSUEnOiAn8J+HufCfh7MnLCAnVFVSS0VZJzogJ/Cfh7nwn4e3JywKICAgICAgICAnVFVSS01FTklTVEFOJzogJ/Cfh7nwn4eyJywgJ1RVVkFMVSc6ICfwn4e58J+HuycsICdVR0FOREEnOiAn8J+HuvCfh6wnLAogICAgICAgICdVTklURUQgQVJBQiBFTUlSQVRFUyc6ICfwn4em8J+HqicsICdVUlVHVUFZJzogJ/Cfh7rwn4e+JywgJ1VaQkVLSVNUQU4nOiAn8J+HuvCfh78nLAogICAgICAgICdWQU5VQVRVJzogJ/Cfh7vwn4e6JywgJ1ZBVElDQU4gQ0lUWSc6ICfwn4e78J+HpicsICdZRU1FTic6ICfwn4e+8J+HqicsCiAgICAgICAgJ1pBTUJJQSc6ICfwn4e/8J+HsicsICdaSU1CQUJXRSc6ICfwn4e/8J+HvCcKICAgIH07CiAgICBjb25zdCBjbGVhbkNvdW50cnkgPSBjb3VudHJ5TmFtZS5yZXBsYWNlKC9ccytcZCskLywgJycpLnRvVXBwZXJDYXNlKCk7CiAgICByZXR1cm4gZmxhZ01hcFtjbGVhbkNvdW50cnldIHx8ICfwn4+0JzsKfTsKCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09IFNFVFRJTkdTIEhFTFBFUiA9PT09PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpjb25zdCByZWxvYWRTZXR0aW5ncyA9ICgpID0+IHsKICAgIHRyeSB7CiAgICAgICAgLy8gQ2xlYXIgY2FjaGUKICAgICAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVtyZXF1aXJlLnJlc29sdmUoJy4vc2V0dGluZ3MuanMnKV07CiAgICAgICAgCiAgICAgICAgLy8gTG9hZCBmcmVzaCBzZXR0aW5ncwogICAgICAgIGNvbnN0IGZyZXNoU2V0dGluZ3MgPSByZXF1aXJlKCcuL3NldHRpbmdzLmpzJyk7CiAgICAgICAgCiAgICAgICAgLy8gVXBkYXRlIGdsb2JhbCBzZXR0aW5ncyBvYmplY3QKICAgICAgICBPYmplY3Qua2V5cyhmcmVzaFNldHRpbmdzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgICAgICAgIHNldHRpbmdzW2tleV0gPSBmcmVzaFNldHRpbmdzW2tleV07CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJ1tTRVRUSU5HU10g4pyFIFNldHRpbmdzIHJlbG9hZGVkIHN1Y2Nlc3NmdWxseScpKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoJ1tTRVRUSU5HU10g4p2MIEZhaWxlZCB0byByZWxvYWQgc2V0dGluZ3M6JyksIGVycm9yKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn07Cgpjb25zdCB3cml0ZVNldHRpbmdUb0ZpbGVTeW5jID0gKGtleSwgdmFsdWUpID0+IHsKICAgIHRyeSB7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NGaWxlUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICdzZXR0aW5ncy5qcycpOwogICAgICAgIAogICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhzZXR0aW5nc0ZpbGVQYXRoKSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZChgW1NFVFRJTkdTXSDinYwgRmlsZSBzZXR0aW5ncy5qcyB0aWRhayBkaXRlbXVrYW4hYCkpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxldCBmaWxlQ29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhzZXR0aW5nc0ZpbGVQYXRoLCAndXRmOCcpOwogICAgICAgIGNvbnN0IGNsZWFuVmFsdWUgPSB2YWx1ZSA/IHZhbHVlLnRyaW0oKSA6ICIiOwogICAgICAgIAogICAgICAgIC8vIEVzY2FwZSBrYXJha3RlciBraHVzdXMgdW50dWsgc3RyaW5nIEphdmFTY3JpcHQKICAgICAgICBjb25zdCBlc2NhcGVkVmFsdWUgPSBjbGVhblZhbHVlLnJlcGxhY2UoL1xcL2csICdcXFxcJykucmVwbGFjZSgvJy9nLCAiXFwnIik7CiAgICAgICAgCiAgICAgICAgLy8gUGF0dGVybiBsZWJpaCBzcGVzaWZpayB1bnR1ayBtZW5jYXJpIGtleSBkaSBkYWxhbSBtb2R1bGUuZXhwb3J0cwogICAgICAgIGNvbnN0IGV4cG9ydFBhdHRlcm4gPSAvbW9kdWxlXC5leHBvcnRzXHMqPVxzKnsoW1xzXFNdKj8pfS87CiAgICAgICAgY29uc3QgbWF0Y2ggPSBmaWxlQ29udGVudC5tYXRjaChleHBvcnRQYXR0ZXJuKTsKICAgICAgICAKICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY2hhbGsucmVkKGBbU0VUVElOR1NdIOKdjCBGb3JtYXQgbW9kdWxlLmV4cG9ydHMgdGlkYWsgZGl0ZW11a2FuIWApKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjb25zdCBpbm5lckNvbnRlbnQgPSBtYXRjaFsxXTsKICAgICAgICBjb25zdCBrZXlQYXR0ZXJuID0gbmV3IFJlZ0V4cChgKCR7a2V5fVxccypbPTpdXFxzKlsnIl0pKFteJyJdKikoWyciXSlgLCAnaScpOwogICAgICAgIGNvbnN0IGtleU1hdGNoID0gaW5uZXJDb250ZW50Lm1hdGNoKGtleVBhdHRlcm4pOwogICAgICAgIAogICAgICAgIGxldCBuZXdJbm5lckNvbnRlbnQ7CiAgICAgICAgCiAgICAgICAgaWYgKGtleU1hdGNoKSB7CiAgICAgICAgICAgIC8vIEtleSBzdWRhaCBhZGEsIHJlcGxhY2UgdmFsdWUtbnlhCiAgICAgICAgICAgIG5ld0lubmVyQ29udGVudCA9IGlubmVyQ29udGVudC5yZXBsYWNlKGtleVBhdHRlcm4sIGAkMSR7ZXNjYXBlZFZhbHVlfSQzYCk7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIEtleSBiZWx1bSBhZGEsIHRhbWJhaGthbiBrZSBha2hpciBvYmplY3Qgc2ViZWx1bSBwZW51dHVwIH0KICAgICAgICAgICAgbGV0IHRyaW1tZWRJbm5lciA9IGlubmVyQ29udGVudC50cmltKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUYW1iYWhrYW4ga29tYSBqaWthIGlubmVyIGNvbnRlbnQgdGlkYWsga29zb25nIGRhbiB0aWRhayBiZXJha2hpciBkZW5nYW4ga29tYQogICAgICAgICAgICBpZiAodHJpbW1lZElubmVyLmxlbmd0aCA+IDAgJiYgIXRyaW1tZWRJbm5lci5lbmRzV2l0aCgnLCcpICYmICF0cmltbWVkSW5uZXIuZW5kc1dpdGgoJ3snKSkgewogICAgICAgICAgICAgICAgdHJpbW1lZElubmVyICs9ICcsJzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGFtYmFoa2FuIGtleSBiYXJ1CiAgICAgICAgICAgIG5ld0lubmVyQ29udGVudCA9IHRyaW1tZWRJbm5lciArIGBcbiAgICAke2tleX06ICcke2VzY2FwZWRWYWx1ZX0nLGA7CiAgICAgICAgICAgIAogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBSZWNvbnN0cnVjdCB0aGUgZW50aXJlIGZpbGUgY29udGVudAogICAgICAgIGNvbnN0IG5ld0NvbnRlbnQgPSBmaWxlQ29udGVudC5yZXBsYWNlKGV4cG9ydFBhdHRlcm4sIGBtb2R1bGUuZXhwb3J0cyA9IHske25ld0lubmVyQ29udGVudH1cbn1gKTsKICAgICAgICAKICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHNldHRpbmdzRmlsZVBhdGgsIG5ld0NvbnRlbnQsICd1dGY4Jyk7CiAgICAgICAgCiAgICAgICAgLy8gVXBkYXRlIGNhY2hlIHNldHRpbmdzCiAgICAgICAgaWYgKHNldHRpbmdzW2tleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBzZXR0aW5nc1trZXldID0gY2xlYW5WYWx1ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZChgW1NFVFRJTkdTXSDinYwgR2FnYWwgdXBkYXRlICR7a2V5fTpgKSwgZXJyLm1lc3NhZ2UpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfTsKCmNvbnN0IHVwZGF0ZVNldHRpbmdTaWxlbnQgPSAoa2V5LCB2YWx1ZSkgPT4gewogICAgY29uc3QgY2xlYW5WYWx1ZSA9IHZhbHVlID8gdmFsdWUudHJpbSgpIDogIiI7CiAgICAKICAgIC8vIENsZWFyIGNhY2hlIHNlYmVsdW0gbWVtYmFjYSB1bGFuZwogICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVxdWlyZS5yZXNvbHZlKCcuL3NldHRpbmdzLmpzJyldOwogICAgCiAgICBjb25zdCBzdWNjZXNzID0gd3JpdGVTZXR0aW5nVG9GaWxlU3luYyhrZXksIGNsZWFuVmFsdWUpOwogICAgCiAgICBpZiAoc3VjY2VzcykgewogICAgICAgIC8vIEZvcmNlIHJlbG9hZCBzZXR0aW5ncwogICAgICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW3JlcXVpcmUucmVzb2x2ZSgnLi9zZXR0aW5ncy5qcycpXTsKICAgICAgICBjb25zdCBuZXdTZXR0aW5ncyA9IHJlcXVpcmUoJy4vc2V0dGluZ3MuanMnKTsKICAgICAgICAKICAgICAgICAvLyBVcGRhdGUgZ2xvYmFsIHNldHRpbmdzIG9iamVjdAogICAgICAgIE9iamVjdC5rZXlzKG5ld1NldHRpbmdzKS5mb3JFYWNoKGsgPT4gewogICAgICAgICAgICBzZXR0aW5nc1trXSA9IG5ld1NldHRpbmdzW2tdOwogICAgICAgIH0pOwogICAgfQogICAgCiAgICByZXR1cm4gc3VjY2VzczsKfTsKCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09IFNUQVRFIE1BTkFHRU1FTlQgPT09PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpsZXQgdXNlclN0YXRlID0gbmV3IE1hcCgpOyAvLyBHdW5ha2FuIE1hcCB1bnR1ayBsZWJpaCBlZmlzaWVuCgpjb25zdCByZXNldFVzZXJTdGF0ZSA9ICh1c2VySWQpID0+IHsKICAgIHVzZXJTdGF0ZS5kZWxldGUodXNlcklkKTsKfTsKCmNvbnN0IHNldFVzZXJTdGF0ZSA9ICh1c2VySWQsIHR5cGUsIGRhdGEgPSB7fSkgPT4gewogICAgY29uc3Qgc3RhdGUgPSB7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgIHN0ZXA6ICdhd2FpdGluZ19pbnB1dCcsCiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpCiAgICB9OwogICAgdXNlclN0YXRlLnNldCh1c2VySWQsIHN0YXRlKTsKICAgIHJldHVybiBzdGF0ZTsKfTsKCmNvbnN0IGdldFVzZXJTdGF0ZSA9ICh1c2VySWQpID0+IHsKICAgIHJldHVybiB1c2VyU3RhdGUuZ2V0KHVzZXJJZCk7Cn07CgovLyBDbGVhbnVwIG9sZCBzdGF0ZXMgc2V0aWFwIDMwIG1lbml0CnNldEludGVydmFsKCgpID0+IHsKICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICBjb25zdCBUSElSVFlfTUlOVVRFUyA9IDMwICogNjAgKiAxMDAwOwogICAgCiAgICBmb3IgKGNvbnN0IFt1c2VySWQsIHN0YXRlXSBvZiB1c2VyU3RhdGUuZW50cmllcygpKSB7CiAgICAgICAgaWYgKG5vdyAtIHN0YXRlLnRpbWVzdGFtcCA+IFRISVJUWV9NSU5VVEVTKSB7CiAgICAgICAgICAgIHVzZXJTdGF0ZS5kZWxldGUodXNlcklkKTsKICAgICAgICB9CiAgICB9Cn0sIDE4MDAwMDApOwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBCT1QgSU5JVElBTElaRSA9PT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgaW5pdGlhbGl6ZUJvdCA9IGFzeW5jICgpID0+IHsKICAgIGZzLm1rZGlyU3luYyhURU1QX0RJUiwgeyByZWN1cnNpdmU6IHRydWUgfSk7CiAgICBmcy5ta2RpclN5bmMoU1NfRElSLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTsKICAgIAogICAgdHJ5IHsKICAgICAgICAvLyBEZXRla3NpIGRpc3BsYXkgVk5DCiAgICAgICAgbGV0IGhlYWRsZXNzTW9kZSA9ICduZXcnOwogICAgICAgIGxldCBkaXNwbGF5QXJncyA9IFtdOwogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHsgZXhlY1N5bmMgfSA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTsKICAgICAgICAgICAgZXhlY1N5bmMoJ3hkcHlpbmZvIC1kaXNwbGF5IDoxID4gL2Rldi9udWxsIDI+JjEnKTsKICAgICAgICAgICAgaGVhZGxlc3NNb2RlID0gZmFsc2U7CiAgICAgICAgICAgIGRpc3BsYXlBcmdzID0gWyctLWRpc3BsYXk9OjEnXTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGhlYWRsZXNzTW9kZSA9ICduZXcnOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIFBFUkJBSUtBTiBQQVRIIENIUk9NSVVNIC0tLQogICAgICAgIGxldCBjaHJvbWVQYXRoID0gJy91c3IvYmluL2Nocm9taXVtJzsKICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoY2hyb21lUGF0aCkpIHsKICAgICAgICAgICAgY2hyb21lUGF0aCA9ICcvdXNyL2Jpbi9jaHJvbWl1bS1icm93c2VyJzsgLy8gQ29iYSBuYW1hIGFsdGVybmF0aWYKICAgICAgICB9CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIAogICAgICAgIC8vIExhdW5jaCBicm93c2VyIGRlbmdhbiBhcmdzCiAgICAgICAgY29uc3QgYnJvd3NlckFyZ3MgPSBbCiAgICAgICAgICAgIC4uLmRpc3BsYXlBcmdzLAogICAgICAgICAgICAnLS1uby1zYW5kYm94JywKICAgICAgICAgICAgJy0tZGlzYWJsZS1zZXR1aWQtc2FuZGJveCcsCiAgICAgICAgICAgICctLWRpc2FibGUtZGV2LXNobS11c2FnZScsCiAgICAgICAgICAgICctLW5vLXp5Z290ZScsCiAgICAgICAgICAgICctLXdpbmRvdy1zaXplPTE5MjAsMTA4MCcsCiAgICAgICAgICAgICctLXN0YXJ0LW1heGltaXplZCcsCiAgICAgICAgICAgICctLWluY29nbml0bycsCiAgICAgICAgICAgICctLWRpc2FibGUtYmxpbmstZmVhdHVyZXM9QXV0b21hdGlvbkNvbnRyb2xsZWQnLAogICAgICAgICAgICAnLS1sYW5nPWVuLVVTLGVuJywKICAgICAgICAgICAgJy0tbm8tZGVmYXVsdC1icm93c2VyLWNoZWNrJywKICAgICAgICAgICAgJy0tbm8tZmlyc3QtcnVuJywKICAgICAgICAgICAgJy0tdGltZXpvbmUtaWQ9QXNpYS9KYWthcnRhJywKICAgICAgICAgICAgJy0tZGlzYWJsZS1mZWF0dXJlcz1Jc29sYXRlT3JpZ2lucyxzaXRlLXBlci1wcm9jZXNzJwogICAgICAgIF07CiAgICAgICAgCiAgICAgICAgYnJvd3NlciA9IGF3YWl0IHB1cHBldGVlckV4dHJhLmxhdW5jaCh7CiAgICAgICAgICAgIGV4ZWN1dGFibGVQYXRoOiBjaHJvbWVQYXRoLCAvLyBNZW5nZ3VuYWthbiB2YXJpYWJlbCBjaHJvbWVQYXRoCiAgICAgICAgICAgIGhlYWRsZXNzOiBoZWFkbGVzc01vZGUsCiAgICAgICAgICAgIGFyZ3M6IGJyb3dzZXJBcmdzLAogICAgICAgICAgICBpZ25vcmVEZWZhdWx0QXJnczogWyctLWVuYWJsZS1hdXRvbWF0aW9uJ10sCiAgICAgICAgICAgIGRlZmF1bHRWaWV3cG9ydDogbnVsbAogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGlzQnJvd3NlclJlYWR5ID0gdHJ1ZTsKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbihgW1NUQVRVU10g4pyU77iPIEJST1dTRVIgQUNUSVZFRGApKTsKICAgICAgICAKICAgICAgICAvLyBDZWsgYXBha2FoIHN1ZGFoIGFkYSBjcmVkZW50aWFscwogICAgICAgIGlmICghc2V0dGluZ3MuSVZBU19VU0VSTkFNRSB8fCAhc2V0dGluZ3MuSVZBU19QQVNTV09SRCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay55ZWxsb3coIltTVEFUVVNdIOKaoO+4jyBMb2dpbiBjcmVkZW50aWFscyBub3QgZm91bmQiKSk7CiAgICAgICAgICAgIGNvbnN0IHJlYWRsaW5lID0gcmwuY3JlYXRlSW50ZXJmYWNlKHsgaW5wdXQ6IHByb2Nlc3Muc3RkaW4sIG91dHB1dDogcHJvY2Vzcy5zdGRvdXQgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgdXNlcm5hbWUgPSAnJzsKICAgICAgICAgICAgd2hpbGUgKCF1c2VybmFtZSkgewogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBhd2FpdCAoYXdhaXQgcmVhZGxpbmUucXVlc3Rpb24oY2hhbGsuY3lhbigiTWFzdWtrYW4gVXNlcm5hbWUvRW1haWwgSVZBU01TOiAiKSkpLnRyaW0oKTsKICAgICAgICAgICAgICAgIGlmICghdXNlcm5hbWUpIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgi4p2MIFVzZXJuYW1lIHRpZGFrIGJvbGVoIGtvc29uZyIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IHBhc3N3b3JkID0gJyc7CiAgICAgICAgICAgIHdoaWxlICghcGFzc3dvcmQpIHsKICAgICAgICAgICAgICAgIHBhc3N3b3JkID0gYXdhaXQgKGF3YWl0IHJlYWRsaW5lLnF1ZXN0aW9uKGNoYWxrLmN5YW4oIk1hc3Vra2FuIFBhc3N3b3JkIElWQVNNUzogIiksIHsgaGlkZUVjaG9CYWNrOiB0cnVlIH0pKS50cmltKCk7CiAgICAgICAgICAgICAgICBpZiAoIXBhc3N3b3JkKSBjb25zb2xlLmxvZyhjaGFsay5yZWQoIuKdjCBQYXNzd29yZCB0aWRhayBib2xlaCBrb3NvbmciKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJlYWRsaW5lLmNsb3NlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB3cml0ZVNldHRpbmdUb0ZpbGVTeW5jKCdJVkFTX1VTRVJOQU1FJywgdXNlcm5hbWUpOwogICAgICAgICAgICB3cml0ZVNldHRpbmdUb0ZpbGVTeW5jKCdJVkFTX1BBU1NXT1JEJywgcGFzc3dvcmQpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oIltTVEFUVVNdIOKchSBDcmVkZW50aWFscyBzYXZlZCIpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gQ2VrIFVzZXIgQWdlbnQgKFNlc3VhaSBwZXJtaW50YWFuOiBKaWthIGtvc29uZyBhdGF1IGt1cmFuZyBkYXJpIDIwIGthcmFrdGVyKQogICAgICAgIGlmICghc2V0dGluZ3MuQ1VSUkVOVF9VU0VSX0FHRU5UIHx8IHNldHRpbmdzLkNVUlJFTlRfVVNFUl9BR0VOVCA9PT0gJycgfHwgc2V0dGluZ3MuQ1VSUkVOVF9VU0VSX0FHRU5ULmxlbmd0aCA8IDIwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnllbGxvdygiW1NUQVRVU10g4pqg77iPIFVzZXIgQWdlbnQgbm90IGZvdW5kIG9yIGVtcHR5IGluIHNldHRpbmdzLmpzIikpOwogICAgICAgICAgICBjb25zdCByZWFkbGluZSA9IHJsLmNyZWF0ZUludGVyZmFjZSh7IGlucHV0OiBwcm9jZXNzLnN0ZGluLCBvdXRwdXQ6IHByb2Nlc3Muc3Rkb3V0IH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIGxldCB1c2VyQWdlbnQgPSAiIjsKICAgICAgICAgICAgd2hpbGUgKCF2YWxpZCkgewogICAgICAgICAgICAgICAgdXNlckFnZW50ID0gYXdhaXQgKGF3YWl0IHJlYWRsaW5lLnF1ZXN0aW9uKGNoYWxrLmN5YW4oIk1hc3Vra2FuIFVzZXIgQWdlbnQgKEZ1bGwpOiAiKSkpLnRyaW0oKTsKICAgICAgICAgICAgICAgIGlmICh1c2VyQWdlbnQubGVuZ3RoID49IDIwKSB2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICBlbHNlIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgi4p2MIFVzZXIgQWdlbnQgdGVybGFsdSBwZW5kZWsiKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJlYWRsaW5lLmNsb3NlKCk7CiAgICAgICAgICAgIHdyaXRlU2V0dGluZ1RvRmlsZVN5bmMoJ0NVUlJFTlRfVVNFUl9BR0VOVCcsIHVzZXJBZ2VudCk7CiAgICAgICAgICAgIHNldHRpbmdzLkNVUlJFTlRfVVNFUl9BR0VOVCA9IHVzZXJBZ2VudDsgLy8gVXBkYXRlIG1lbW9yaQogICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbigiW1NUQVRVU10g4pyFIFVzZXIgQWdlbnQgc2F2ZWQiKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGF3YWl0IGJvdC5sYXVuY2goewogICAgICAgICAgICBkcm9wUGVuZGluZ1VwZGF0ZXM6IHRydWUsCiAgICAgICAgICAgIHBvbGxpbmc6IHsKICAgICAgICAgICAgICAgIHRpbWVvdXQ6IDYwCiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gUGFuZ2dpbCBsYW5nc3VuZyBjb25uZWN0Um9idXN0TGl2ZVNtcyBzZXRlbGFoIGJyb3dzZXIgc2lhcAogICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmN5YW4oIltTVEFUVVNdIPCflI0gQXV0by1jb25uZWN0aW5nIHRvIExpdmUgU01TLi4uIikpOwogICAgICAgIAogICAgICAgIC8vIEF1dG8tY29ubmVjdCBsYW5nc3VuZyB0YW5wYSB0aW1lb3V0CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgY29ubmVjdGVkID0gYXdhaXQgY29ubmVjdFJvYnVzdExpdmVTbXMoKTsKICAgICAgICAgICAgaWYgKGNvbm5lY3RlZCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oIltTVEFUVVNdIOKchSBBdXRvLWNvbm5lY3Qgc3VjY2Vzc2Z1bCEiKSk7CiAgICAgICAgICAgICAgICBpc1BvbGxpbmdBY3RpdmUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsueWVsbG93KCJbU1RBVFVTXSDimqDvuI8gQXV0by1jb25uZWN0IGZhaWxlZC4gVXNlIC9sb2dpbiB0byBjb25uZWN0IG1hbnVhbGx5LiIpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgiW1NUQVRVU10g4p2MIEF1dG8tY29ubmVjdCBlcnJvcjoiKSwgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIAogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlzQnJvd3NlclJlYWR5ID0gZmFsc2U7CiAgICAgICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoIuKdjCBJbml0aWFsaXphdGlvbiBmYWlsZWQ6IiksIGUubWVzc2FnZSk7CiAgICAgICAgcHJvY2Vzcy5leGl0KDEpOwogICAgfQoKICAgIGNvbnNvbGUubG9nKGNoYWxrLmJsdWUoYFtTVEFUVVNdIPCfmoAgJHtQUk9KRUNUX05BTUV9IFN0YXJ0ZWQuLi5gKSk7ICAKfTsKCgoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gUE9QVVAgSEFORExFUiA9PT09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmNvbnN0IGhhbmRsZVBvcHVwQW5kVHV0b3JpYWwgPSBhc3luYyAocGFnZSkgPT4gewogICAgdHJ5IHsKICAgICAgCiAgICAgICAgCiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDMwMDApKTsKICAgICAgICAKICAgICAgICBhd2FpdCBwYWdlLmV2YWx1YXRlKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2xvc2VNb2RhbCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IG1vZGFscyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5tb2RhbCcpOwogICAgICAgICAgICAgICAgbW9kYWxzLmZvckVhY2gobW9kYWwgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlQnRuID0gbW9kYWwucXVlcnlTZWxlY3RvcignW2RhdGEtZGlzbWlzcz0ibW9kYWwiXSwgLmNsb3NlLCBbYXJpYS1sYWJlbD0iQ2xvc2UiXScpOwogICAgICAgICAgICAgICAgICAgIGlmIChjbG9zZUJ0bikgewogICAgICAgICAgICAgICAgICAgICAgICBjbG9zZUJ0bi5jbGljaygpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kYWwuc3R5bGUuZGlzcGxheSA9PT0gJ2Jsb2NrJyB8fCBtb2RhbC5jbGFzc0xpc3QuY29udGFpbnMoJ3Nob3cnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBtb2RhbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICBtb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJhY2tkcm9wcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5tb2RhbC1iYWNrZHJvcCcpOwogICAgICAgICAgICAgICAgYmFja2Ryb3BzLmZvckVhY2goYmFja2Ryb3AgPT4gewogICAgICAgICAgICAgICAgICAgIGJhY2tkcm9wLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBjbG9zZU1vZGFsKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAod2luZG93LmRyaXZlciAmJiB3aW5kb3cuZHJpdmVyT2JqKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5kcml2ZXJPYmoucmVzZXQoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRyaXZlckVsZW1lbnRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmRyaXZlci1wb3BvdmVyLCAuZHJpdmVyLW92ZXJsYXknKTsKICAgICAgICAgICAgZHJpdmVyRWxlbWVudHMuZm9yRWFjaChlbCA9PiB7CiAgICAgICAgICAgICAgICBlbC5yZW1vdmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAod2luZG93LlN3YWwgJiYgU3dhbC5nZXRQb3B1cCgpKSB7CiAgICAgICAgICAgICAgICBTd2FsLmNsb3NlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xpY2soKTsKICAgICAgICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgS2V5Ym9hcmRFdmVudCgna2V5ZG93bicsIHsga2V5OiAnRXNjYXBlJyB9KSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnc21zLXRvdG9yaWFsLWNvbXBsZXRlZCcsICd0cnVlJyk7CiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdzbXMtdG90b3JpYWwtc3RhdHVzJywgJ2Nsb3NlZCcpOwogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDAwKSk7CiAgICAgICAgCiAgICAgICAgYXdhaXQgcGFnZS5ldmFsdWF0ZSgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNsb3NlQnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtZGlzbWlzcz0ibW9kYWwiXScpOwogICAgICAgICAgICBpZiAoY2xvc2VCdG4pIHsKICAgICAgICAgICAgICAgIGNsb3NlQnRuLmNsaWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpOwogICAgICAgIAogICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIAogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgaGFuZGxpbmcgcG9wdXA6JywgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9OwoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gVkFSSUFCTEVTID09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmxldCBzZW50TWVzc2FnZUhhc2hlcyA9IG5ldyBTZXQoKTsKbGV0IGlzRmlyc3RQb2xsID0gdHJ1ZTsKbGV0IGhhc1NjcmVlbnNob3RCZWVuU2VudCA9IGZhbHNlOwpsZXQgaXNDb25uZWN0aW5nID0gZmFsc2U7CmxldCBjb25uZWN0aW9uQXR0ZW1wdHMgPSAwOwpjb25zdCBNQVhfQ09OTkVDVElPTl9BVFRFTVBUUyA9IDM7CmxldCBsYXN0Q29ubmVjdGlvbkVycm9yID0gbnVsbDsKbGV0IGNvbm5lY3Rpb25FcnJvckxvZ1RpbWUgPSAwOwpjb25zdCBDT05ORUNUSU9OX0VSUk9SX0NPT0xET1dOID0gMTIwMDAwOwpsZXQgd2ViU29ja2V0TW9uaXRvckFjdGl2ZSA9IGZhbHNlOwpsZXQgc3RhYmxlQ29ubmVjdGlvblN0YXJ0VGltZSA9IDA7CmxldCBsYXN0U3VjY2Vzc2Z1bENoZWNrID0gMDsKbGV0IGlzQ29ubmVjdGlvblN0YWJsZSA9IGZhbHNlOwpsZXQgcGFnZVZhbGlkYXRpb25JbnRlcnZhbCA9IG51bGw7CgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBIRUxQRVJTID09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgbWFza1Bob25lTnVtYmVyID0gKG51bSkgPT4gewogICAgaWYgKCFudW0pIHJldHVybiAnTi9BJzsKICAgIAogICAgLy8gUEVSQkFJS0FOIExPR0lLQSBNQVNLSU5HOiBTZXN1YWkgaW5zdHJ1a3NpIGx1CiAgICAvLyBKaWthIHBhbmphbmcgbm9tb3Iga3VyYW5nIGRhcmkgOCAtPiAzIGRlcGFuLCBzaXNhbnlhIGJpbnRhbmcsIDQgYmVsYWthbmcKICAgIGlmIChudW0ubGVuZ3RoIDwgOCkgewogICAgICAgIHJldHVybiBudW0uc2xpY2UoMCwgMykgKyAnKicucmVwZWF0KE1hdGgubWF4KDAsIG51bS5sZW5ndGggLSA3KSkgKyBudW0uc2xpY2UoLTQpOwogICAgfSAKICAgIAogICAgLy8gSmlrYSBwYW5qYW5nIG5vbW9yIDggYXRhdSBsZWJpaCAtPiA0IGRlcGFuLCBzaXNhbnlhIGJpbnRhbmcsIDQgYmVsYWthbmcKICAgIHJldHVybiBudW0uc2xpY2UoMCwgNCkgKyAnKicucmVwZWF0KE1hdGgubWF4KDAsIG51bS5sZW5ndGggLSA4KSkgKyBudW0uc2xpY2UoLTQpOwp9OwoKY29uc3QgZXNjYXBlSHRtbCA9ICh0ZXh0KSA9PiB0ZXh0ID8gdGV4dC5yZXBsYWNlKC9bJjw+IiddL2csbT0+KHsiJiI6IiZhbXA7IiwiPCI6IiZsdDsiLCI+IjoiJmd0OyIsJyInOiImcXVvdDsiLCInIjoiJiMwMzk7In1bbV0pKSA6ICcnOwoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gQ09OTkVDVElPTiA9PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmNvbnN0IG1hcmtDb25uZWN0aW9uU3RhYmxlID0gKCkgPT4geyAKICAgIGlzQ29ubmVjdGlvblN0YWJsZT10cnVlOyAKICAgIHN0YWJsZUNvbm5lY3Rpb25TdGFydFRpbWU9RGF0ZS5ub3coKTsgCiAgICBjb25uZWN0aW9uQXR0ZW1wdHM9MDsgCiAgICBkaXNjb25uZWN0QWxlcnRTZW50PWZhbHNlOyAKfTsKCmNvbnN0IG1hcmtDb25uZWN0aW9uVW5zdGFibGUgPSAoKSA9PiB7IAogICAgaXNDb25uZWN0aW9uU3RhYmxlPWZhbHNlOyAKICAgIGNvbnNvbGUubG9nKGNoYWxrLnllbGxvdygnW1NUQUJJTElUWV0g4pqg77iPIENvbm5lY3Rpb24gVU5TVEFCTEUnKSk7IAp9OwoKY29uc3Qgc2hvdWxkQXR0ZW1wdFJlY29ubmVjdCA9ICgpID0+IHsKICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAKICAgIC8vIEppa2Egc3VkYWggc3RhYmxlLCBqYW5nYW4gcmVjb25uZWN0IGtlY3VhbGkgYmVuYXItYmVuYXIgZGlzY29ubmVjdAogICAgaWYgKGlzQ29ubmVjdGlvblN0YWJsZSAmJiAobm93IC0gbGFzdFN1Y2Nlc3NmdWxDaGVjayA8IDMwMDAwKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIAogICAgLy8gQ29vbGRvd24gc2V0ZWxhaCBlcnJvcgogICAgaWYgKChub3cgLSBjb25uZWN0aW9uRXJyb3JMb2dUaW1lKSA8IDEyMDAwMCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIAogICAgLy8gQmF0YXNpIGp1bWxhaCBhdHRlbXB0cwogICAgaWYgKGNvbm5lY3Rpb25BdHRlbXB0cyA+PSBNQVhfQ09OTkVDVElPTl9BVFRFTVBUUykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIAogICAgLy8gSGFueWEgcmVjb25uZWN0IGppa2EgcG9sbGluZyBha3RpZgogICAgcmV0dXJuIGlzUG9sbGluZ0FjdGl2ZTsKfTsKCmNvbnN0IG1haW50YWluQ29ubmVjdGlvbiA9IGFzeW5jICgpID0+IHsKICAgIGlmIChpc0Nvbm5lY3RpbmcgfHwgIWlzUG9sbGluZ0FjdGl2ZSkgcmV0dXJuOwogICAgCiAgICAvLyBKaWthIGNvbm5lY3Rpb24gc3RhYmxlLCBjdWt1cCB2YWxpZGFzaSBzZXNla2FsaQogICAgaWYgKGlzQ29ubmVjdGlvblN0YWJsZSAmJiBsaXZlU21zUGFnZSkgewogICAgICAgIC8vIFZhbGlkYXNpIHNldGlhcCAyIG1lbml0IHNhamEKICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIGxhc3RTdWNjZXNzZnVsQ2hlY2sgPiAxMjAwMDApIHsKICAgICAgICAgICAgYXdhaXQgdmFsaWRhdGVQYWdlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgLy8gSmlrYSB1bnN0YWJsZSBhdGF1IHRpZGFrIGFkYSBjb25uZWN0aW9uLCBjb2JhIHJlY29ubmVjdAogICAgaWYgKHNob3VsZEF0dGVtcHRSZWNvbm5lY3QoKSkgewogICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnllbGxvdygnW01BSU5URU5BTkNFXSDwn5SEIEF0dGVtcHRpbmcgcmVjb25uZWN0aW9uLi4uJykpOwogICAgICAgIGF3YWl0IGNvbm5lY3RSb2J1c3RMaXZlU21zKCk7CiAgICB9Cn07CgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBQQUdFIFZBTElEQVRJT04gPT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgdmFsaWRhdGVQYWdlID0gYXN5bmMgKCkgPT4gewogICAgaWYgKCFsaXZlU21zUGFnZSkgeyAKICAgICAgICBtYXJrQ29ubmVjdGlvblVuc3RhYmxlKCk7IAogICAgICAgIHJldHVybiBmYWxzZTsgCiAgICB9CiAgICB0cnkgewogICAgICAgIGNvbnN0IHBhZ2VTdGF0ZSA9IGF3YWl0IGxpdmVTbXNQYWdlLmV2YWx1YXRlKCgpID0+ICh7CiAgICAgICAgICAgIHVybDogd2luZG93LmxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGhhc1dlYlNvY2tldDogdHlwZW9mIFdlYlNvY2tldCE9PSd1bmRlZmluZWQnCiAgICAgICAgfSkpLmNhdGNoKCgpPT5udWxsKTsKICAgICAgICBpZiAoIXBhZ2VTdGF0ZXx8IXBhZ2VTdGF0ZS51cmwuaW5jbHVkZXMoTElWRV9TTVNfVVJMKXx8IXBhZ2VTdGF0ZS5oYXNXZWJTb2NrZXQpeyAKICAgICAgICAgICAgbWFya0Nvbm5lY3Rpb25VbnN0YWJsZSgpOyAKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAKICAgICAgICB9CiAgICAgICAgbGFzdFN1Y2Nlc3NmdWxDaGVjaz1EYXRlLm5vdygpOwogICAgICAgIGlmICghaXNDb25uZWN0aW9uU3RhYmxlICYmIChEYXRlLm5vdygpLXN0YWJsZUNvbm5lY3Rpb25TdGFydFRpbWU+MzAwMDAwKSkgbWFya0Nvbm5lY3Rpb25TdGFibGUoKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggeyAKICAgICAgICBtYXJrQ29ubmVjdGlvblVuc3RhYmxlKCk7IAogICAgICAgIHJldHVybiBmYWxzZTsgCiAgICB9Cn07CgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBGRVRDSCAmIFBBUlNFID09PT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgZmV0Y2hTaW1wbGVTTVMgPSBhc3luYyAoKSA9PiB7CiAgICBpZighbGl2ZVNtc1BhZ2UpIHJldHVybiBbXTsKICAgIGNvbnN0IHdpbk1zZ3MgPSBhd2FpdCBsaXZlU21zUGFnZS5ldmFsdWF0ZSgoKSA9PiB3aW5kb3cuX3NpbXBsZVNNUyB8fCBbXSkuY2F0Y2goKCkgPT4gW10pOwogICAgbGV0IGdsb2JNc2dzID0gW107IAogICAgaWYoZ2xvYmFsLnNpbXBsZVNNU0J1ZmZlcikgeyAKICAgICAgICBnbG9iTXNncyA9IGdsb2JhbC5zaW1wbGVTTVNCdWZmZXIubWFwKGkgPT4gaS5kYXRhKTsgCiAgICAgICAgZ2xvYmFsLnNpbXBsZVNNU0J1ZmZlciA9IFtdOyAKICAgIH0KICAgIHJldHVybiBbLi4ud2luTXNncywgLi4uZ2xvYk1zZ3NdOwp9OwoKY29uc3QgcGFyc2VTaW1wbGVTTVMgPSBkYXRhID0+IHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgbXNnID0gZGF0YS5tZXNzYWdlIHx8ICcnOwogICAgICAgIGNvbnN0IG9yaWcgPSBkYXRhLm9yaWdpbmF0b3IgfHwgJyc7CiAgICAgICAgY29uc3QgcmVjID0gZGF0YS5yZWNpcGllbnQgfHwgJyc7CiAgICAgICAgY29uc3QgcmFuZ2UgPSBkYXRhLnJhbmdlIHx8ICcnOwogICAgICAgIGxldCBjb3VudHJ5ID0gcmFuZ2UucmVwbGFjZSgvXHMrXGQrJC8sICcnKS50cmltKCkgfHwgJ1Vua25vd24nOwogICAgICAgIGxldCBvdHAgPSAobXNnLm1hdGNoKC8oXGR7M31bLSBdP1xkezN9KXwoXGR7NCw4fSkvKSB8fCBbXSlbMF0/LnJlcGxhY2UoL1stXHNdL2csICcnKSB8fCAnJzsKICAgICAgICBsZXQgc2VydmljZSA9IG9yaWcudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnd2hhdHNhcHAnKSB8fCBtc2cudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnd2hhdHNhcHAnKSA/ICdXaGF0c0FwcCcgOgogICAgICAgICAgICAgICAgICAgIG9yaWcudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygndGVsZWdyYW0nKSB8fCBtc2cudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygndGVsZWdyYW0nKSA/ICdUZWxlZ3JhbScgOgogICAgICAgICAgICAgICAgICAgIG9yaWcudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZ29vZ2xlJykgfHwgbXNnLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2dvb2dsZScpID8gJ0dvb2dsZScgOgogICAgICAgICAgICAgICAgICAgIG9yaWcudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZmFjZWJvb2snKSB8fCBtc2cudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZmFjZWJvb2snKSA/ICdGYWNlYm9vaycgOiBvcmlnOwogICAgICAgIHJldHVybiB7IAogICAgICAgICAgICB0aW1lOiBuZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygnaWQtSUQnKSwKICAgICAgICAgICAgY291bnRyeSwgCiAgICAgICAgICAgIG51bWJlcjogcmVjLCAKICAgICAgICAgICAgbXNnLCAKICAgICAgICAgICAgc2VydmljZSwgCiAgICAgICAgICAgIG90cCwgCiAgICAgICAgICAgIG9yaWdpbmF0b3I6IG9yaWcsIAogICAgICAgICAgICByYW5nZSwgCiAgICAgICAgICAgIHNvdXJjZTogJ3dlYnNvY2tldCcgCiAgICAgICAgfTsKICAgIH0gY2F0Y2ggeyAKICAgICAgICByZXR1cm4gbnVsbDsgCiAgICB9Cn07CgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBTT0NLRVQuSU8gTU9OSVRPUiA9PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3Qgc2V0dXBFbmhhbmNlZFNvY2tldElPTW9uaXRvcmluZyA9IGFzeW5jICgpID0+IHsKICAgIGlmICghbGl2ZVNtc1BhZ2UpIHJldHVybjsKICAgIAogICAgdHJ5IHsKICAgICAgICAvLyAxLiBFa3Nwb3MgZnVuZ3NpIGtlIE5vZGUuanMgdW50dWsgbm90aWZpa2FzaSBUZWxlZ3JhbQogICAgICAgIC8vIFBFUkJBSUtBTjogTWVuZ2d1bmFrYW4gJ3BhcnNlZCcga2FyZW5hICdtc2cnIGJlbHVtIGRpZGVmaW5pc2lrYW4gZGkgY29uc29sZS5sb2cgYXdhbAogICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLmV4cG9zZUZ1bmN0aW9uKCdvblNNU1JlY2VpdmVkJywgKHNtc0RhdGEpID0+IHsKICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gcGFyc2VTaW1wbGVTTVMoc21zRGF0YSk7CiAgICAgICAgICAgIGlmIChwYXJzZWQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQuZ3JlZW4oYFxuWyDwn5KsIF0gWyBORVcgU01TIFJFQ0lFVkVEIF0gJHtwYXJzZWQuY291bnRyeX0gLSAke3BhcnNlZC5zZXJ2aWNlfSBcbmApKTsKICAgICAgICAgICAgICAgIHNlbmRNZXNzYWdlTm90aWZpY2F0aW9uKHBhcnNlZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2UuZXZhbHVhdGVPbk5ld0RvY3VtZW50KCgpID0+IHsKICAgICAgICAgICAgY29uc3QgT3JpZ2luYWxXZWJTb2NrZXQgPSB3aW5kb3cuV2ViU29ja2V0OwogICAgICAgICAgICB3aW5kb3cuV2ViU29ja2V0ID0gZnVuY3Rpb24odXJsLCBwcm90b2NvbHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdzID0gbmV3IE9yaWdpbmFsV2ViU29ja2V0KHVybCwgcHJvdG9jb2xzKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJyVjW1NZU1RFTV0gV2ViU29ja2V0IENvbm5lY3Rpb24gQXR0ZW1wdDogJyArIHVybCwgJ2NvbG9yOiBibHVlJyk7CgogICAgICAgICAgICAgICAgd3MuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChldmVudCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd0RhdGEgPSBldmVudC5kYXRhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENlayBhcGFrYWggZGF0YSBtZW5nYW5kdW5nIGxpdmVzbXMgc2VwZXJ0aSBkaSBzY3JlZW5zaG90IGxvZyBBbmRhCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByYXdEYXRhID09PSAnc3RyaW5nJyAmJiByYXdEYXRhLmluY2x1ZGVzKCdsaXZlc21zJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJyVjW0RFQlVHLVdTXSBEYXRhIE1hc3VrOiAnICsgcmF3RGF0YSwgJ2NvbG9yOiBjeWFuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRWtzdHJhayBhcnJheSBKU09OIGRhcmkgZm9ybWF0IDQyL2xpdmVzbXMsWy4uLl0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGpzb25NYXRjaCA9IHJhd0RhdGEubWF0Y2goL1xbLipcXS8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpzb25NYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBKU09OLnBhcnNlKGpzb25NYXRjaFswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF5bG9hZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FyaSBvYmplayB5YW5nIHB1bnlhIHByb3BlcnR5IG1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc21zT2JqID0gcGF5bG9hZC5maW5kKGkgPT4gaSAmJiB0eXBlb2YgaSA9PT0gJ29iamVjdCcgJiYgaS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNtc09iaikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9uU01TUmVjZWl2ZWQoc21zT2JqKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignUGFyc2UgRXJyb3I6JywgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB3czsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2luZG93LldlYlNvY2tldC5wcm90b3R5cGUgPSBPcmlnaW5hbFdlYlNvY2tldC5wcm90b3R5cGU7CiAgICAgICAgfSk7CgogICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLnJlbG9hZCh7IHdhaXRVbnRpbDogJ25ldHdvcmtpZGxlMicgfSk7CiAgICAgICAgCiAgICAgICAgd2ViU29ja2V0TW9uaXRvckFjdGl2ZSA9IHRydWU7CiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZC5ncmVlbignW1NPQ0tFVF0g4pyFIFJFQ0lFVkVEIEJPVCBBQ1RJVkFURUQnKSk7CgogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5yZWQoJ1tTT0NLRVRdIOKdjCBFUlJPUjogJyArIGVycm9yLm1lc3NhZ2UpKTsKICAgIH0KfTsKCgoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gUk9CVVNUIENPTk5FQ1QgPT09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmNvbnN0IHVwZGF0ZUJvdFN0YXR1cyA9IChzdGF0dXMsIGlzRXJyb3IgPSBmYWxzZSkgPT4gewogICAgY29uc3QgcHJldlN0YXR1cyA9IGJvdFN0YXR1czsKICAgIGJvdFN0YXR1cyA9IHN0YXR1czsKICAgIGxhc3RDaGVja1RpbWUgPSBuZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygnaWQtSUQnKTsKICAgIAogICAgLy8gTG9nIGhhbnlhIGppa2Egc3RhdHVzIGJlcnViYWggYXRhdSBlcnJvcgogICAgaWYgKHByZXZTdGF0dXMgIT09IHN0YXR1cyB8fCBpc0Vycm9yKSB7CiAgICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0xvY2FsZVRpbWVTdHJpbmcoJ2lkLUlEJyk7CiAgICAgICAgaWYgKGlzRXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsucmVkKGBbU1RBVFVTXSDinYwgJHtzdGF0dXN9IC0gJHt0aW1lc3RhbXB9YCkpOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgIH0KICAgIH0KfTsKCmNvbnN0IGNvbm5lY3RSb2J1c3RMaXZlU21zID0gYXN5bmMgKCkgPT4gewogICAgaWYgKGlzQ29ubmVjdGluZykgewogICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnllbGxvdygnW0NPTk5FQ1RdIOKPsyBBTFJFQURZIENPTk5FQ1RJTkcuLi4nKSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgCiAgICBpc0Nvbm5lY3RpbmcgPSB0cnVlOwogICAgY29ubmVjdGlvbkF0dGVtcHRzKys7CgogICAgdHJ5IHsKICAgICAgICB1cGRhdGVCb3RTdGF0dXMoJ0NPTk5FQ1RJTkcuLi4nKTsKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay55ZWxsb3coYFtDT05ORUNUXSDwn5SEIENPTk5FQ1RJTkcuLi4gJHtjb25uZWN0aW9uQXR0ZW1wdHN9LyR7TUFYX0NPTk5FQ1RJT05fQVRURU1QVFN9YCkpOwoKICAgICAgICBpZiAoIXNldHRpbmdzLkNGX0NMRUFSQU5DRV9WQUxVRSB8fCBzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUubGVuZ3RoIDwgMTApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDRiBDbGVhcmFuY2UgdGlkYWsgdmFsaWQnKTsKICAgICAgICB9CgogICAgICAgIGlmIChsaXZlU21zUGFnZSkgewogICAgICAgICAgICB0cnkgeyBhd2FpdCBsaXZlU21zUGFnZS5jbG9zZSgpOyB9IGNhdGNoIChlKSB7fQogICAgICAgIH0KCiAgICAgICAgbGl2ZVNtc1BhZ2UgPSBhd2FpdCBicm93c2VyLm5ld1BhZ2UoKTsKICAgICAgICAKICAgICAgICBhd2FpdCBsaXZlU21zUGFnZS5zZXREZWZhdWx0VGltZW91dCgyMDAwMCk7CiAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2Uuc2V0RGVmYXVsdE5hdmlnYXRpb25UaW1lb3V0KDMwMDAwKTsKYXdhaXQgbGl2ZVNtc1BhZ2Uuc2V0Vmlld3BvcnQoeyB3aWR0aDogMTkyMCwgaGVpZ2h0OiAxMDgwIH0pOwogICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLnNldFVzZXJBZ2VudChzZXR0aW5ncy5DVVJSRU5UX1VTRVJfQUdFTlQpOwogICAgICAgIAogICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLmV2YWx1YXRlT25OZXdEb2N1bWVudCgoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuYXZpZ2F0b3IsICd3ZWJkcml2ZXInLCB7IGdldDogKCkgPT4gdW5kZWZpbmVkIH0pOwogICAgICAgIH0pOwoKICAgICAgICBhd2FpdCBsaXZlU21zUGFnZS5zZXRDb29raWUoewogICAgICAgICAgICBuYW1lOiAnY2ZfY2xlYXJhbmNlJywKICAgICAgICAgICAgdmFsdWU6IHNldHRpbmdzLkNGX0NMRUFSQU5DRV9WQUxVRSwKICAgICAgICAgICAgZG9tYWluOiAnLml2YXNtcy5jb20nLAogICAgICAgICAgICBwYXRoOiAnLycsCiAgICAgICAgICAgIGh0dHBPbmx5OiB0cnVlLAogICAgICAgICAgICBzZWN1cmU6IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuY3lhbignW0NPTk5FQ1RdIPCfjJAgTkFWSUdBVElORyBUTyBJVkFTTVMuLi4nKSk7CiAgICAgICAgCiAgICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgbGl2ZVNtc1BhZ2UuZ290byhMSVZFX1NNU19VUkwsIHsKICAgICAgICAgICAgd2FpdFVudGlsOiAnZG9tY29udGVudGxvYWRlZCcsCiAgICAgICAgICAgIHRpbWVvdXQ6IDQ1MDAwCiAgICAgICAgfSk7CgogICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmN5YW4oYFtDT05ORUNUXSDwn5OKIFN0YXR1cyA6ICR7cmVzcG9uc2UgPyByZXNwb25zZS5zdGF0dXMoKSA6ICdOL0EnfWApKTsKCiAgICAgICAgaWYgKHJlc3BvbnNlICYmIChyZXNwb25zZS5zdGF0dXMoKSA9PT0gNDAzIHx8IHJlc3BvbnNlLnN0YXR1cygpID09PSA0MjkpKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgnW0NPTk5FQ1RdIOKdjCBESUJMT0tJUiBDTE9VREZMQVJFOiBIVFRQICcgKyByZXNwb25zZS5zdGF0dXMoKSkpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NMT1VERkxBUkUgQkxPQ0sgLSBIVFRQICcgKyByZXNwb25zZS5zdGF0dXMoKSk7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMjAwMCkpOwogICAgICAgIAogICAgICAgIGNvbnN0IGhhc0Nsb3VkZmxhcmUgPSBhd2FpdCBsaXZlU21zUGFnZS5ldmFsdWF0ZSgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGJvZHlUZXh0ID0gZG9jdW1lbnQuYm9keS5pbm5lclRleHQgfHwgJyc7CiAgICAgICAgICAgIHJldHVybiBib2R5VGV4dC5pbmNsdWRlcygnQ2hlY2tpbmcgeW91ciBicm93c2VyJykgfHwgCiAgICAgICAgICAgICAgICAgICBib2R5VGV4dC5pbmNsdWRlcygnSnVzdCBhIG1vbWVudCcpOwogICAgICAgIH0pLmNhdGNoKCgpID0+IGZhbHNlKTsKICAgICAgICAKICAgICAgICBpZiAoaGFzQ2xvdWRmbGFyZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nsb3VkZmxhcmUgY2hhbGxlbmdlIG11bmN1bC4nKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGN1cnJlbnRVcmwgPSBsaXZlU21zUGFnZS51cmwoKTsKICAgICAgICAKICAgICAgICBpZiAoY3VycmVudFVybC5pbmNsdWRlcygnL2xvZ2luJykpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsueWVsbG93KCdbQ09OTkVDVF0g8J+UkSBMT0dJTiBUTyBJVkFTTVMuLi4nKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXNldHRpbmdzLklWQVNfVVNFUk5BTUUgfHwgIXNldHRpbmdzLklWQVNfUEFTU1dPUkQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlcm5hbWUgYXRhdSBwYXNzd29yZCB0aWRhayBkaXRlbXVrYW4uJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuY3lhbignW0NPTk5FQ1RdIPCfk6cgWU9VUiBJVkFTIEFDQ09VTlQgOicsIHNldHRpbmdzLklWQVNfVVNFUk5BTUUpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAyMDAwKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgdXNlcm5hbWVTZWxlY3RvciA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHVzZXJuYW1lU2VsZWN0b3JzID0gWwogICAgICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImVtYWlsIl0nLCAnaW5wdXRbbmFtZT0iZW1haWwiXScsICdpbnB1dFtuYW1lPSJ1c2VybmFtZSJdJywKICAgICAgICAgICAgICAgICdpbnB1dFthdXRvY29tcGxldGU9InVzZXJuYW1lIl0nLCAnaW5wdXRbYXV0b2NvbXBsZXRlPSJlbWFpbCJdJywKICAgICAgICAgICAgICAgICdpbnB1dFtwbGFjZWhvbGRlcio9ImVtYWlsIiBpXScsICdpbnB1dFtwbGFjZWhvbGRlcio9InVzZXJuYW1lIiBpXScKICAgICAgICAgICAgXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoY29uc3Qgc2VsZWN0b3Igb2YgdXNlcm5hbWVTZWxlY3RvcnMpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RzID0gYXdhaXQgbGl2ZVNtc1BhZ2UuJChzZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0cykgeyB1c2VybmFtZVNlbGVjdG9yID0gc2VsZWN0b3I7IGJyZWFrOyB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodXNlcm5hbWVTZWxlY3RvcikgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBsaXZlU21zUGFnZS5mb2N1cyh1c2VybmFtZVNlbGVjdG9yKTsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBsaXZlU21zUGFnZS5ldmFsdWF0ZSgocykgPT4geyBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHMpLnZhbHVlID0gJyc7IH0sIHVzZXJuYW1lU2VsZWN0b3IpOwogICAgICAgICAgICAgICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLnR5cGUodXNlcm5hbWVTZWxlY3Rvciwgc2V0dGluZ3MuSVZBU19VU0VSTkFNRSwgeyBkZWxheTogMjAgfSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgNTAwKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcGFzc3dvcmRTZWxlY3RvciA9ICdpbnB1dFt0eXBlPSJwYXNzd29yZCJdJzsKICAgICAgICAgICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLmZvY3VzKHBhc3N3b3JkU2VsZWN0b3IpOwogICAgICAgICAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2UuZXZhbHVhdGUoKCkgPT4geyBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpbnB1dFt0eXBlPSJwYXNzd29yZCJdJykudmFsdWUgPSAnJzsgfSk7CiAgICAgICAgICAgICAgICBhd2FpdCBsaXZlU21zUGFnZS50eXBlKHBhc3N3b3JkU2VsZWN0b3IsIHNldHRpbmdzLklWQVNfUEFTU1dPUkQsIHsgZGVsYXk6IDIwIH0pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDUwMCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHN1Ym1pdEJ1dHRvbiA9IGF3YWl0IGxpdmVTbXNQYWdlLiQoJ2J1dHRvblt0eXBlPSJzdWJtaXQiXSwgaW5wdXRbdHlwZT0ic3VibWl0Il0nKTsKICAgICAgICAgICAgICAgIGlmIChzdWJtaXRCdXR0b24pIHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBzdWJtaXRCdXR0b24uY2xpY2soKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2Uua2V5Ym9hcmQucHJlc3MoJ0VudGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLmtleWJvYXJkLnByZXNzKCdFbnRlcicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUdW5nZ3UgbmF2aWdhc2kgc2VsZXNhaQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2Uud2FpdEZvck5hdmlnYXRpb24oeyAKICAgICAgICAgICAgICAgICAgICB3YWl0VW50aWw6ICdkb21jb250ZW50bG9hZGVkJywKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0OiAxNTAwMCAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay55ZWxsb3coJ1tDT05ORUNUXSDimqDvuI8gVElNRSBPVVQgT1IgTk8gTkFWIEFGVEVSIExPR0lOLi4uJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMjAwMCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFZBTElEQVNJIExPR0lOIEJFUkhBU0lMIEFUQVUgVElEQUsgLS0tCiAgICAgICAgICAgIGNvbnN0IGFmdGVyTG9naW5VcmwgPSBsaXZlU21zUGFnZS51cmwoKTsKICAgICAgICAgICAgaWYgKGFmdGVyTG9naW5VcmwuaW5jbHVkZXMoJy9sb2dpbicpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5yZWQoJ1tDT05ORUNUXSDinYwgTE9HSU4gR0FHQUw6IFVzZXJuYW1lIGF0YXUgUGFzc3dvcmQgU2FsYWghJykpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VybmFtZSBhdGF1IHBhc3N3b3JkIHRpZGFrIHZhbGlkIChNYXNpaCBkaSBoYWxhbWFuIGxvZ2luKScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbignW0NPTk5FQ1RdIOKchSBMT0dJTiBCRVJIQVNJTCcpKTsKCiAgICAgICAgICAgIGNvbnN0IGNvb2tpZXMgPSBhd2FpdCBsaXZlU21zUGFnZS5jb29raWVzKCk7CiAgICAgICAgICAgIGNvbnN0IG5ld0NmQ29va2llID0gY29va2llcy5maW5kKGMgPT4gYy5uYW1lID09PSAnY2ZfY2xlYXJhbmNlJyk7CiAgICAgICAgICAgIGlmIChuZXdDZkNvb2tpZSAmJiBuZXdDZkNvb2tpZS52YWx1ZSAhPT0gc2V0dGluZ3MuQ0ZfQ0xFQVJBTkNFX1ZBTFVFKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUgPSBuZXdDZkNvb2tpZS52YWx1ZTsKICAgICAgICAgICAgICAgIHdyaXRlU2V0dGluZ1RvRmlsZVN5bmMoJ0NGX0NMRUFSQU5DRV9WQUxVRScsIG5ld0NmQ29va2llLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhZnRlckxvZ2luVXJsLmluY2x1ZGVzKCcvbGl2ZS9teV9zbXMnKSkgewogICAgICAgICAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2UuZ290byhMSVZFX1NNU19VUkwsIHsgd2FpdFVudGlsOiAnZG9tY29udGVudGxvYWRlZCcsIHRpbWVvdXQ6IDIwMDAwIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmaW5hbFVybCA9IGxpdmVTbXNQYWdlLnVybCgpOwogICAgICAgIGlmICghZmluYWxVcmwuaW5jbHVkZXMoJy9saXZlL215X3NtcycpKSB7CiAgICAgICAgICAgIHJlc3BvbnNlID0gYXdhaXQgbGl2ZVNtc1BhZ2UuZ290byhMSVZFX1NNU19VUkwsIHsgd2FpdFVudGlsOiAnZG9tY29udGVudGxvYWRlZCcsIHRpbWVvdXQ6IDIwMDAwIH0pOwogICAgICAgICAgICBpZiAoIXJlc3BvbnNlIHx8IHJlc3BvbnNlLnN0YXR1cygpID49IDQwMCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBHYWdhbCBha3NlcyBMaXZlIFNNUy4gU3RhdHVzOiAke3Jlc3BvbnNlID8gcmVzcG9uc2Uuc3RhdHVzKCkgOiAnTi9BJ31gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDEwMDApKTsKICAgICAgICBhd2FpdCBoYW5kbGVQb3B1cEFuZFR1dG9yaWFsKGxpdmVTbXNQYWdlKTsKICAgICAgICBhd2FpdCBzZXR1cEVuaGFuY2VkU29ja2V0SU9Nb25pdG9yaW5nKCk7CgogICAgICAgIG1hcmtDb25uZWN0aW9uU3RhYmxlKCk7CiAgICAgICAgdXBkYXRlQm90U3RhdHVzKCdMaXZlIFNNUyBSZWFkeScpOwogICAgICAgIGlzUG9sbGluZ0FjdGl2ZSA9IHRydWU7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZChgW0NPTk5FQ1RdIOKdjCBFcnJvcjogJHtlcnJvci5tZXNzYWdlfWApKTsKICAgICAgICBtYXJrQ29ubmVjdGlvblVuc3RhYmxlKCk7CiAgICAgICAgdXBkYXRlQm90U3RhdHVzKGBFcnJvcjogJHtlcnJvci5tZXNzYWdlLnN1YnN0cmluZygwLCAzMCl9Li4uYCwgdHJ1ZSk7CiAgICAgICAgaXNQb2xsaW5nQWN0aXZlID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSBmaW5hbGx5IHsKICAgICAgICBpc0Nvbm5lY3RpbmcgPSBmYWxzZTsKICAgIH0KfTsKCgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBQT0xMSU5HID09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgY2hlY2tTdGFibGVNZXNzYWdlcyA9IGFzeW5jICgpID0+IHsKICAgIGlmKGlzQ29ubmVjdGluZyB8fCAhaXNCcm93c2VyUmVhZHkgfHwgIWxpdmVTbXNQYWdlIHx8ICFpc1BvbGxpbmdBY3RpdmUpIHJldHVybjsKICAgIGNvbnN0IHJhd01lc3NhZ2VzID0gYXdhaXQgZmV0Y2hTaW1wbGVTTVMoKTsKICAgIGNvbnN0IG5ld01lc3NhZ2VzID0gW107CiAgICBmb3IoY29uc3QgbSBvZiByYXdNZXNzYWdlcyl7IAogICAgICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlU2ltcGxlU01TKG0pOyAKICAgICAgICBpZihwYXJzZWQpeyAKICAgICAgICAgICAgY29uc3QgaCA9IGAke3BhcnNlZC5udW1iZXJ9LSR7cGFyc2VkLnNlcnZpY2V9LSR7cGFyc2VkLm1zZy5zdWJzdHJpbmcoMCw1MCl9YDsgCiAgICAgICAgICAgIGlmKCFzZW50TWVzc2FnZUhhc2hlcy5oYXMoaCkpeyAKICAgICAgICAgICAgICAgIG5ld01lc3NhZ2VzLnB1c2gocGFyc2VkKTsgCiAgICAgICAgICAgICAgICBzZW50TWVzc2FnZUhhc2hlcy5hZGQoaCk7IAogICAgICAgICAgICAgICAgYXdhaXQgc2VuZE1lc3NhZ2VOb3RpZmljYXRpb24ocGFyc2VkKTsgCiAgICAgICAgICAgIH0gCiAgICAgICAgfSAKICAgIH0KfTsKc2V0SW50ZXJ2YWwoY2hlY2tTdGFibGVNZXNzYWdlcywgMTAwMDApOwoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gTk9USUZJQ0FUSU9OID09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmxldCBsYXN0U01TTG9nVGltZSA9IDA7CmNvbnN0IFNNU19MT0dfQ09PTERPV04gPSAxMDAwOwoKY29uc3Qgc2VuZE1lc3NhZ2VOb3RpZmljYXRpb24gPSBhc3luYyAobXNnKSA9PiB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgaWYgKG5vdyAtIGxhc3RTTVNMb2dUaW1lIDwgU01TX0xPR19DT09MRE9XTikgcmV0dXJuOwogICAgICAgIGxhc3RTTVNMb2dUaW1lID0gbm93OwogICAgICAgIAogICAgICAgIGNvbnN0IGNvdW50cnlGbGFnID0gZ2V0Q291bnRyeUZsYWcobXNnLmNvdW50cnkpOwogICAgICAgIGNvbnN0IG1hc2tlZCA9IG1hc2tQaG9uZU51bWJlcihtc2cubnVtYmVyKTsKICAgICAgICBjb25zdCBvdHBUZXh0ID0gbXNnLm90cAogID8gYDxibG9ja3F1b3RlPvCflJAgPGI+8J2Xo/Cdl5TwnZem8J2XpvCdl5bwnZei8J2Xl/Cdl5g8L2I+IDogPGNvZGU+JHttc2cub3RwfTwvY29kZT48L2Jsb2NrcXVvdGU+YAogIDogJyc7CiAgICAgICAgCiAgICAgICAgY29uc3QgdGV4dCA9IGA8YmxvY2txdW90ZT48Yj7wn5KlIPCdl6HwnZeY8J2XqiAke21zZy5zZXJ2aWNlfSAke2NvdW50cnlGbGFnfTwvYj48L2Jsb2NrcXVvdGU+CuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgQo8Yj7wn5OxIPCdl6HwnZiC8J2XuvCdl6/wnZey8J2XvyA6PC9iPiA8aT4ke21hc2tlZH08L2k+ICAgICAgIAoke290cFRleHR9CjxiPvCfjI0g8J2XlvCdl7zwnZiC8J2Xu/CdmIHwnZe/8J2YhiA6PC9iPiAke2NvdW50cnlGbGFnfSAtICR7bXNnLmNvdW50cnl9CjxiPuKame+4jyDwnZem8J2XsvCdl7/wnZiD8J2XtvCdl7DwnZeyIDo8L2I+ICR7bXNnLnNlcnZpY2V9CuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgQo8Yj48YmxvY2txdW90ZT7wn5KsIPCdl5nwnZiC8J2XufCdl7kg8J2XoPCdl7LwnZiA8J2YgPCdl67wnZe08J2XsjwvYmxvY2txdW90ZT48L2I+CjxpPjxibG9ja3F1b3RlPiR7ZXNjYXBlSHRtbChtc2cubXNnKX08L2Jsb2NrcXVvdGU+PC9pPgrilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIEKPGI+PGk+4o+wIPCdmIHwnZe28J2XuvCdl7IgOiAke21zZy50aW1lfTwvaT48L2I+YDsKICAgICAgICAKICAgICAgICBjb25zdCBrZXlib2FyZCA9IE1hcmt1cC5pbmxpbmVLZXlib2FyZChbCiAgICAgICAgCiAgWwogICAgTWFya3VwLmJ1dHRvbi51cmwoJ/Cfmqgg8J2YvvCdmYPwnZi88J2ZifCdmYnwnZmA8J2Zh/CdmY4nLCBzZXR0aW5ncy5NQUlOX0NIQU5ORUxfTElOSyB8fCAnIycpLAogICAgTWFya3VwLmJ1dHRvbi51cmwoJ/Cfk4Ig8J2ZifCdmZDwnZmI8J2YvfCdmYDwnZmN8J2ZjicsIHNldHRpbmdzLk5VTUJFUl9HUk9VUF9MSU5LIHx8ICcjJykKICBdLAogIFsKICAgIE1hcmt1cC5idXR0b24udXJsKCfwn5GRIPCdmYrwnZmS8J2ZifCdmYDwnZmNIPCdmL3wnZmK8J2ZjycsIHNldHRpbmdzLkJPVF9PV05FUl9MSU5LIHx8ICcjJykKICBdCl0pOwogICAgICAgIC8vIE1lbmdpcmltIGtlIGJhbnlhayBncnVwCiAgICAgICAgY29uc3QgY2hhdElkcyA9IEFycmF5LmlzQXJyYXkoc2V0dGluZ3MuQ0hBVF9JRCkgPyBzZXR0aW5ncy5DSEFUX0lEIDogW3NldHRpbmdzLkNIQVRfSURdOwogICAgICAgIAogICAgICAgIGZvciAoY29uc3QgaWQgb2YgY2hhdElkcykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYXdhaXQgYm90LnRlbGVncmFtLnNlbmRNZXNzYWdlKGlkLCB0ZXh0LCB7IAogICAgICAgICAgICAgICAgICAgIHBhcnNlX21vZGU6ICdIVE1MJywgCiAgICAgICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwOiBrZXlib2FyZC5yZXBseV9tYXJrdXAgCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZChgW1NNU10g4p2MIEdhZ2FsIGtpcmltIGtlIElEICR7aWR9OiAke2Vyci5tZXNzYWdlfWApKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFtTTVNdIOKdjCBFcnJvciBzZW5kaW5nIG5vdGlmaWNhdGlvbjogJHtlcnJvci5tZXNzYWdlfWApKTsKICAgIH0KfTsKCgoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gUFJPR1JFU1MgQkFSIFNZU1RFTSA9PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmNvbnN0IGNyZWF0ZVByb2dyZXNzQmFyID0gKGN1cnJlbnQsIHRvdGFsLCBsZW5ndGggPSAyMCkgPT4gewogIGNvbnN0IHBlcmNlbnRhZ2UgPSBjdXJyZW50IC8gdG90YWw7CiAgY29uc3QgZmlsbGVkTGVuZ3RoID0gTWF0aC5yb3VuZChsZW5ndGggKiBwZXJjZW50YWdlKTsKICBjb25zdCBlbXB0eUxlbmd0aCA9IGxlbmd0aCAtIGZpbGxlZExlbmd0aDsKICAKICBjb25zdCBmaWxsZWRCYXIgPSAn4paIJy5yZXBlYXQoZmlsbGVkTGVuZ3RoKTsKICBjb25zdCBlbXB0eUJhciA9ICfilpEnLnJlcGVhdChlbXB0eUxlbmd0aCk7CiAgCiAgcmV0dXJuIGBbJHtmaWxsZWRCYXJ9JHtlbXB0eUJhcn1dICR7TWF0aC5yb3VuZChwZXJjZW50YWdlICogMTAwKX0lYDsKfTsKCmNvbnN0IHVwZGF0ZVJhbmdlU3RhdHVzID0gYXN5bmMgKGN0eCwgd2FpdE1zZywgc3RhdHVzVGV4dCwgY3VycmVudFN0ZXAgPSAwLCB0b3RhbFN0ZXBzID0gMTApID0+IHsKICB0cnkgewogICAgY29uc3QgY3VycmVudFRpbWUgPSBuZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygnaWQtSUQnKTsKICAgIGxldCBwcm9ncmVzc0JhciA9ICcnOwogICAgCiAgICBpZiAodG90YWxTdGVwcyA+IDAgJiYgY3VycmVudFN0ZXAgPiAwKSB7CiAgICAgIHByb2dyZXNzQmFyID0gY3JlYXRlUHJvZ3Jlc3NCYXIoY3VycmVudFN0ZXAsIHRvdGFsU3RlcHMpOwogICAgfQogICAgCiAgICBjb25zdCB1cGRhdGVkVGV4dCA9IGA8YmxvY2txdW90ZT7ij7MgPGI+U2VkYW5nIE1lbmdhbmFsaXNpcyBSYW5nZTwvYj48L2Jsb2NrcXVvdGU+XG5cbiR7cHJvZ3Jlc3NCYXJ9XG5cbvCflZAgPGk+TGFzdCB1cGRhdGUgOiAke2N1cnJlbnRUaW1lfTwvaT5gOwogICAgCiAgICBhd2FpdCBjdHgudGVsZWdyYW0uZWRpdE1lc3NhZ2VUZXh0KAogICAgICBjdHguY2hhdC5pZCwgCiAgICAgIHdhaXRNc2cubWVzc2FnZV9pZCwgCiAgICAgIG51bGwsIAogICAgICB1cGRhdGVkVGV4dCwgCiAgICAgIHsgcGFyc2VfbW9kZTogJ0hUTUwnIH0KICAgICk7CiAgIAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmxvZyhgW1NUQVRVU10gJHtzdGF0dXNUZXh0fWApOwogIH0KfTsKCmNvbnN0IGhhbmRsZVJhbmdlRXJyb3IgPSBhc3luYyAoY3R4LCB3YWl0TXNnLCBlcnJvcikgPT4gewogIHRyeSB7CiAgICBhd2FpdCBjdHgudGVsZWdyYW0uZGVsZXRlTWVzc2FnZShjdHguY2hhdC5pZCwgd2FpdE1zZy5tZXNzYWdlX2lkKTsKICB9IGNhdGNoIChlKSB7fQogIAogIGF3YWl0IGN0eC5yZXBseVdpdGhIVE1MKAogICAgYDxibG9ja3F1b3RlPuKdjCBHYWdhbCBtZWxha3VrYW4gYW5hbGlzaXMgcmFuZ2U8L2Jsb2NrcXVvdGU+XG5cbjxjb2RlPiR7ZXJyb3IubWVzc2FnZX08L2NvZGU+YCwKICAgIHsgcmVwbHlfdG9fbWVzc2FnZV9pZDogY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZCB9CiAgKTsKfTsKCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09IFJBTkdFIENIRUNLIFNZU1RFTSA9PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpjb25zdCBleHRyYWN0VGFibGVEYXRhRnJvbVBhZ2UgPSBhc3luYyAocGFnZSkgPT4gewogICAgcmV0dXJuIGF3YWl0IHBhZ2UuZXZhbHVhdGUoKCkgPT4gewogICAgICAgIGNvbnN0IGNsZWFuVGV4dCA9ICh0eHQpID0+IHsKICAgICAgICAgICAgaWYgKCF0eHQpIHJldHVybiAnJzsKICAgICAgICAgICAgbGV0IHQgPSB0eHQ7CiAgICAgICAgICAgIHQgPSB0LnJlcGxhY2UoL2Z1bmN0aW9uXHMrW1xzXFNdKi9naSwgIiIpOwogICAgICAgICAgICB0ID0gdC5yZXBsYWNlKC9cJFwoW1xzXFNdKi9naSwgIiIpOwogICAgICAgICAgICB0ID0gdC5yZXBsYWNlKC9Td2FsW1xzXFNdKi9naSwgIiIpOwogICAgICAgICAgICB0ID0gdC5yZXBsYWNlKC88XC8/W14+XSs+L2csICIiKTsKICAgICAgICAgICAgdCA9IHQucmVwbGFjZSgvXHN7Mix9L2csICIgIik7CiAgICAgICAgICAgIHQgPSB0LnRyaW0oKTsKICAgICAgICAgICAgaWYgKHQuZW5kc1dpdGgoIigiKSkgdCA9IHQgKyAiKSI7CiAgICAgICAgICAgIHJldHVybiB0OwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHJlc3VsdHMgPSBbXTsKICAgICAgICBjb25zdCB0YWJsZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjbGllbnRzbXNoaXN0b3J5LXRhYmxlJyk7CiAgICAgICAgaWYgKCF0YWJsZSkgcmV0dXJuIHJlc3VsdHM7CgogICAgICAgIGNvbnN0IHRib2R5ID0gdGFibGUucXVlcnlTZWxlY3RvcigndGJvZHknKTsKICAgICAgICBpZiAoIXRib2R5KSByZXR1cm4gcmVzdWx0czsKCiAgICAgICAgY29uc3Qgcm93cyA9IHRib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RyJyk7CgogICAgICAgIHJvd3MuZm9yRWFjaChyb3cgPT4gewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgY2VsbHMgPSByb3cucXVlcnlTZWxlY3RvckFsbCgndGQnKTsKICAgICAgICAgICAgICAgIGlmIChjZWxscy5sZW5ndGggPj0gNSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlQ2VsbCA9IGNlbGxzWzBdOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlc3ROdW1iZXJDZWxsID0gY2VsbHNbMV07CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkQ2VsbCA9IGNlbGxzWzJdOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VDZWxsID0gY2VsbHNbM107CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGltZUNlbGwgPSBjZWxsc1s0XTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2VUZXh0ID0gY2xlYW5UZXh0KHJhbmdlQ2VsbC50ZXh0Q29udGVudD8udHJpbSgpIHx8ICcnKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ZXN0TnVtYmVyID0gY2xlYW5UZXh0KHRlc3ROdW1iZXJDZWxsLnRleHRDb250ZW50Py50cmltKCkgfHwgJycpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpZCA9IGNsZWFuVGV4dChzaWRDZWxsLnRleHRDb250ZW50Py50cmltKCkgfHwgJycpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBjbGVhblRleHQobWVzc2FnZUNlbGwudGV4dENvbnRlbnQ/LnRyaW0oKSB8fCAnJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IGNsZWFuVGV4dCh0aW1lQ2VsbC50ZXh0Q29udGVudD8udHJpbSgpIHx8ICcnKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFyYW5nZVRleHQgfHwgIXNpZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnRyeSA9ICdVTktOT1dOJzsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IHJhbmdlVGV4dC5tYXRjaCgvXihbQS1aYS16XHNdKykvKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY291bnRyeSA9IG1hdGNoWzFdLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgUmFuZ2U6IHJhbmdlVGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgVGVzdE51bWJlcjogdGVzdE51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgU0lEOiBzaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIE1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgIFRpbWU6IHRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIENvdW50cnk6IGNvdW50cnksCiAgICAgICAgICAgICAgICAgICAgICAgIFNTSUQ6IHNpZC50b1VwcGVyQ2FzZSgpCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfSk7Cn07Cgpjb25zdCBjaGVja0FuZENsaWNrTmV4dFBhZ2UgPSBhc3luYyAocGFnZSkgPT4gewogICAgdHJ5IHsKICAgICAgICBjb25zdCBjbGlja2VkID0gYXdhaXQgcGFnZS5ldmFsdWF0ZSgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IG5leHRMaSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjbGllbnRzbXNoaXN0b3J5LXRhYmxlX25leHQiKTsKICAgICAgICAgICAgaWYgKCFuZXh0TGkpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIGlmIChuZXh0TGkuY2xhc3NMaXN0LmNvbnRhaW5zKCJkaXNhYmxlZCIpKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBhID0gbmV4dExpLnF1ZXJ5U2VsZWN0b3IoImEiKTsKICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgIGEuY2xpY2soKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKCFjbGlja2VkKSByZXR1cm4gZmFsc2U7CgogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA4MDAwKSk7CgogICAgICAgIGNvbnN0IGxvYWRlZCA9IGF3YWl0IHBhZ2UuZXZhbHVhdGUoKCkgPT4gewogICAgICAgICAgICBjb25zdCB0Ym9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjbGllbnRzbXNoaXN0b3J5LXRhYmxlIHRib2R5Iik7CiAgICAgICAgICAgIGlmICghdGJvZHkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoInRyIikubGVuZ3RoID4gMDsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKCFsb2FkZWQpIHsKICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbU1RBVFVTXSBFcnJvciBpbiBjaGVja0FuZENsaWNrTmV4dFBhZ2U6JywgZS5tZXNzYWdlKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn07Cgpjb25zdCB3YWl0Rm9yVGFibGVEYXRhID0gYXN5bmMgKHBhZ2UpID0+IHsKICAgIHRyeSB7CiAgICAgICAgLy8gVHVuZ2d1IHNhbXBhaSBEYXRhVGFibGVzIHRlcmluaXNpYWxpc2FzaQogICAgICAgIGF3YWl0IHBhZ2Uud2FpdEZvckZ1bmN0aW9uKCgpID0+IHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiAkICE9PSAndW5kZWZpbmVkJyAmJiAKICAgICAgICAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlICYmIAogICAgICAgICAgICAgICAgICAgJCgnI2NsaWVudHNtc2hpc3RvcnktdGFibGUnKS5sZW5ndGggPiAwICYmCiAgICAgICAgICAgICAgICAgICAkKCcjY2xpZW50c21zaGlzdG9yeS10YWJsZScpLkRhdGFUYWJsZSgpOwogICAgICAgIH0sIHsgdGltZW91dDogMzAwMDAgfSk7CiAgICAgICAgCiAgICAgICAgLy8gVHVuZ2d1IHNhbXBhaSBhZGEgZGF0YSBkaSB0YWJlbAogICAgICAgIGF3YWl0IHBhZ2Uud2FpdEZvckZ1bmN0aW9uKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgZGF0YVRhYmxlID0gJCgnI2NsaWVudHNtc2hpc3RvcnktdGFibGUnKS5EYXRhVGFibGUoKTsKICAgICAgICAgICAgcmV0dXJuIGRhdGFUYWJsZSAmJiBkYXRhVGFibGUucm93cyAmJiBkYXRhVGFibGUucm93cygpLmNvdW50KCkgPiAwOwogICAgICAgIH0sIHsgdGltZW91dDogMzAwMDAgfSk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUubG9nKCdbU1RBVFVTXSDinYwgVGltZW91dCBtZW51bmdndSBEYXRhVGFibGVzOicsIGVycm9yLm1lc3NhZ2UpOwogICAgICAgIAogICAgICAgIC8vIENvYmEgcGVuZGVrYXRhbiBhbHRlcm5hdGlmOiB0dW5nZ3UgZWxlbWVuIHRhYmVsIG11bmN1bAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHBhZ2Uud2FpdEZvclNlbGVjdG9yKCcjY2xpZW50c21zaGlzdG9yeS10YWJsZScsIHsgdGltZW91dDogMTAwMDAgfSk7CiAgICAgICAgICAgIGF3YWl0IHBhZ2Uud2FpdEZvclNlbGVjdG9yKCcjY2xpZW50c21zaGlzdG9yeS10YWJsZSB0Ym9keSB0cicsIHsgdGltZW91dDogMjAwMDAgfSk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU1RBVFVTXSDinIUgRGF0YSByYW5nZSBiZXJoYXNpbCBkaXRlbXVrYW4nKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NUQVRVU10g4puUIERhdGEgcmFuZ2UgZ2FnYWwgZGl0ZW11a2FuJyk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9Cn07Cgpjb25zdCBkb3dubG9hZEFuZEFuYWx5emVSYW5nZURhdGEgPSBhc3luYyAoc2VydmljZSwgY291bnRyeSwgY3R4LCB3YWl0TXNnKSA9PiB7CiAgICBpZiAoIWlzQnJvd3NlclJlYWR5IHx8ICFicm93c2VyKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIHRpZGFrIHJlYWR5LiIpOwogICAgfQogICAgCiAgICBsZXQgcGFnZSA9IG51bGw7CiAgICBsZXQgYWxsUmVzdWx0cyA9IFtdOwogICAgCiAgICB0cnkgewogICAgICAgIC8vIFN0ZXAgMTogTWVtYnVrYSBicm93c2VyCiAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCAi8J+UhCBNZW1idWthIGhhbGFtYW4gcmFuZ2UgdGVzdC4uLiIsIDEsIDEwKTsKICAgICAgIAogICAgICAgIHBhZ2UgPSBhd2FpdCBicm93c2VyLm5ld1BhZ2UoKTsKICAgICAgICBhd2FpdCBwYWdlLnNldERlZmF1bHROYXZpZ2F0aW9uVGltZW91dCgzMDAwMDApOwogICAgICAgIGF3YWl0IHBhZ2Uuc2V0RGVmYXVsdFRpbWVvdXQoMTIwMDAwKTsKICAgICAgICBhd2FpdCBwYWdlLnNldFZpZXdwb3J0KHsgd2lkdGg6IDE5MjAsIGhlaWdodDogMTA4MCB9KTsKICAgICAgICAKICAgICAgICBjb25zdCB1c2VyQWdlbnQgPSBzZXR0aW5ncy5DVVJSRU5UX1VTRVJfQUdFTlQ7CiAgICAgICAgYXdhaXQgcGFnZS5zZXRVc2VyQWdlbnQodXNlckFnZW50KTsKICAgICAgICAKICAgICAgICBpZiAoc2V0dGluZ3MuQ0ZfQ0xFQVJBTkNFX1ZBTFVFICYmIHNldHRpbmdzLklWQVNfU0VTU0lPTl9WQUxVRSAmJiBzZXR0aW5ncy5YU1JGX1RPS0VOX1ZBTFVFKSB7CiAgICAgICAgICAgIGNvbnN0IGNvb2tpZXMgPSBbCiAgICAgICAgICAgICAgICB7IG5hbWU6ICdjZl9jbGVhcmFuY2UnLCB2YWx1ZTogc2V0dGluZ3MuQ0ZfQ0xFQVJBTkNFX1ZBTFVFLCBkb21haW46ICcuaXZhc21zLmNvbScgfSwKICAgICAgICAgICAgICAgIHsgbmFtZTogJ2l2YXNfc21zX3Nlc3Npb24nLCB2YWx1ZTogc2V0dGluZ3MuSVZBU19TRVNTSU9OX1ZBTFVFLCBkb21haW46ICcuaXZhc21zLmNvbScgfSwKICAgICAgICAgICAgICAgIHsgbmFtZTogJ1hTUkYtVE9LRU4nLCB2YWx1ZTogc2V0dGluZ3MuWFNSRl9UT0tFTl9WQUxVRSwgZG9tYWluOiAnLml2YXNtcy5jb20nIH0KICAgICAgICAgICAgXTsKICAgICAgICAgICAgYXdhaXQgcGFnZS5zZXRDb29raWUoLi4uY29va2llcyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxldCB0YXJnZXRVcmwgPSBzZXJ2aWNlID09PSAnYWxsJwogICAgICAgICAgICA/IFJBTkdFX0JBU0VfVVJMCiAgICAgICAgICAgIDogYCR7UkFOR0VfQkFTRV9VUkx9P2FwcD0ke3NlcnZpY2V9YDsKICAgICAgICAKICAgICAgICAvLyBTdGVwIDI6IE1lbmdha3NlcyBVUkwKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csIGDwn4yQIE1lbmdha3NlczogJHt0YXJnZXRVcmx9YCwgMiwgMTApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcGFnZS5nb3RvKHRhcmdldFVybCwgewogICAgICAgICAgICB3YWl0VW50aWw6ICduZXR3b3JraWRsZTAnLAogICAgICAgICAgICB0aW1lb3V0OiAxMjAwMDAKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBjb25zdCBzdGF0dXMgPSByZXNwb25zZSA/IHJlc3BvbnNlLnN0YXR1cygpIDogJ04vQSc7CiAgICAgICAgCiAgICAgICAgaWYgKHN0YXR1cyA+PSA0MDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBIYWxhbWFuIGVycm9yIGRlbmdhbiBzdGF0dXM6ICR7c3RhdHVzfWApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdGVwIDM6IE1lbnVuZ2d1IGxvYWQKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csICLij7MgTWVudW5nZ3UgaGFsYW1hbiBzZWxlc2FpIGxvYWQuLi4iLCAzLCAxMCk7CiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDE1MDAwKSk7CiAgICAgICAgCiAgICAgICAgLy8gU3RlcCA0OiBIYW5kbGUgcG9wdXAKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csICLwn5uh77iPIE1lbmFuZ2FuaSBwb3B1cC90dXRvcmlhbC4uLiIsIDQsIDEwKTsKICAgICAgICBhd2FpdCBoYW5kbGVQb3B1cEFuZFR1dG9yaWFsKHBhZ2UpOwogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCA1MDAwKSk7CiAgICAgICAgCiAgICAgICAgLy8gU3RlcCA1OiBDbGVhciBmaWx0ZXIKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csICLwn6e5IE1lbWJlcnNpaGthbiBmaWx0ZXIgc2VhcmNoLi4uIiwgNSwgMTApOwogICAgICAgIGF3YWl0IGNsZWFyU2VhcmNoRmlsdGVyKHBhZ2UpOwogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCA1MDAwKSk7CiAgICAgICAgCiAgICAgICAgaWYgKGNvdW50cnkgIT09ICdhbGwnKSB7CiAgICAgICAgICAgIC8vIFN0ZXAgNjogU2VhcmNoIGNvdW50cnkKICAgICAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCBg8J+UjiBNZW5jYXJpIG5lZ2FyYTogJHtjb3VudHJ5fWAsIDYsIDEwKTsKICAgICAgICAgICAgbGV0IG9rID0gYXdhaXQgc2VhcmNoQ291bnRyeUluVGFibGUocGFnZSwgY291bnRyeSk7CiAgICAgICAgICAgIGlmICghb2spIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNhcCA9IGNvdW50cnkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjb3VudHJ5LnNsaWNlKDEpOwogICAgICAgICAgICAgICAgYXdhaXQgc2VhcmNoQ291bnRyeUluVGFibGUocGFnZSwgY2FwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTAwMDApKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csICLwn4yNIE1lbmdhbmFsaXNpcyBzZW11YSBuZWdhcmEuLi4iLCA2LCAxMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0ZXAgNzogQ2FyaSB0YWJlbAogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgIvCflI0gTWVuY2FyaSB0YWJlbCBkYXRhLi4uIiwgNywgMTApOwogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAxMDAwMCkpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRhYmxlRXhpc3RzID0gYXdhaXQgcGFnZS5ldmFsdWF0ZSgoKSA9PiB7CiAgICAgICAgICAgIHJldHVybiAhIWRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjbGllbnRzbXNoaXN0b3J5LXRhYmxlJyk7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKCF0YWJsZUV4aXN0cykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhYmVsIHRpZGFrIGRpdGVtdWthbiBzZXRlbGFoIGxvYWQuIik7CiAgICAgICAgfQoKICAgICAgICAvLyBTdGVwIDg6IFBhc3Rpa2FuIGhhbGFtYW4gMQogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgIvCfk4QgTWVtYXN0aWthbiBiZXJhZGEgZGkgaGFsYW1hbiAxLi4uIiwgOCwgMTApOwogICAgICAgIGF3YWl0IHBhZ2Uud2FpdEZvclNlbGVjdG9yKCcjY2xpZW50c21zaGlzdG9yeS10YWJsZScsIHsgdGltZW91dDogMjAwMDAgfSk7CgogICAgICAgIGF3YWl0IHBhZ2UuZXZhbHVhdGUoKCkgPT4gewogICAgICAgICAgICBpZiAodHlwZW9mICQgIT09ICd1bmRlZmluZWQnICYmICQuZm4uZGF0YVRhYmxlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICQoJyNjbGllbnRzbXNoaXN0b3J5LXRhYmxlJykuRGF0YVRhYmxlKCkucGFnZSgwKS5kcmF3KCdwYWdlJyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDUwMDApKTsKCiAgICAgICAgLy8gU3RlcCA5OiBCYWNhIGhhbGFtYW4gMQogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgIvCfk4ogTWVtYmFjYSBkYXRhIGRhcmkgaGFsYW1hbiAxLi4uIiwgOSwgMTApOwogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCA4MDAwKSk7CiAgICAgICAgCiAgICAgICAgbGV0IHBhZ2VSZXN1bHRzID0gYXdhaXQgZXh0cmFjdFRhYmxlRGF0YUZyb21QYWdlKHBhZ2UpOwogICAgICAgIGFsbFJlc3VsdHMgPSBbLi4ucGFnZVJlc3VsdHNdOwogICAgICAgIAogICAgICAgIGlmIChhbGxSZXN1bHRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRpZGFrIGFkYSBkYXRhIHlhbmcgZGl0ZW11a2FuIHVudHVrIHNlcnZpY2UgJHtzZXJ2aWNlfSBkYW4gbmVnYXJhICR7Y291bnRyeX0uYCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgYOKchSBIYWxhbWFuIDE6ICR7YWxsUmVzdWx0cy5sZW5ndGh9IGRhdGEgZGl0ZW11a2FuYCwgOSwgMTApOwogICAgICAgIAogICAgICAgIC8vIFN0ZXAgMTA6IEJhY2EgaGFsYW1hbiBiZXJpa3V0bnlhCiAgICAgICAgbGV0IHBhZ2VOdW1iZXIgPSAxOwogICAgICAgIGNvbnN0IG1heFBhZ2VzID0gNTsKICAgICAgICBsZXQgY29uc2VjdXRpdmVOb0RhdGEgPSAwOwogICAgICAgIAogICAgICAgIHdoaWxlIChwYWdlTnVtYmVyIDwgbWF4UGFnZXMpIHsKICAgICAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCBg4o+t77iPIE1lbmNvYmEgaGFsYW1hbiAke3BhZ2VOdW1iZXIgKyAxfS4uLmAsIDEwLCAxMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBuZXh0T2sgPSBhd2FpdCBjaGVja0FuZENsaWNrTmV4dFBhZ2UocGFnZSk7CiAgICAgICAgICAgIGlmICghbmV4dE9rKSB7CiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csIGDwn4+BIFRpZGFrIGFkYSB0b21ib2wgbmV4dCBkaSBoYWxhbWFuICR7cGFnZU51bWJlciArIDF9LmAsIDEwLCAxMCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDEyMDAwKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YWJsZVN0aWxsRXhpc3RzID0gYXdhaXQgcGFnZS5ldmFsdWF0ZSgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB0YiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjbGllbnRzbXNoaXN0b3J5LXRhYmxlIHRib2R5Jyk7CiAgICAgICAgICAgICAgICBpZiAoIXRiKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gdGIucXVlcnlTZWxlY3RvckFsbCgndHInKS5sZW5ndGggPiAwOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdGFibGVTdGlsbEV4aXN0cykgewogICAgICAgICAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCBg4pqg77iPIFRhYmVsIGhpbGFuZyBkaSBoYWxhbWFuICR7cGFnZU51bWJlciArIDF9LCByZXRyeS4uLmAsIDEwLCAxMCk7CiAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgNTAwMCkpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHBhZ2VSZXN1bHRzID0gYXdhaXQgZXh0cmFjdFRhYmxlRGF0YUZyb21QYWdlKHBhZ2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHBhZ2VSZXN1bHRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgY29uc2VjdXRpdmVOb0RhdGErKzsKICAgICAgICAgICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgYOKPue+4jyBEYXRhIGtvc29uZyBkaSBoYWxhbWFuICR7cGFnZU51bWJlciArIDF9ICgke2NvbnNlY3V0aXZlTm9EYXRhfS8zKWAsIDEwLCAxMCk7CiAgICAgICAgICAgICAgICBpZiAoY29uc2VjdXRpdmVOb0RhdGEgPj0gMykgYnJlYWs7CiAgICAgICAgICAgICAgICBwYWdlTnVtYmVyKys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc2VjdXRpdmVOb0RhdGEgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgYWxsUmVzdWx0cy5wdXNoKC4uLnBhZ2VSZXN1bHRzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgYPCfk6UgSGFsYW1hbiAke3BhZ2VOdW1iZXIgKyAxfTogKyR7cGFnZVJlc3VsdHMubGVuZ3RofSBkYXRhLCBUb3RhbDogJHthbGxSZXN1bHRzLmxlbmd0aH1gLCAxMCwgMTApOwogICAgICAgICAgICAKICAgICAgICAgICAgcGFnZU51bWJlcisrOwogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMzAwMCkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csIGDinIUgVG90YWwgJHthbGxSZXN1bHRzLmxlbmd0aH0gZGF0YSBkaXRlbXVrYW4gZGFyaSAke3BhZ2VOdW1iZXJ9IGhhbGFtYW5gLCAxMCwgMTApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGFuYWx5emVSYW5nZURhdGEoYWxsUmVzdWx0cywgc2VydmljZSwgY291bnRyeSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW1NUQVRVU10gRG93bmxvYWQgYW5kIEFuYWx5emUgRXJyb3I6JywgZXJyb3IpOwogICAgICAgIGlmIChwYWdlKSB7CiAgICAgICAgICAgIGNvbnN0IGRlYnVnUGF0aCA9IHBhdGguam9pbihTU19ESVIsIGBlcnJvcl8ke0RhdGUubm93KCl9LnBuZ2ApOwogICAgICAgICAgICBhd2FpdCBwYWdlLnNjcmVlbnNob3QoeyBwYXRoOiBkZWJ1Z1BhdGgsIGZ1bGxQYWdlOiB0cnVlIH0pOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlcnJvcjsKICAgIH0gZmluYWxseSB7CiAgICAgICAgaWYgKHBhZ2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IGNsZWFyU2VhcmNoRmlsdGVyKHBhZ2UpOwogICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDMwMDApKTsKICAgICAgICAgICAgICAgIGF3YWl0IHBhZ2UuY2xvc2UoKTsKICAgICAgICAgICAgfSBjYXRjaCB7fQogICAgICAgIH0KICAgIH0KfTsKCmNvbnN0IGRvd25sb2FkQW5kQW5hbHl6ZUFsbFJhbmdlRGF0YSA9IGFzeW5jIChjdHgsIHdhaXRNc2cpID0+IHsKICAgIGlmICghaXNCcm93c2VyUmVhZHkgfHwgIWJyb3dzZXIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgdGlkYWsgcmVhZHkuIik7CiAgICB9CiAgICAKICAgIGxldCBwYWdlID0gbnVsbDsKICAgIGxldCBhbGxSZXN1bHRzID0gW107CiAgICAKICAgIHRyeSB7CiAgICAgICAgLy8gU3RlcCAxOiBNZW1idWthIGJyb3dzZXIKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csICLwn5SEIE1lbWJ1a2EgaGFsYW1hbiByYW5nZSB0ZXN0Li4uIiwgMSwgMTApOwogICAgICAgIAogICAgICAgIHBhZ2UgPSBhd2FpdCBicm93c2VyLm5ld1BhZ2UoKTsKICAgICAgICAKICAgICAgICBhd2FpdCBwYWdlLnNldERlZmF1bHROYXZpZ2F0aW9uVGltZW91dCgxODAwMDApOwogICAgICAgIGF3YWl0IHBhZ2Uuc2V0RGVmYXVsdFRpbWVvdXQoNjAwMDApOwogICAgICAgIGF3YWl0IHBhZ2Uuc2V0Vmlld3BvcnQoeyB3aWR0aDogMTI4MCwgaGVpZ2h0OiAxMDI0LCBpc01vYmlsZTogZmFsc2UgfSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgdXNlckFnZW50ID0gc2V0dGluZ3MuQ1VSUkVOVF9VU0VSX0FHRU5UOwogICAgICAgIGF3YWl0IHBhZ2Uuc2V0VXNlckFnZW50KHVzZXJBZ2VudCk7CiAgICAgICAgCiAgICAgICAgaWYgKHNldHRpbmdzLkNGX0NMRUFSQU5DRV9WQUxVRSAmJiBzZXR0aW5ncy5JVkFTX1NFU1NJT05fVkFMVUUgJiYgc2V0dGluZ3MuWFNSRl9UT0tFTl9WQUxVRSkgewogICAgICAgICAgICBjb25zdCBjb29raWVzID0gWwogICAgICAgICAgICAgICAgeyBuYW1lOiAnY2ZfY2xlYXJhbmNlJywgdmFsdWU6IHNldHRpbmdzLkNGX0NMRUFSQU5DRV9WQUxVRSwgZG9tYWluOiAnLml2YXNtcy5jb20nIH0sCiAgICAgICAgICAgICAgICB7IG5hbWU6ICdpdmFzX3Ntc19zZXNzaW9uJywgdmFsdWU6IHNldHRpbmdzLklWQVNfU0VTU0lPTl9WQUxVRSwgZG9tYWluOiAnLml2YXNtcy5jb20nIH0sCiAgICAgICAgICAgICAgICB7IG5hbWU6ICdYU1JGLVRPS0VOJywgdmFsdWU6IHNldHRpbmdzLlhTUkZfVE9LRU5fVkFMVUUsIGRvbWFpbjogJy5pdmFzbXMuY29tJyB9CiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGF3YWl0IHBhZ2Uuc2V0Q29va2llKC4uLmNvb2tpZXMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjb25zdCB0YXJnZXRVcmwgPSBSQU5HRV9CQVNFX1VSTDsKICAgICAgICAKICAgICAgICAvLyBTdGVwIDI6IE1lbmdha3NlcyBVUkwKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csIGDwn4yQIE1lbmdha3NlczogJHt0YXJnZXRVcmx9YCwgMiwgMTApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcGFnZS5nb3RvKHRhcmdldFVybCwgewogICAgICAgICAgICB3YWl0VW50aWw6ICduZXR3b3JraWRsZTInLAogICAgICAgICAgICB0aW1lb3V0OiA5MDAwMAogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlc3BvbnNlID8gcmVzcG9uc2Uuc3RhdHVzKCkgOiAnTi9BJzsKICAgICAgICAKICAgICAgICBpZiAoc3RhdHVzID49IDQwMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEhhbGFtYW4gZXJyb3IgZGVuZ2FuIHN0YXR1czogJHtzdGF0dXN9YCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0ZXAgMzogTWVudW5nZ3UgbG9hZAogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgYOKchSBIYWxhbWFuIGJlcmhhc2lsIGRpYWtzZXMuIFN0YXR1czogJHtzdGF0dXN9YCwgMywgMTApOwogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgIuKPsyBNZW51bmdndSBoYWxhbWFuIHNlbGVzYWkgbG9hZC4uLiIsIDQsIDEwKTsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMDApKTsKICAgICAgICAKICAgICAgICAvLyBTdGVwIDQ6IEhhbmRsZSBwb3B1cAogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgIvCfm6HvuI8gTWVuYW5nYW5pIHBvcHVwL3R1dG9yaWFsLi4uIiwgNSwgMTApOwogICAgICAgIGF3YWl0IGhhbmRsZVBvcHVwQW5kVHV0b3JpYWwocGFnZSk7CiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTsKICAgICAgICAKICAgICAgICAvLyBTdGVwIDU6IENsZWFyIGZpbHRlcgogICAgICAgIGF3YWl0IHVwZGF0ZVJhbmdlU3RhdHVzKGN0eCwgd2FpdE1zZywgIvCfp7kgTWVtYmVyc2loa2FuIGZpbHRlciBzZWFyY2guLi4iLCA2LCAxMCk7CiAgICAgICAgYXdhaXQgY2xlYXJTZWFyY2hGaWx0ZXIocGFnZSk7CiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTsKICAgICAgICAKICAgICAgICAvLyBTdGVwIDY6IENhcmkgdGFiZWwKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csICLwn5SNIE1lbmNhcmkgdGFiZWwgZGF0YS4uLiIsIDcsIDEwKTsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNzAwMCkpOwogICAgICAgIAogICAgICAgIGxldCB0YWJsZUZvdW5kID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgcGFnZS53YWl0Rm9yU2VsZWN0b3IoJyNjbGllbnRzbXNoaXN0b3J5LXRhYmxlJywgeyB0aW1lb3V0OiAzMDAwMCB9KTsKICAgICAgICAgICAgdGFibGVGb3VuZCA9IHRydWU7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0YWJsZUZvdW5kID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICghdGFibGVGb3VuZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhYmVsIHRpZGFrIGRpdGVtdWthbi4gSGFsYW1hbiBtdW5na2luIHRpZGFrIGJlcmhhc2lsIGxvYWQuIik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0ZXAgNzogQmFjYSBoYWxhbWFuIDEKICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csICLwn5OKIE1lbWJhY2EgZGF0YSBkYXJpIGhhbGFtYW4gMS4uLiIsIDgsIDEwKTsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNzAwMCkpOwogICAgICAgIAogICAgICAgIGxldCBwYWdlUmVzdWx0cyA9IGF3YWl0IGV4dHJhY3RUYWJsZURhdGFGcm9tUGFnZShwYWdlKTsKICAgICAgICBhbGxSZXN1bHRzID0gWy4uLnBhZ2VSZXN1bHRzXTsKICAgICAgICAKICAgICAgICBpZiAoYWxsUmVzdWx0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaWRhayBhZGEgZGF0YSB5YW5nIGRpdGVtdWthbiB1bnR1ayBhbmFsaXNpcyBzZW11YSByYW5nZS4iKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCBg4pyFIEhhbGFtYW4gMTogJHthbGxSZXN1bHRzLmxlbmd0aH0gZGF0YSBkaXRlbXVrYW5gLCA4LCAxMCk7CiAgICAgICAgCiAgICAgICAgLy8gU3RlcCA4LTEwOiBCYWNhIGhhbGFtYW4gYmVyaWt1dG55YQogICAgICAgIGxldCBwYWdlTnVtYmVyID0gMTsKICAgICAgICBjb25zdCBtYXhQYWdlcyA9IDU7CiAgICAgICAgCiAgICAgICAgd2hpbGUgKHBhZ2VOdW1iZXIgPCBtYXhQYWdlcykgewogICAgICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csIGDij63vuI8gTWVuY29iYSBoYWxhbWFuICR7cGFnZU51bWJlciArIDF9Li4uYCwgOSwgMTApOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGFzTmV4dFBhZ2UgPSBhd2FpdCBjaGVja0FuZENsaWNrTmV4dFBhZ2UocGFnZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWhhc05leHRQYWdlKSB7CiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csIGDwn4+BIFRpZGFrIGFkYSBoYWxhbWFuIGxhZ2kuYCwgMTAsIDEwKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgODAwMCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcGFnZVJlc3VsdHMgPSBhd2FpdCBleHRyYWN0VGFibGVEYXRhRnJvbVBhZ2UocGFnZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocGFnZVJlc3VsdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVSYW5nZVN0YXR1cyhjdHgsIHdhaXRNc2csIGDij7nvuI8gRGF0YSBrb3NvbmcgZGkgaGFsYW1hbiAke3BhZ2VOdW1iZXIgKyAxfS5gLCAxMCwgMTApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG5ld1Jlc3VsdHMgPSBbXTsKICAgICAgICAgICAgcGFnZVJlc3VsdHMuZm9yRWFjaChuZXdJdGVtID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGlzRHVwbGljYXRlID0gYWxsUmVzdWx0cy5zb21lKGV4aXN0aW5nSXRlbSA9PiAKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0l0ZW0uUmFuZ2UgPT09IG5ld0l0ZW0uUmFuZ2UgJiYgCiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdJdGVtLlRlc3ROdW1iZXIgPT09IG5ld0l0ZW0uVGVzdE51bWJlciAmJgogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nSXRlbS5TSUQgPT09IG5ld0l0ZW0uU0lECiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoIWlzRHVwbGljYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3UmVzdWx0cy5wdXNoKG5ld0l0ZW0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChuZXdSZXN1bHRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCBg4o+577iPIFRpZGFrIGFkYSBkYXRhIGJhcnUgZGkgaGFsYW1hbiAke3BhZ2VOdW1iZXIgKyAxfS5gLCAxMCwgMTApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGFsbFJlc3VsdHMucHVzaCguLi5uZXdSZXN1bHRzKTsKICAgICAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCBg8J+TpSBIYWxhbWFuICR7cGFnZU51bWJlciArIDF9OiArJHtuZXdSZXN1bHRzLmxlbmd0aH0gZGF0YSBiYXJ1LCBUb3RhbDogJHthbGxSZXN1bHRzLmxlbmd0aH1gLCAxMCwgMTApOwogICAgICAgICAgICAKICAgICAgICAgICAgcGFnZU51bWJlcisrOwogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDIwMDApKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgdXBkYXRlUmFuZ2VTdGF0dXMoY3R4LCB3YWl0TXNnLCBg4pyFIFRvdGFsICR7YWxsUmVzdWx0cy5sZW5ndGh9IGRhdGEgZGl0ZW11a2FuIGRhcmkgJHtwYWdlTnVtYmVyfSBoYWxhbWFuYCwgMTAsIDEwKTsKICAgICAgICAKICAgICAgICBjb25zdCByZXN1bHQgPSBhbmFseXplUmFuZ2VEYXRhKGFsbFJlc3VsdHMsICdhbGwnLCAnYWxsJyk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW1NUQVRVU10gUmFuZ2UgQ2hlY2sgQWxsIEVycm9yOicsIGVycm9yKTsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgIH0gZmluYWxseSB7CiAgICAgICAgaWYgKHBhZ2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IGNsZWFyU2VhcmNoRmlsdGVyKHBhZ2UpOwogICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDIwMDApKTsKICAgICAgICAgICAgICAgIGF3YWl0IHBhZ2UuY2xvc2UoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1tTVEFUVVNdIEVycm9yIGNsb3NpbmcgcGFnZTonLCBlLm1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKY29uc3QgY2xlYXJTZWFyY2hGaWx0ZXIgPSBhc3luYyAocGFnZSkgPT4gewogICAgdHJ5IHsKICAgICAgICBhd2FpdCBwYWdlLmV2YWx1YXRlKCgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc2VhcmNoSW5wdXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpbnB1dFt0eXBlPSJzZWFyY2giXScpOwogICAgICAgICAgICBpZiAoc2VhcmNoSW5wdXQpIHsKICAgICAgICAgICAgICAgIHNlYXJjaElucHV0LnZhbHVlID0gJyc7CiAgICAgICAgICAgICAgICBjb25zdCBldmVudHMgPSBbJ2lucHV0JywgJ2tleXVwJywgJ2NoYW5nZScsICdzZWFyY2gnXTsKICAgICAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKGV2ID0+IHNlYXJjaElucHV0LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KGV2LCB7IGJ1YmJsZXM6IHRydWUgfSkpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiAkICE9PSAndW5kZWZpbmVkJyAmJiAkLmZuLmRhdGFUYWJsZSkgewogICAgICAgICAgICAgICAgY29uc3QgdGFibGUgPSAkKCcjY2xpZW50c21zaGlzdG9yeS10YWJsZScpLkRhdGFUYWJsZSgpOwogICAgICAgICAgICAgICAgaWYgKHRhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgdGFibGUuc2VhcmNoKCcnKS5kcmF3KCk7CiAgICAgICAgICAgICAgICAgICAgdGFibGUucGFnZSgwKS5kcmF3KCdwYWdlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgYXdhaXQgcGFnZS53YWl0Rm9yVGltZW91dCg0MDAwKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfTsKCmNvbnN0IHNlbmRSYW5nZVJlc3VsdEZpbGUgPSBhc3luYyAoY3R4LCBkYXRhLCBzZXJ2aWNlLCBjb3VudHJ5KSA9PiB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IHJlcG9ydENvbnRlbnQgPSBnZW5lcmF0ZVJhbmdlUmVwb3J0KGRhdGEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIGNvbnN0IGZpbGVOYW1lID0gYHJhbmdlXyR7c2VydmljZX1fJHtjb3VudHJ5fV8ke3RpbWVzdGFtcH0udHh0YDsKICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihURU1QX0RJUiwgZmlsZU5hbWUpOwogICAgICAgIAogICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHJlcG9ydENvbnRlbnQsICd1dGY4Jyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgY2FwdGlvbiA9IGdlbmVyYXRlUmVzdWx0Q2FwdGlvbihkYXRhLCBzZXJ2aWNlLCBjb3VudHJ5KTsKICAgICAgICAKICAgICAgICBhd2FpdCBjdHgucmVwbHlXaXRoRG9jdW1lbnQoCiAgICAgICAgICAgIHsgc291cmNlOiBmaWxlUGF0aCwgZmlsZW5hbWU6IGZpbGVOYW1lIH0sCiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICBjYXB0aW9uOiBjYXB0aW9uLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZTogJ0hUTUwnLAogICAgICAgICAgICAgICAgcmVwbHlfdG9fbWVzc2FnZV9pZDogY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZAogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgICAgICAKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHsKICAgICAgICAgICAgZnMudW5saW5rU3luYyhmaWxlUGF0aCk7CiAgICAgICAgfQogICAgICAgIAogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbU1RBVFVTXSBFcnJvciBzZW5kaW5nIHJhbmdlIHJlc3VsdCBmaWxlOicsIGVycm9yKTsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgIH0KfTsKCmNvbnN0IHNlYXJjaENvdW50cnlJblRhYmxlID0gYXN5bmMgKHBhZ2UsIGNvdW50cnkpID0+IHsKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgcGFnZS53YWl0Rm9yU2VsZWN0b3IoJ2lucHV0W3R5cGU9InNlYXJjaCJdJywgeyB0aW1lb3V0OiAxMDAwMCB9KTsKICAgICAgICBhd2FpdCBwYWdlLmV2YWx1YXRlKGFzeW5jIChzZWFyY2hDb3VudHJ5KSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNlYXJjaElucHV0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaW5wdXRbdHlwZT0ic2VhcmNoIl0nKTsKICAgICAgICAgICAgaWYgKCFzZWFyY2hJbnB1dCkgcmV0dXJuOwogICAgICAgICAgICBzZWFyY2hJbnB1dC5mb2N1cygpOwogICAgICAgICAgICBzZWFyY2hJbnB1dC52YWx1ZSA9ICcnOwogICAgICAgICAgICBzZWFyY2hJbnB1dC52YWx1ZSA9IHNlYXJjaENvdW50cnk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBpbnB1dEV2ZW50ID0gbmV3IEV2ZW50KCdpbnB1dCcsIHsgYnViYmxlczogdHJ1ZSB9KTsKICAgICAgICAgICAgc2VhcmNoSW5wdXQuZGlzcGF0Y2hFdmVudChpbnB1dEV2ZW50KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGtleXVwRXZlbnQgPSBuZXcgRXZlbnQoJ2tleXVwJywgeyBidWJibGVzOiB0cnVlIH0pOwogICAgICAgICAgICBzZWFyY2hJbnB1dC5kaXNwYXRjaEV2ZW50KGtleXVwRXZlbnQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiAkICE9PSAndW5kZWZpbmVkJyAmJiAkLmZuLmRhdGFUYWJsZSkgewogICAgICAgICAgICAgICAgY29uc3QgdGFibGUgPSAkKCcjY2xpZW50c21zaGlzdG9yeS10YWJsZScpLkRhdGFUYWJsZSgpOwogICAgICAgICAgICAgICAgaWYgKHRhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgdGFibGUuc2VhcmNoKHNlYXJjaENvdW50cnkpLmRyYXcoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sIGNvdW50cnkpOwogICAgICAgIAogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA0MDAwKSk7CiAgICAgICAgCiAgICAgICAgY29uc3Qgc2VhcmNoVmFsdWUgPSBhd2FpdCBwYWdlLmV2YWx1YXRlKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpbnB1dFt0eXBlPSJzZWFyY2giXScpOwogICAgICAgICAgICByZXR1cm4gaW5wdXQgPyBpbnB1dC52YWx1ZSA6ICcnOwogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIHJldHVybiBzZWFyY2hWYWx1ZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGNvdW50cnkudG9Mb3dlckNhc2UoKSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tTVEFUVVNdIFNlYXJjaCBjb3VudHJ5IGVycm9yOicsIGVycm9yKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn07Cgpjb25zdCBhbmFseXplUmFuZ2VEYXRhID0gKHJlc3VsdHMsIHNlcnZpY2UsIGNvdW50cnkpID0+IHsKICAgIGNvbnN0IGZyZXF1ZW5jeU1hcCA9IHt9OwogICAgCiAgICByZXN1bHRzLmZvckVhY2gocm93ID0+IHsKICAgICAgICBjb25zdCBjbGVhblJhbmdlID0gcm93LlJhbmdlOwogICAgICAgIGNvbnN0IGNsZWFuU2lkID0gcm93LlNJRDsKICAgICAgICAKICAgICAgICBpZiAoIWNsZWFuUmFuZ2UgfHwgY2xlYW5SYW5nZS5sZW5ndGggPCAzIHx8ICFjbGVhblNpZCkgcmV0dXJuOwogICAgICAgIAogICAgICAgIGNvbnN0IGtleSA9IGAke2NsZWFuUmFuZ2V9fCR7Y2xlYW5TaWR9YDsKICAgICAgICAKICAgICAgICBpZiAoIWZyZXF1ZW5jeU1hcFtrZXldKSB7CiAgICAgICAgICAgIGZyZXF1ZW5jeU1hcFtrZXldID0gewogICAgICAgICAgICAgICAgcmFuZ2U6IGNsZWFuUmFuZ2UsCiAgICAgICAgICAgICAgICBzaWQ6IGNsZWFuU2lkLAogICAgICAgICAgICAgICAgY291bnRyeTogcm93LkNvdW50cnkgfHwgJ1VOS05PV04nLAogICAgICAgICAgICAgICAgY291bnQ6IDAsCiAgICAgICAgICAgICAgICBleGFtcGxlczogW10KICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnJlcXVlbmN5TWFwW2tleV0uY291bnQgKz0gMTsKICAgICAgICAKICAgICAgICBpZiAoZnJlcXVlbmN5TWFwW2tleV0uZXhhbXBsZXMubGVuZ3RoIDwgMyAmJiByb3cuVGVzdE51bWJlcikgewogICAgICAgICAgICBjb25zdCBjbGVhbk51bWJlciA9IHJvdy5UZXN0TnVtYmVyLnJlcGxhY2UoL1teMC05K10vZywgJycpOwogICAgICAgICAgICBpZiAoY2xlYW5OdW1iZXIgJiYgIWZyZXF1ZW5jeU1hcFtrZXldLmV4YW1wbGVzLmluY2x1ZGVzKGNsZWFuTnVtYmVyKSkgewogICAgICAgICAgICAgICAgZnJlcXVlbmN5TWFwW2tleV0uZXhhbXBsZXMucHVzaChjbGVhbk51bWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKICAgIAogICAgY29uc3Qgc2FuZ2F0QmFndXMgPSBbXTsKICAgIGNvbnN0IGJhZ3VzID0gW107CiAgICBjb25zdCBzZWRhbmcgPSBbXTsKICAgIGNvbnN0IHJlbmRhaCA9IFtdOwogICAgCiAgICBPYmplY3QudmFsdWVzKGZyZXF1ZW5jeU1hcCkuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICBpZiAoaXRlbS5jb3VudCA+PSAxMCkgewogICAgICAgICAgICBzYW5nYXRCYWd1cy5wdXNoKGl0ZW0pOwogICAgICAgIH0gZWxzZSBpZiAoaXRlbS5jb3VudCA+PSA1KSB7CiAgICAgICAgICAgIGJhZ3VzLnB1c2goaXRlbSk7CiAgICAgICAgfSBlbHNlIGlmIChpdGVtLmNvdW50ID49IDIpIHsKICAgICAgICAgICAgc2VkYW5nLnB1c2goaXRlbSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVuZGFoLnB1c2goaXRlbSk7CiAgICAgICAgfQogICAgfSk7CiAgICAKICAgIHNhbmdhdEJhZ3VzLnNvcnQoKGEsIGIpID0+IGIuY291bnQgLSBhLmNvdW50KTsKICAgIGJhZ3VzLnNvcnQoKGEsIGIpID0+IGIuY291bnQgLSBhLmNvdW50KTsKICAgIHNlZGFuZy5zb3J0KChhLCBiKSA9PiBiLmNvdW50IC0gYS5jb3VudCk7CiAgICByZW5kYWguc29ydCgoYSwgYikgPT4gYi5jb3VudCAtIGEuY291bnQpOwogICAgCiAgICByZXR1cm4gewogICAgICAgIHNhbmdhdEJhZ3VzLAogICAgICAgIGJhZ3VzLAogICAgICAgIHNlZGFuZywKICAgICAgICByZW5kYWgsCiAgICAgICAgdG90YWxEYXRhOiByZXN1bHRzLmxlbmd0aCwKICAgICAgICBzZXJ2aWNlLAogICAgICAgIGNvdW50cnksCiAgICAgICAgZnJlcXVlbmN5TWFwCiAgICB9Owp9OwoKY29uc3QgZ2VuZXJhdGVSZXN1bHRDYXB0aW9uID0gKGRhdGEsIHNlcnZpY2UsIGNvdW50cnkpID0+IHsKICAgIGNvbnN0IHsgc2FuZ2F0QmFndXMsIGJhZ3VzLCBzZWRhbmcsIHJlbmRhaCwgdG90YWxEYXRhIH0gPSBkYXRhOwogICAgCiAgICBsZXQgY2FwdGlvbiA9ICcnOwogICAgCiAgICBpZiAoc2VydmljZSA9PT0gJ2FsbCcgJiYgY291bnRyeSA9PT0gJ2FsbCcpIHsKICAgICAgICBjYXB0aW9uICs9IGA8YmxvY2txdW90ZT48Yj7wn5OLIEhBU0lMIENFSyBTRU1VQSBSQU5HRTwvYj48L2Jsb2NrcXVvdGU+XG5cbmA7CiAgICB9IGVsc2UgewogICAgICAgIGNhcHRpb24gKz0gYDxibG9ja3F1b3RlPjxiPvCfk4sgSEFTSUwgQ0VLIFJBTkdFICR7c2VydmljZS50b1VwcGVyQ2FzZSgpfSAke2NvdW50cnkudG9VcHBlckNhc2UoKX08L2I+PC9ibG9ja3F1b3RlPlxuXG5gOwogICAgfQogICAgCiAgICBjYXB0aW9uICs9IGDwn5OKIFRvdGFsIDogJHt0b3RhbERhdGF9XG5gOwogICAgY2FwdGlvbiArPSBg4pyFIFJhdGluZyA6XG5gOwogICAgY2FwdGlvbiArPSBg4pSU4pSA8J+folNhbmdhdCBiYWd1cyA6ICR7c2FuZ2F0QmFndXMubGVuZ3RofVxuYDsKICAgIGNhcHRpb24gKz0gYCAgIOKUlOKUgPCfn6FCYWd1cyA6ICR7YmFndXMubGVuZ3RofVxuYDsKICAgIGNhcHRpb24gKz0gYCAgICAgIOKUlOKUgPCfn6BTZWRhbmcgOiAke3NlZGFuZy5sZW5ndGh9XG5gOwogICAgY2FwdGlvbiArPSBgICAgICAgICAg4pSU4pSA8J+UtFJlbmRhaCA6ICR7cmVuZGFoLmxlbmd0aH1cblxuYDsKICAgIAogICAgY2FwdGlvbiArPSBg8J+TgSBGaWxlIGJlcmhhc2lsIGRpYnVhdC5cbmA7CiAgICBjYXB0aW9uICs9IGA8YmxvY2txdW90ZT5DcmVhdGVkIEJ5IEBVc2VycnJfd2FyeHp6PC9ibG9ja3F1b3RlPmA7CiAgICAKICAgIHJldHVybiBjYXB0aW9uOwp9OwoKY29uc3QgZ2VuZXJhdGVSYW5nZVJlcG9ydCA9IChkYXRhKSA9PiB7CiAgICBjb25zdCB7IHNhbmdhdEJhZ3VzLCBiYWd1cywgc2VkYW5nLCByZW5kYWgsIHNlcnZpY2UsIGNvdW50cnksIHRvdGFsRGF0YSB9ID0gZGF0YTsKICAgIAogICAgbGV0IGNvbnRlbnQgPSAnJzsKICAgIAogICAgaWYgKHNlcnZpY2UgPT09ICdhbGwnICYmIGNvdW50cnkgPT09ICdhbGwnKSB7CiAgICAgICAgY29udGVudCArPSBg8J+TiyBIQVNJTCBDRUsgU0VNVUEgUkFOR0VcblxuYDsKICAgIH0gZWxzZSB7CiAgICAgICAgY29udGVudCArPSBg8J+TiyBIQVNJTCBDRUsgUkFOR0UgJHtzZXJ2aWNlLnRvVXBwZXJDYXNlKCl9ICR7Y291bnRyeS50b1VwcGVyQ2FzZSgpfVxuXG5gOwogICAgfQogICAgCiAgICBjb250ZW50ICs9IGDwn5OKIFRvdGFsIERhdGE6ICR7dG90YWxEYXRhfVxuYDsKICAgIGNvbnRlbnQgKz0gYPCfk4ggRGF0YSBVbmlrOiAke3NhbmdhdEJhZ3VzLmxlbmd0aCArIGJhZ3VzLmxlbmd0aCArIHNlZGFuZy5sZW5ndGggKyByZW5kYWgubGVuZ3RofVxuXG5gOwogICAgCiAgICBjb250ZW50ICs9IGDinIUgUmF0aW5nIDpcbmA7CiAgICBjb250ZW50ICs9IGDilJTilIDwn5+iIFNhbmdhdCBCYWd1cyA6ICR7c2FuZ2F0QmFndXMubGVuZ3RofVxuYDsKICAgIGNvbnRlbnQgKz0gYCAgIOKUlOKUgPCfn6EgQmFndXMgOiAke2JhZ3VzLmxlbmd0aH1cbmA7CiAgICBjb250ZW50ICs9IGAgICAgICDilJTilIDwn5+gIFNlZGFuZyA6ICR7c2VkYW5nLmxlbmd0aH1cbmA7CiAgICBjb250ZW50ICs9IGAgICAgICAgICDilJTilIDwn5S0IFJlbmRhaCA6ICR7cmVuZGFoLmxlbmd0aH1cblxuYDsKICAgIAogICAgaWYgKHNhbmdhdEJhZ3VzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb250ZW50ICs9IGBSQVRJTkcgU0FOR0FUIEJBR1VTXG5gOwogICAgICAgIGNvbnRlbnQgKz0gYOKUlOKUgPCfjJBcbmA7CiAgICAgICAgc2FuZ2F0QmFndXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgY29uc3QgZmxhZyA9IGdldENvdW50cnlGbGFnKGl0ZW0uY291bnRyeSk7CiAgICAgICAgICAgIGNvbnRlbnQgKz0gYCAgIOKUlOKUgCAke2ZsYWd9ICR7aXRlbS5yYW5nZX0gKCR7aXRlbS5zaWR9KVxuYDsKICAgICAgICB9KTsKICAgICAgICBjb250ZW50ICs9IGBcbmA7CiAgICB9CiAgICAKICAgIGlmIChiYWd1cy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29udGVudCArPSBgUkFUSU5HIEJBR1VTXG5gOwogICAgICAgIGNvbnRlbnQgKz0gYOKUlOKUgPCfjJBcbmA7CiAgICAgICAgYmFndXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgY29uc3QgZmxhZyA9IGdldENvdW50cnlGbGFnKGl0ZW0uY291bnRyeSk7CiAgICAgICAgICAgIGNvbnRlbnQgKz0gYCAgIOKUlOKUgCAke2ZsYWd9ICR7aXRlbS5yYW5nZX0gKCR7aXRlbS5zaWR9KVxuYDsKICAgICAgICB9KTsKICAgICAgICBjb250ZW50ICs9IGBcbmA7CiAgICB9CiAgICAKICAgIGlmIChzZWRhbmcubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnRlbnQgKz0gYFJBVElORyBTRURBTkdcbmA7CiAgICAgICAgY29udGVudCArPSBg4pSU4pSA8J+MkFxuYDsKICAgICAgICBzZWRhbmcuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgY29uc3QgZmxhZyA9IGdldENvdW50cnlGbGFnKGl0ZW0uY291bnRyeSk7CiAgICAgICAgICAgIGNvbnRlbnQgKz0gYCAgIOKUlOKUgCAke2ZsYWd9ICR7aXRlbS5yYW5nZX0gKCR7aXRlbS5zaWR9KVxuYDsKICAgICAgICB9KTsKICAgICAgICBjb250ZW50ICs9IGBcbmA7CiAgICB9CiAgICAKICAgIGlmIChyZW5kYWgubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnRlbnQgKz0gYFJBVElORyBSRU5EQUhcbmA7CiAgICAgICAgY29udGVudCArPSBg4pSU4pSA8J+MkFxuYDsKICAgICAgICByZW5kYWguZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgY29uc3QgZmxhZyA9IGdldENvdW50cnlGbGFnKGl0ZW0uY291bnRyeSk7CiAgICAgICAgICAgIGNvbnRlbnQgKz0gYCAgIOKUlOKUgCAke2ZsYWd9ICR7aXRlbS5yYW5nZX0gKCR7aXRlbS5zaWR9KVxuYDsKICAgICAgICB9KTsKICAgICAgICBjb250ZW50ICs9IGBcbmA7CiAgICB9CiAgICAKICAgIGNvbnRlbnQgKz0gYFxuQ3JlYXRlZCBCeSBAVXNlcnJyX3dhcnh6elxuYDsKICAgIGNvbnRlbnQgKz0gYEdlbmVyYXRlZDogJHtuZXcgRGF0ZSgpLnRvTG9jYWxlU3RyaW5nKCdpZC1JRCcpfVxuYDsKICAgIAogICAgcmV0dXJuIGNvbnRlbnQ7Cn07Cgpib3QuY29tbWFuZCgnY2VrcmFuZ2UnLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsKICAgIGNvbnN0IGFyZ3MgPSBjdHgubWVzc2FnZS50ZXh0LnNwbGl0KC9ccysvKS5zbGljZSgxKTsKICAgIGNvbnN0IGlucHV0ID0gYXJncy5qb2luKCcgJykudHJpbSgpOwogICAgaWYgKCFpbnB1dCkgewogICAgICAgIHJldHVybiBjdHgucmVwbHlXaXRoSFRNTChgPHByZT7imqDvuI8gQ2FyYSBwZW5nZ3VuYWFuOlxuL2Nla3JhbmdlIHNlcnZpY2UsY291bnRyeVxuL2Nla3JhbmdlIHdoYXRzYXBwLGFsbFxuL2Nla3JhbmdlIGFsbCxpbmRvbmVzaWE8L3ByZT5gLCB7IHJlcGx5X3RvX21lc3NhZ2VfaWQ6IGN0eC5tZXNzYWdlLm1lc3NhZ2VfaWQgfSk7CiAgICB9CiAgICBjb25zdCBwYXJ0cyA9IGlucHV0LnNwbGl0KCcsJyk7CiAgICBpZiAocGFydHMubGVuZ3RoICE9PSAyKSB7CiAgICAgICAgcmV0dXJuIGN0eC5yZXBseVdpdGhIVE1MKGA8cHJlPuKaoO+4jyBGb3JtYXQgc2FsYWhcbkd1bmFrYW4gOiAvY2VrcmFuZ2Ugc2VydmljZSxjb3VudHJ5PC9wcmU+YCwgeyByZXBseV90b19tZXNzYWdlX2lkOiBjdHgubWVzc2FnZS5tZXNzYWdlX2lkIH0pOwogICAgfQogICAgCiAgICBsZXQgc2VydmljZSA9IHBhcnRzWzBdLnRyaW0oKTsKICAgIGxldCBjb3VudHJ5ID0gcGFydHNbMV0udHJpbSgpLnRvTG93ZXJDYXNlKCk7CiAgICAKICAgIGNvbnN0IHNlcnZpY2VNYXAgPSB7CiAgICAgICAgd2hhdHNhcHA6ICdXaGF0c0FwcCcsCiAgICAgICAgZmFjZWJvb2s6ICdmYWNlYm9vaycsCiAgICAgICAgQXBwbGU6ICdhcHBsZScsCiAgICAgICAgR21haWw6ICdnbWFpbCcsCiAgICAgICAgdGlrdG9rOiAndGlrdG9rJywKICAgICAgICBhbGw6ICdhbGwnLAogICAgICAgIFNhbXN1bmc6ICdzYW1zdW5nJywKICAgICAgICB0ZW11OiAndGVtdScsCiAgICAgICAgVmliZXI6ICd2aWJlcicsCiAgICAgICAgdGlrdG9rYWRzOiAndGlrdG9rYWRzJywKICAgICAgICBhbWV4OiAnYW1leCcsCiAgICAgICAgYXV0bXNnOiAnQVVUSE1TRycsCiAgICAgICAgbnhjb21tOiAnbnhjb21tJywKICAgICAgICB0ZWxlZ3JhbTogJ1RlbGVncmFtJywKICAgICAgICBzbXM6ICdzbXMnLAogICAgICAgIFBheXBhbDogJ3BheXBhbCcsCiAgICAgICAgcXNtczogJ1FzbXMnLAogICAgICAgIFViZXI6ICd1YmVyJywKICAgICAgICBNaWNyb3NvZnQ6ICdtaWNyb3NvZnQnLAogICAgfTsKICAgIAogICAgY29uc3Qga2V5ID0gc2VydmljZS50b0xvd2VyQ2FzZSgpOwogICAgc2VydmljZSA9IHNlcnZpY2VNYXBba2V5XSB8fCBzZXJ2aWNlOwoKICAgIGNvbnN0IHdhaXRNc2cgPSBhd2FpdCBjdHgucmVwbHlXaXRoSFRNTCgnPGJsb2NrcXVvdGU+4o+zIDxiPlNlZGFuZyBNZW5nYW5hbGlzaXMgUmFuZ2U8L2I+PC9ibG9ja3F1b3RlPlxuXG5b4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paRXSAwJVxuXG7wn5SEIE1lbXVsYWkgcHJvc2VzLi4uXG5cbvCflZAgPGk+TGFzdCB1cGRhdGUgOiAnICsgbmV3IERhdGUoKS50b0xvY2FsZVRpbWVTdHJpbmcoJ2lkLUlEJykgKyAnPC9pPicsIAogICAgICAgIHsgcmVwbHlfdG9fbWVzc2FnZV9pZDogY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZCB9KTsKCiAgICB0cnkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvd25sb2FkQW5kQW5hbHl6ZVJhbmdlRGF0YShzZXJ2aWNlLCBjb3VudHJ5LCBjdHgsIHdhaXRNc2cpOwoKICAgICAgICBhd2FpdCBzZW5kUmFuZ2VSZXN1bHRGaWxlKGN0eCwgcmVzdWx0LCBzZXJ2aWNlLCBjb3VudHJ5KTsKCiAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5kZWxldGVNZXNzYWdlKGN0eC5jaGF0LmlkLCB3YWl0TXNnLm1lc3NhZ2VfaWQpOyAKICAgICAgICB9IGNhdGNoKGVycikge30KCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGF3YWl0IGhhbmRsZVJhbmdlRXJyb3IoY3R4LCB3YWl0TXNnLCBlcnJvcik7CiAgICB9Cn0pOwoKYm90LmNvbW1hbmQoJ2Nla3JhbmdlYWxsJywgb3duZXJPbmx5LCBhc3luYyAoY3R4KSA9PiB7CiAgICBjb25zdCB3YWl0TXNnID0gYXdhaXQgY3R4LnJlcGx5V2l0aEhUTUwoJzxibG9ja3F1b3RlPuKPsyA8Yj5TZWRhbmcgTWVuZ2FuYWxpc2lzIFJhbmdlPC9iPjwvYmxvY2txdW90ZT5cblxuW+KWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkV0gMCVcblxu8J+UhCBNZW11bGFpIHByb3Nlcy4uLlxuXG7wn5WQIDxpPkxhc3QgdXBkYXRlIDogJyArIG5ldyBEYXRlKCkudG9Mb2NhbGVUaW1lU3RyaW5nKCdpZC1JRCcpICsgJzwvaT4nLAogICAgICAgIHsgcmVwbHlfdG9fbWVzc2FnZV9pZDogY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZCB9KTsKICAgIAogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb3dubG9hZEFuZEFuYWx5emVBbGxSYW5nZURhdGEoY3R4LCB3YWl0TXNnKTsKICAgICAgICAKICAgICAgICBhd2FpdCBzZW5kUmFuZ2VSZXN1bHRGaWxlKGN0eCwgcmVzdWx0LCAnYWxsJywgJ2FsbCcpOwogICAgICAgIAogICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5kZWxldGVNZXNzYWdlKGN0eC5jaGF0LmlkLCB3YWl0TXNnLm1lc3NhZ2VfaWQpLmNhdGNoKCgpID0+IHt9KTsKICAgICAgICAKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgYXdhaXQgaGFuZGxlUmFuZ2VFcnJvcihjdHgsIHdhaXRNc2csIGVycm9yKTsKICAgIH0KfSk7CgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBTVEFUVVMgU1lTVEVNID09PT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgZ2V0Rm9ybWF0dGVkU3RhdHVzID0gKCkgPT4gewogICAgY29uc3QgY2ZTdGF0dXMgPSBzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUgJiYgc2V0dGluZ3MuQ0ZfQ0xFQVJBTkNFX1ZBTFVFLmxlbmd0aCA+IDUgPyAi4pyFIFJlYWR5IiA6ICLinYwgTWlzc2luZyI7CiAgICBjb25zdCBzZXNzaW9uU3RhdHVzID0gc2V0dGluZ3MuSVZBU19TRVNTSU9OX1ZBTFVFICYmIHNldHRpbmdzLklWQVNfU0VTU0lPTl9WQUxVRS5sZW5ndGggPiA1ID8gIuKchSBSZWFkeSIgOiAi4p2MIE1pc3NpbmciOwogICAgY29uc3QgeHNyZlN0YXR1cyA9IHNldHRpbmdzLlhTUkZfVE9LRU5fVkFMVUUgJiYgc2V0dGluZ3MuWFNSRl9UT0tFTl9WQUxVRS5sZW5ndGggPiA1ID8gIuKchSBSZWFkeSIgOiAi4p2MIE1pc3NpbmciOwogICAgY29uc3QgdWFTdGF0dXMgPSBzZXR0aW5ncy5DVVJSRU5UX1VTRVJfQUdFTlQgJiYgc2V0dGluZ3MuQ1VSUkVOVF9VU0VSX0FHRU5ULmxlbmd0aCA+IDIwID8gIuKchSBSZWFkeSIgOiAi4p2MIE1pc3NpbmciOwogICAgY29uc3QgcG9sbGluZ0luZm8gPSBpc1BvbGxpbmdBY3RpdmUgPyBg4pyFIEFjdGl2ZWAgOiBg4p2MIEluYWN0aXZlYDsKICAgIGNvbnN0IGJyb3dzZXJJbmZvID0gaXNCcm93c2VyUmVhZHkgPyBg4pyFIFJlYWR5YCA6IGDinYwgRXJyb3JgOwoKICAgIHJldHVybiBgCkxBU1QgQ0hFQ0sgOiAke2xhc3RDaGVja1RpbWV9ClNUQVRVUyA6ICR7Ym90U3RhdHVzfQpCUk9XU0VSIDogJHticm93c2VySW5mb30KYC50cmltKCk7Cn07Cgpjb25zdCB1cGRhdGVTdGF0dXNNZXNzYWdlID0gYXN5bmMgKGN0eCwgaW5pdGlhbE1lc3NhZ2UgPSBudWxsLCBtZXNzYWdlSWRUb0VkaXQgPSBudWxsKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlID0gZ2V0Rm9ybWF0dGVkU3RhdHVzKCk7CgogICAgY29uc3Qga2V5Ym9hcmQgPSBNYXJrdXAuaW5saW5lS2V5Ym9hcmQoWwogICAgICAgIFtNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCfwn5SEIFJlZnJlc2ggU3RhdHVzJywgJ2NoZWNrX3N0YXR1c19yZWZyZXNoJyldCiAgICBdKTsKCiAgICBjb25zdCBmaW5hbE1lc3NhZ2UgPSBpbml0aWFsTWVzc2FnZSA/IGAke2luaXRpYWxNZXNzYWdlfVxuXG4ke21lc3NhZ2V9YCA6IG1lc3NhZ2U7CgogICAgcmV0dXJuIGVkaXRPclJlcGx5SFRNTChjdHgsIGZpbmFsTWVzc2FnZSwga2V5Ym9hcmQsIG1lc3NhZ2VJZFRvRWRpdCk7Cn07CgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBNRU5VIFNZU1RFTSA9PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3Qgc2VuZE1haW5NZW51ID0gYXN5bmMgKGN0eCwgbWVzc2FnZUlkID0gbnVsbCkgPT4gewogICAgY29uc3QgY29ubmVjdGlvblN0YXR1cyA9IGlzQ29ubmVjdGlvblN0YWJsZSA/ICfinIUgQ29ubmVjdGVkJyA6ICfimqDvuI8gRGlzY29ubmVjdGVkJzsKICAgIGNvbnN0IHBvbGxpbmdTdGF0dXMgPSBpc1BvbGxpbmdBY3RpdmUgPyAn4pyFIEFjdGl2ZScgOiAn4p2MIEluYWN0aXZlJzsKICAgIAogICAgY29uc3QgbWVzc2FnZSA9IGA8YmxvY2txdW90ZT7mg4Xiqrwg6qq2IOOBgiDqq4Lim6cg8J2ZrMy48J2Zls2i8J2Zp82e8J2Zrc2i8J2Zr82e8J2Zr82iIMOXIPCdmYTMuPCdmavNnvCdmZbNovCdmajNnvCdmaLNovCdmagg8J2Yvcy48J2ZpM2e8J2Zqcy48J2Zlc2eIOKbpzwvYmxvY2txdW90ZT4KKCDwn5GkICkgLSDmg4XloLEg8J2XovCdl7nwnZeu8J2XriwK8J2ZrMy48J2Zls2i8J2Zp82e8J2Zrc2i8J2Zr82e8J2Zr82i8J2XqyDilIAg8J2Xp/Cdl7LwnZe58J2XsvCdl7TwnZe/8J2XrvCdl7og44Oc44OD44OI44Gv44CB6YCf44GP5p+U6Luf44Gn5a6J5YWo44Gn7J6Q64+Z7ZmU44OE44O844Or44CC44OH44K444K/44Or44K/44K544Kv44KSLCDrgpjrpbwg7KeA7JuQ7ZWY7Iut7Iuc7JikIS4uLgoK4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCjxibG9ja3F1b3RlPjxiPuKMniDwnZCF8J2QqHIg8J2QmPCdkKh18J2QqyDwnZCI8J2Qp/CdkJ/wnZCocvCdkKbwnZCa8J2QrfCdkKLwnZCo8J2Qp+KMnTwvYj48L2Jsb2NrcXVvdGU+CvCWoIIg4bSEyoDhtIfhtIDhtJvhtI/KgCA6IEBVc2VycnJfd2FyeHp6CvCWoIIg4bSg4bSHyoBzyaogOiDhtKAyLjAuMDEK8JaggiDhtJvKj+G0mOG0hyA6IEphdmFzY3JpcHQgTm9kZWpzCuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgQo8Yj48YmxvY2txdW90ZT7wn5OKIEN1cnJlbnQgU3RhdHVzOjwvYmxvY2txdW90ZT48L2I+CkNvbm5lY3Rpb246ICR7Y29ubmVjdGlvblN0YXR1c30KU01TIFBvbGxpbmc6ICR7cG9sbGluZ1N0YXR1c30KVXNlcjogJHtzZXR0aW5ncy5JVkFTX1VTRVJOQU1FIHx8ICdOb3Qgc2V0J30K4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCgrimJAg4qe9IC9sb2dpbgrimJAg4qe9IC91c2VyYWdlbnQKCuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgQo8YmxvY2txdW90ZT5TaWxha2FuIHBpbGloIG1lbnUgZGkgYmF3YWggaW5pPC9ibG9ja3F1b3RlPmA7CgogICAgY29uc3Qga2V5Ym9hcmQgPSBNYXJrdXAuaW5saW5lS2V5Ym9hcmQoWwogICAgICAgIFsKICAgICAgICAgICAgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygn8J+TiiBTdGF0dXMnLCAnc2hvd19zdGF0dXNfcGFuZWwnKSwKICAgICAgICAgICAgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygn8J+UkSBMb2dpbicsICdzaG93X2xvZ2luX3BhbmVsJykKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygn4pqZ77iPIFNldHRpbmdzJywgJ3Nob3dfc2V0dGluZ3MnKSwKICAgICAgICAgICAgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygn8J+UhCBSZWZyZXNoJywgJ3JlZnJlc2hfbWFpbicpCiAgICAgICAgXQogICAgXSk7CiAgICAKICAgIHJldHVybiBlZGl0T3JSZXBseUhUTUwoY3R4LCBtZXNzYWdlLCBrZXlib2FyZCwgbWVzc2FnZUlkKTsKfTsKCmNvbnN0IHNlbmRTZXR0aW5nc01lbnUgPSBhc3luYyAoY3R4KSA9PiB7CiAgICBjb25zdCBwb2xsaW5nSW5mbyA9IGlzUG9sbGluZ0FjdGl2ZSA/IGDinIUgQWN0aXZlYCA6IGDinYwgSW5hY3RpdmVgOwogICAgY29uc3QgYnJvd3NlckluZm8gPSBpc0Jyb3dzZXJSZWFkeSA/IGDinIUgUmVhZHlgIDogYOKdjCBFcnJvcmA7CiAgICBjb25zdCBtZXNzYWdlSWQgPSBjdHguY2FsbGJhY2tRdWVyeS5tZXNzYWdlLm1lc3NhZ2VfaWQ7CiAgICAKICAgIGNvbnN0IG1lc3NhZ2UgPSBgPGJsb2NrcXVvdGU+5oOF4qq8IOqqtiDjgYIg6quC4punIPCdmazMuPCdmZbNovCdmafNnvCdma3NovCdma/NnvCdma/NoiDDlyDwnZmEzLjwnZmrzZ7wnZmWzaLwnZmozZ7wnZmizaLwnZmoIPCdmL3MuPCdmaTNnvCdmanMuPCdmZXNniDim6c8L2Jsb2NrcXVvdGU+Cigg8J+RpCApIC0g5oOF5aCxIPCdl6LwnZe58J2XrvCdl64sCvCdmazMuPCdmZbNovCdmafNnvCdma3NovCdma/NnvCdma/NovCdl6sg4pSAIPCdl6fwnZey8J2XufCdl7LwnZe08J2Xv/Cdl67wnZe6IOODnOODg+ODiOOBr+OAgemAn+OBj+aflGZsZXhpYmxl44Gn5a6J5YWo44Gq6Ieq5YuV5YyW44OE44O844Or44CC44OH44K444K/44Or44K/44K544Kv44KSLCDrgpjrpbwg7KeA7JuQ7ZWY7Iut7Iuc7JikIS4uLgoK4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCjxibG9ja3F1b3RlPuS5giDwnZem8J2XmPCdl6fwnZen8J2XnPCdl6HwnZea8J2XpiDwnZeg8J2XmPCdl6HwnZeoIOS5gjwvYmxvY2txdW90ZT4K4piQIOKnvSAvY2VrcmFuZ2UK4piQIOKnvSAvY2VrcmFuZ2VhbGwK4piQIOKnvSAvZXhwb3J0bnVtCuKYkCDip70gL3N0YXR1cwrimJAg4qe9IC9jdgrimJAg4qe9IC9sb2dpbgrimJAg4qe9IC91c2VyYWdlbnQK4piQIOKnvSAvYWRkZ3JvdXAK4piQIOKnvSAvbGlzdGdyb3VwCuKYkCDip70gL2RlbGdyb3VwCuKYkCDip70gL3NldG93bmVybGluawrimJAg4qe9IC9zZXRjaG51bWJlcgrimJAg4qe9IC9zZXRjaGFubmVsCuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgS4KCjxibG9ja3F1b3RlPjxiPkRFViA6IEBVc2VycnJfd2FyeHp6PC9iPjwvYmxvY2txdW90ZT5gOyAKCiAgICBjb25zdCBrZXlib2FyZCA9IE1hcmt1cC5pbmxpbmVLZXlib2FyZChbCiAgICAgICAgWwogICAgICAgICAgICBNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCfwn5SZIEJhY2snLCAnbWFpbl9tZW51JykKICAgICAgICBdCiAgICBdKTsKCiAgICByZXR1cm4gZWRpdE9yUmVwbHlIVE1MKGN0eCwgbWVzc2FnZSwga2V5Ym9hcmQsIG1lc3NhZ2VJZCk7Cn07Cgpjb25zdCBzZW5kU3RhdHVzUGFuZWxNZW51ID0gYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgbWVzc2FnZUlkID0gY3R4LmNhbGxiYWNrUXVlcnkubWVzc2FnZS5tZXNzYWdlX2lkOwogICAgY29uc3QgcG9sbGluZ0luZm8gPSBpc1BvbGxpbmdBY3RpdmUgPyBg4pyFIEFjdGl2ZWAgOiBg4p2MIEluYWN0aXZlYDsKICAgIGNvbnN0IGJyb3dzZXJJbmZvID0gaXNCcm93c2VyUmVhZHkgPyBg4pyFIFJlYWR5YCA6IGDinYwgRXJyb3JgOwoKICAgIGNvbnN0IG1lc3NhZ2UgPSBgPGJsb2NrcXVvdGU+5oOF4qq8IOqqtiDjgYIg6quC4punIPCdmazMuPCdmZbNovCdmafNnvCdma3NovCdma/NnvCdma/NoiDDlyDwnZmEzLjwnZmrzZ7wnZmWzaLwnZmozZ7wnZmizaLwnZmoIPCdmL3MuPCdmaTNnvCdmanMuPCdmZXNniDim6c8L2Jsb2NrcXVvdGU+Cigg8J+RpCApIC0g5oOF5aCxIPCdl6LwnZe58J2XrvCdl64sCvCdmazMuPCdmZbNovCdmafNnvCdma3NovCdma/NnvCdma/NovCdl6sg4pSAIPCdl6fwnZey8J2XufCdl7LwnZe08J2Xv/Cdl67wnZe6IOODnOODg+ODiOOBr+OAgemAn+OBj+aflGZsZXhpYmxl44Gn5a6J5YWo44Gq6Ieq5YuV5YyW44OE44O844Or44CC44OH44K444K/44Or44K/44K544Kv44KSLCDrgpjrpbwg7KeA7JuQ7ZWY7Iut7Iuc7JikIS4uLgoK4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCjxibG9ja3F1b3RlPjxiPvCdl5XwnZei8J2XpyDwnZem8J2Xp/Cdl5TwnZen8J2XqPCdl6Y8L2I+PC9ibG9ja3F1b3RlPgrwlqCCIFN0YXR1cyA6ICR7Ym90U3RhdHVzfQrwlqCCIEJyb3dzZXIgOiAke2Jyb3dzZXJJbmZvfQrwlqCCIExpdmUgU21zIDogJHtwb2xsaW5nSW5mb30K4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCjxibG9ja3F1b3RlPuS5giDwnZem8J2Xp/Cdl5TwnZen8J2XqPCdl6Yg8J2XoPCdl5jwnZeh8J2XqCDkuYI8L2Jsb2NrcXVvdGU+CuKYkCDip70gL3N0YXRpc3RpYwrimJAg4qe9IC9zdGF0dXMK4piQIOKnvSAvdmlld3NtcwrimJAg4qe9IC9zc3VybArimJAg4qe9IC9teW51bQrimJAg4qe9IC9iYWxhbmNlCuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgQoKPGJsb2NrcXVvdGU+PGI+REVWIDogQFVzZXJycl93YXJ4eno8L2I+PC9ibG9ja3F1b3RlPmA7IAoKICAgIGNvbnN0IGtleWJvYXJkID0gTWFya3VwLmlubGluZUtleWJvYXJkKFsKICAgICAgICBbCiAgICAgICAgICAgIE1hcmt1cC5idXR0b24uY2FsbGJhY2soJ/CflJkgQmFjaycsICdtYWluX21lbnUnKQogICAgICAgIF0KICAgIF0pOwoKICAgIHJldHVybiBlZGl0T3JSZXBseUhUTUwoY3R4LCBtZXNzYWdlLCBrZXlib2FyZCwgbWVzc2FnZUlkKTsKfTsKCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09IENPTU1BTkQgSEFORExFUlMgPT09PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpib3QuY29tbWFuZCgnc3RhcnQnLCAoY3R4KSA9PiB7CiAgICBpZiAoY3R4LmZyb20uaWQgPT09IE9XTkVSX0lEKSBzZW5kTWFpbk1lbnUoY3R4KTsKICAgIGVsc2UgY3R4LnJlcGx5KCLwn6SWIEJvdCBpcyBPbmxpbmUiKTsKfSk7Cgpib3QuY29tbWFuZCgnc3RhdHVzJywgb3duZXJPbmx5LCBhc3luYyAoY3R4KSA9PiB7CiAgICBjb25zdCBzdGF0dXNUZXh0ID0gZ2V0Rm9ybWF0dGVkU3RhdHVzKCk7CiAgICBhd2FpdCByZXBseUhUTUwoY3R4LCBzdGF0dXNUZXh0KTsKfSk7Cgpib3QuY29tbWFuZCgnbG9naW4nLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsKICAgIGNvbnN0IHVzZXJJZCA9IGN0eC5mcm9tLmlkOwogICAgCiAgICAvLyBSZXNldCBzdGF0ZSBzZWJlbHVtbnlhCiAgICByZXNldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgCiAgICBjb25zdCBjdXJyZW50VXNlciA9IHNldHRpbmdzLklWQVNfVVNFUk5BTUUgfHwgJ05vdCBzZXQnOwogICAgY29uc3QgaGFzQ0YgPSBzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUgJiYgc2V0dGluZ3MuQ0ZfQ0xFQVJBTkNFX1ZBTFVFLmxlbmd0aCA+IDEwOwogICAgCiAgICBjb25zdCBtZXNzYWdlID0gYDxibG9ja3F1b3RlPvCflJEgTE9HSU4gTUFOQUdFTUVOVDwvYmxvY2txdW90ZT4K4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCjxiPkN1cnJlbnQgU3RhdHVzOjwvYj4K8J+RpCBVc2VybmFtZTogJHtjdXJyZW50VXNlcn0K8J+NqiBDRiBDbGVhcmFuY2U6ICR7aGFzQ0YgPyAn4pyFIFNldCcgOiAn4p2MIE5vdCBzZXQnfQrilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIEKPGI+T3B0aW9uczo8L2I+CjEuIDxiPkZ1bGwgTG9naW48L2I+IC0gTWFzdWtrYW4gdXNlcm5hbWUvcGFzc3dvcmQvY2ZfY2xlYXJhbmNlCjIuIDxiPlVwZGF0ZSBDRiBPbmx5PC9iPiAtIEhhbnlhIHVwZGF0ZSBjb29raWUKMy4gPGI+UmVzZXQgQWxsPC9iPiAtIEhhcHVzIHNlbXVhIGRhdGEgbG9naW4KNC4gPGI+VHJ5IENvbm5lY3Q8L2I+IC0gQ29iYSBrb25la3NpIGRlbmdhbiBkYXRhIHNhYXQgaW5pCuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgQo8YmxvY2txdW90ZT5QaWxpaCBzYWxhaCBzYXR1OjwvYmxvY2txdW90ZT5gOwoKICAgIGNvbnN0IGtleWJvYXJkID0gTWFya3VwLmlubGluZUtleWJvYXJkKFsKICAgICAgICBbCiAgICAgICAgICAgIE1hcmt1cC5idXR0b24uY2FsbGJhY2soJ/CflJEgRnVsbCBMb2dpbicsICdsb2dpbl9mdWxsJyksCiAgICAgICAgICAgIE1hcmt1cC5idXR0b24uY2FsbGJhY2soJ/CfjaogVXBkYXRlIENGJywgJ2xvZ2luX2NmX29ubHknKQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICBNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCfwn5SEIFJlc2V0IEFsbCcsICdsb2dpbl9yZXNldF9hbGwnKSwKICAgICAgICAgICAgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygn8J+UjCBUcnkgQ29ubmVjdCcsICdsb2dpbl90cnlfY29ubmVjdCcpCiAgICAgICAgXQogICAgXSk7CiAgICAKICAgIGNvbnN0IHNlbnRNc2cgPSBhd2FpdCBjdHgucmVwbHlXaXRoSFRNTChtZXNzYWdlLCB7IAogICAgICAgIHJlcGx5X3RvX21lc3NhZ2VfaWQ6IGN0eC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgcmVwbHlfbWFya3VwOiBrZXlib2FyZC5yZXBseV9tYXJrdXAgCiAgICB9KTsKICAgIAogICAgc2V0VXNlclN0YXRlKHVzZXJJZCwgJ0xPR0lOJywgewogICAgICAgIG1lc3NhZ2VJZDogc2VudE1zZy5tZXNzYWdlX2lkLAogICAgICAgIGNoYXRJZDogY3R4LmNoYXQuaWQsCiAgICAgICAgbG9naW5TdGVwOiAnJywKICAgICAgICBsb2dpbkRhdGE6IHt9CiAgICB9KTsKfSk7Cgpib3QuY29tbWFuZCgndXNlcmFnZW50Jywgb3duZXJPbmx5LCBhc3luYyAoY3R4KSA9PiB7CiAgICBjb25zdCB1c2VySWQgPSBjdHguZnJvbS5pZDsKICAgIAogICAgcmVzZXRVc2VyU3RhdGUodXNlcklkKTsKICAgIAogICAgY29uc3QgY3VycmVudFVBID0gc2V0dGluZ3MuQ1VSUkVOVF9VU0VSX0FHRU5UIHx8ICdCZWx1bSBkaWF0dXInOwogICAgY29uc3Qgc2hvcnRVQSA9IGN1cnJlbnRVQS5sZW5ndGggPiA1MCA/IGN1cnJlbnRVQS5zdWJzdHJpbmcoMCwgNTApICsgJy4uLicgOiBjdXJyZW50VUE7CgogICAgY29uc3Qgc2VudE1lc3NhZ2UgPSBhd2FpdCBjdHgucmVwbHlXaXRoSFRNTCgKICAgICAgICBgPHByZT7wn5K7IFVwZGF0ZSBVc2VyIEFnZW50PC9wcmU+XG5cbmAgKwogICAgICAgIGDwn5OxIDxiPlVzZXIgQWdlbnQgc2FhdCBpbmk6PC9iPlxuPGNvZGU+JHtzaG9ydFVBfTwvY29kZT5cblxuYCArCiAgICAgICAgYPCfk50gPGI+S2lyaW0gVXNlciBBZ2VudCBiYXJ1IChtaW5pbWFsIDIwIGthcmFrdGVyKTo8L2I+YCwKICAgICAgICB7IHJlcGx5X3RvX21lc3NhZ2VfaWQ6IGN0eC5tZXNzYWdlPy5tZXNzYWdlX2lkIH0KICAgICk7CgogICAgc2V0VXNlclN0YXRlKHVzZXJJZCwgJ1VTRVJfQUdFTlQnLCB7CiAgICAgICAgbWVzc2FnZUlkOiBzZW50TWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgIGNoYXRJZDogY3R4LmNoYXQuaWQKICAgIH0pOwp9KTsKCmJvdC5jb21tYW5kKCdzc3dlYicsIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4geyAgICAKICAgIGF3YWl0IHRha2VEYXNoYm9hcmRTY3JlZW5zaG90KGN0eCk7Cn0pOwoKYm90LmNvbW1hbmQoJ3ZpZXdzbXMnLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsgICAgCiAgICBhd2FpdCB0YWtlTGl2ZVNtc1NjcmVlbnNob3QoY3R4KTsKfSk7Cgpib3QuY29tbWFuZCgnc3N1cmwnLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsKICAgIGNvbnN0IGFyZ3MgPSBjdHgubWVzc2FnZS50ZXh0LnNwbGl0KC9ccysvKS5zbGljZSgxKTsKICAgIGNvbnN0IHVybCA9IGFyZ3NbMF07CiAgICAKICAgIGlmICghdXJsKSB7CiAgICAgICAgYXdhaXQgcmVwbHlIVE1MKGN0eCwgCiAgICAgICAgICAgIGA8cHJlPkVycm9yXG5cbmd1bmFrYW4gOiAvc3N1cmwgaHR0cHM6Ly9leGFtcGxlLmNvbVxuQ29udG9oIDogL3NzdXJsIGh0dHBzOi8vd3d3Lmdvb2dsZS5jb21cbi9zc3VybCBodHRwczovL3d3dy5pdmFzbXMuY29tPC9wcmU+YAogICAgICAgICk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICAvLyBWYWxpZGFzaSBVUkwgZGFzYXIKICAgIGlmICghdXJsLnN0YXJ0c1dpdGgoJ2h0dHA6Ly8nKSAmJiAhdXJsLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHsKICAgICAgICBhd2FpdCByZXBseUhUTUwoY3R4LCAKICAgICAgICAgICAgYDxwcmU+RXJyb3JcblxuVVJMIGhhcnVzIGRpYXdhbGkgZGVuZ2FuIGh0dHA6Ly8gYXRhdSBodHRwczovL1xuQ29udG9oIDogL3NzdXJsIGh0dHBzOi8vd3d3LmV4YW1wbGUuY29tPC9wcmU+YAogICAgICAgICk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICAKICAgIGF3YWl0IHRha2VNYWNib29rU2NyZWVuc2hvdChjdHgsIHVybCk7Cn0pOwoKCmNvbnN0IHNhdmVTZXR0aW5ncyA9IChuZXdTZXR0aW5ncykgPT4gewogICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnc2V0dGluZ3MuanMnKTsKICAgIGNvbnN0IGNvbnRlbnQgPSBgbW9kdWxlLmV4cG9ydHMgPSAke0pTT04uc3RyaW5naWZ5KG5ld1NldHRpbmdzLCBudWxsLCA0KX07YDsKICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIGNvbnRlbnQpOwp9OwoKLy8gMS4gQ09NTUFORCAvYWRkZ3JvdXAKYm90LmNvbW1hbmQoJ2FkZGdyb3VwJywgKGN0eCkgPT4gewogICAgY29uc3QgYm90VXNlcm5hbWUgPSBjdHguYm90SW5mby51c2VybmFtZTsKICAgIGNvbnN0IGludml0ZUxpbmsgPSBgaHR0cHM6Ly90Lm1lLyR7Ym90VXNlcm5hbWV9P3N0YXJ0Z3JvdXA9bmV3YDsKICAgIAogICAgY3R4LnJlcGx5KGBTaWxha2FuIGtsaWsgdG9tYm9sIGRpIGJhd2FoIHVudHVrIG1lbmFtYmFoa2FuIGdydXAga2UgZGFsYW0gYm90LlxuXG5TZXRlbGFoIGRpdGFtYmFoa2FuLCBJRCBncnVwIGFrYW4gb3RvbWF0aXMgdGVyc2ltcGFuLmAsIHsKICAgICAgICByZXBseV9tYXJrdXA6IHsKICAgICAgICAgICAgaW5saW5lX2tleWJvYXJkOiBbCiAgICAgICAgICAgICAgICBbeyB0ZXh0OiAi4p6VIFBpbGloIEdydXAiLCB1cmw6IGludml0ZUxpbmsgfV0KICAgICAgICAgICAgXQogICAgICAgIH0KICAgIH0pOwp9KTsKCi8vIExpc3RlbmVyIHNhYXQgYm90IG1hc3VrIGtlIGdydXAgYmFydSAoT3RvbWF0aXMgYW1iaWwgSUQpCmJvdC5vbignbmV3X2NoYXRfbWVtYmVycycsIGFzeW5jIChjdHgpID0+IHsKICAgIGNvbnN0IGJvdElkID0gY3R4LmJvdEluZm8uaWQ7CiAgICBjb25zdCBpc0JvdEFkZGVkID0gY3R4Lm1lc3NhZ2UubmV3X2NoYXRfbWVtYmVycy5zb21lKG1lbWJlciA9PiBtZW1iZXIuaWQgPT09IGJvdElkKTsKCiAgICBpZiAoaXNCb3RBZGRlZCkgewogICAgICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW3JlcXVpcmUucmVzb2x2ZSgnLi9zZXR0aW5ncy5qcycpXTsKICAgICAgICBsZXQgc2V0dGluZ3MgPSByZXF1aXJlKCcuL3NldHRpbmdzLmpzJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgY2hhdElkID0gY3R4LmNoYXQuaWQ7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHNldHRpbmdzLkNIQVRfSUQpKSB7CiAgICAgICAgICAgIHNldHRpbmdzLkNIQVRfSUQgPSBbc2V0dGluZ3MuQ0hBVF9JRF07CiAgICAgICAgfQoKICAgICAgICBpZiAoIXNldHRpbmdzLkNIQVRfSUQuaW5jbHVkZXMoY2hhdElkKSkgewogICAgICAgICAgICBzZXR0aW5ncy5DSEFUX0lELnB1c2goY2hhdElkKTsKICAgICAgICAgICAgc2F2ZVNldHRpbmdzKHNldHRpbmdzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5yZXBseShg4pyFIEdydXAgIiR7Y3R4LmNoYXQudGl0bGV9IiBiZXJoYXNpbCBkaWRhZnRhcmthbiFcbklEOiA8Y29kZT4ke2NoYXRJZH08L2NvZGU+YCwgeyBwYXJzZV9tb2RlOiAnSFRNTCcgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBLaXJpbSBub3RpZmlrYXNpIGtlIG93bmVyCiAgICAgICAgICAgIGJvdC50ZWxlZ3JhbS5zZW5kTWVzc2FnZShzZXR0aW5ncy5PV05FUl9JRCwgYPCfk6IgR3J1cCBCYXJ1IERpdGFtYmFoa2FuOlxuTmFtYTogJHtjdHguY2hhdC50aXRsZX1cbklEOiAke2NoYXRJZH1gKTsKICAgICAgICB9CiAgICB9Cn0pOwoKLy8gMi4gQ09NTUFORCAvbGlzdGdyb3VwCmJvdC5jb21tYW5kKCdsaXN0Z3JvdXAnLCBhc3luYyAoY3R4KSA9PiB7CiAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVtyZXF1aXJlLnJlc29sdmUoJy4vc2V0dGluZ3MuanMnKV07CiAgICBjb25zdCBzZXR0aW5ncyA9IHJlcXVpcmUoJy4vc2V0dGluZ3MuanMnKTsKICAgIGNvbnN0IGNoYXRJZHMgPSBBcnJheS5pc0FycmF5KHNldHRpbmdzLkNIQVRfSUQpID8gc2V0dGluZ3MuQ0hBVF9JRCA6IFtzZXR0aW5ncy5DSEFUX0lEXTsKICAgIAogICAgaWYgKGNoYXRJZHMubGVuZ3RoID09PSAwKSByZXR1cm4gY3R4LnJlcGx5KCJCZWx1bSBhZGEgZ3J1cCB5YW5nIHRlcmRhZnRhci4iKTsKCiAgICBsZXQgbWVzc2FnZSA9IGA8YmxvY2txdW90ZT4ke3NldHRpbmdzLlBST0pFQ1RfTkFNRX08L2Jsb2NrcXVvdGU+XG5cbmA7CiAgICAKICAgIGZvciAoY29uc3QgaWQgb2YgY2hhdElkcykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGNoYXQgPSBhd2FpdCBib3QudGVsZWdyYW0uZ2V0Q2hhdChpZCk7CiAgICAgICAgICAgIG1lc3NhZ2UgKz0gYDxiPiR7Y2hhdC50aXRsZX08L2I+XG48Y29kZT4ke2lkfTwvY29kZT5cblxuYDsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIG1lc3NhZ2UgKz0gYDxiPkdydXAgVGlkYWsgRGlrZW5hbDwvYj5cbjxjb2RlPiR7aWR9PC9jb2RlPiAoQm90IG11bmdraW4gZGlrZWx1YXJrYW4pXG5cbmA7CiAgICAgICAgfQogICAgfQoKICAgIGN0eC5yZXBseShtZXNzYWdlLCB7IHBhcnNlX21vZGU6ICdIVE1MJyB9KTsKfSk7CgovLyAzLiBDT01NQU5EIC9kZWxncm91cCA8aWQ+CmJvdC5jb21tYW5kKCdkZWxncm91cCcsIGFzeW5jIChjdHgpID0+IHsKICAgIGNvbnN0IGlucHV0SWQgPSBjdHgubWVzc2FnZS50ZXh0LnNwbGl0KCcgJylbMV07CiAgICBpZiAoIWlucHV0SWQpIHJldHVybiBjdHgucmVwbHkoIkZvcm1hdDogL2RlbGdyb3VwIC0xMDB4eHh4eHh4Iik7CgogICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVxdWlyZS5yZXNvbHZlKCcuL3NldHRpbmdzLmpzJyldOwogICAgbGV0IHNldHRpbmdzID0gcmVxdWlyZSgnLi9zZXR0aW5ncy5qcycpOwogICAgY29uc3QgdGFyZ2V0SWQgPSBwYXJzZUludChpbnB1dElkKTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShzZXR0aW5ncy5DSEFUX0lEKSAmJiBzZXR0aW5ncy5DSEFUX0lELmluY2x1ZGVzKHRhcmdldElkKSkgewogICAgICAgIC8vIEhhcHVzIGRhcmkgYXJyYXkKICAgICAgICBzZXR0aW5ncy5DSEFUX0lEID0gc2V0dGluZ3MuQ0hBVF9JRC5maWx0ZXIoaWQgPT4gaWQgIT09IHRhcmdldElkKTsKICAgICAgICBzYXZlU2V0dGluZ3Moc2V0dGluZ3MpOwoKICAgICAgICAvLyBCb3Qga2VsdWFyIGRhcmkgZ3J1cAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGJvdC50ZWxlZ3JhbS5sZWF2ZUNoYXQodGFyZ2V0SWQpOwogICAgICAgICAgICBjdHgucmVwbHkoYOKchSBCZXJoYXNpbCBtZW5naGFwdXMgZ3J1cCAke3RhcmdldElkfSBkYW4gYm90IHRlbGFoIGtlbHVhci5gKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGN0eC5yZXBseShg4pyFIElEIGRpaGFwdXMgZGFyaSBzZXR0aW5ncywgdGFwaSBib3QgZ2FnYWwga2VsdWFyIGdydXAgb3RvbWF0aXMgKE11bmdraW4gYm90IHN1ZGFoIHRpZGFrIGRpIHNhbmEpLmApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY3R4LnJlcGx5KCLinYwgSUQgR3J1cCB0aWRhayBkaXRlbXVrYW4gZGkgZGFmdGFyLiIpOwogICAgfQp9KTsKCi8vIEdhbnRpIGRlbmdhbiBtZW5nZ3VuYWthbiB1cGRhdGVTZXR0aW5nU2lsZW50IHlhbmcgc3VkYWggYWRhCmJvdC5jb21tYW5kKCdzZXRjaGFubmVsJywgb3duZXJPbmx5LCAoY3R4KSA9PiB7CiAgICBjb25zdCBsaW5rID0gY3R4Lm1lc3NhZ2UudGV4dC5zcGxpdCgnICcpWzFdOwogICAgaWYgKCFsaW5rKSByZXR1cm4gY3R4LnJlcGx5KCdGb3JtYXQ6IC9zZXRjaGFubmVsIDxsaW5rPicpOwogICAgCiAgICBpZiAodXBkYXRlU2V0dGluZ1NpbGVudCgnTUFJTl9DSEFOTkVMX0xJTksnLCBsaW5rKSkgewogICAgICAgIGN0eC5yZXBseShg4pyFIE1BSU5fQ0hBTk5FTF9MSU5LIHVwZGF0ZWQ6ICR7bGlua31gKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY3R4LnJlcGx5KCfinYwgR2FnYWwgdXBkYXRlIHNldHRpbmcnKTsKICAgIH0KfSk7Cgpib3QuY29tbWFuZCgnc2V0Y2hudW1iZXInLCBvd25lck9ubHksIChjdHgpID0+IHsKICAgIGNvbnN0IGxpbmsgPSBjdHgubWVzc2FnZS50ZXh0LnNwbGl0KCcgJylbMV07CiAgICBpZiAoIWxpbmspIHJldHVybiBjdHgucmVwbHkoJ0Zvcm1hdDogL3NldGNobnVtYmVyIDxsaW5rPicpOwoKICAgIGlmICh1cGRhdGVTZXR0aW5nU2lsZW50KCdOVU1CRVJfR1JPVVBfTElOSycsIGxpbmspKSB7CiAgICAgICAgY3R4LnJlcGx5KGDinIUgTlVNQkVSX0dST1VQX0xJTksgdXBkYXRlZDogJHtsaW5rfWApOwogICAgfSBlbHNlIHsKICAgICAgICBjdHgucmVwbHkoJ+KdjCBHYWdhbCB1cGRhdGUgc2V0dGluZycpOwogICAgfQp9KTsKCmJvdC5jb21tYW5kKCdzZXRvd25lcmxpbmsnLCBvd25lck9ubHksIChjdHgpID0+IHsKICAgIGNvbnN0IGxpbmsgPSBjdHgubWVzc2FnZS50ZXh0LnNwbGl0KCcgJylbMV07CiAgICBpZiAoIWxpbmspIHJldHVybiBjdHgucmVwbHkoJ0Zvcm1hdDogL3NldG93bmVybGluayA8bGluaz4nKTsKCiAgICBpZiAodXBkYXRlU2V0dGluZ1NpbGVudCgnQk9UX09XTkVSX0xJTksnLCBsaW5rKSkgewogICAgICAgIGN0eC5yZXBseShg4pyFIEJPVF9PV05FUl9MSU5LIHVwZGF0ZWQ6ICR7bGlua31gKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY3R4LnJlcGx5KCfinYwgR2FnYWwgdXBkYXRlIHNldHRpbmcnKTsKICAgIH0KfSk7CgoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gQUNUSU9OIEhBTkRMRVJTID09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmJvdC5hY3Rpb24oJ21haW5fbWVudScsIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgbWVzc2FnZUlkID0gY3R4LmNhbGxiYWNrUXVlcnkubWVzc2FnZS5tZXNzYWdlX2lkOwogICAgYXdhaXQgc2VuZE1haW5NZW51KGN0eCwgbWVzc2FnZUlkKTsKfSk7Cgpib3QuYWN0aW9uKCdzaG93X3NldHRpbmdzJywgb3duZXJPbmx5LCBzZW5kU2V0dGluZ3NNZW51KTsKYm90LmFjdGlvbignc2hvd19zdGF0dXNfcGFuZWwnLCBvd25lck9ubHksIHNlbmRTdGF0dXNQYW5lbE1lbnUpOwpib3QuYWN0aW9uKCdyZWZyZXNoX21haW4nLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsKICAgIGF3YWl0IGN0eC5hbnN3ZXJDYlF1ZXJ5KCdSZWZyZXNoaW5nLi4uJyk7CiAgICBjb25zdCBtZXNzYWdlSWQgPSBjdHguY2FsbGJhY2tRdWVyeS5tZXNzYWdlLm1lc3NhZ2VfaWQ7CiAgICBhd2FpdCBzZW5kTWFpbk1lbnUoY3R4LCBtZXNzYWdlSWQpOwp9KTsKCmJvdC5hY3Rpb24oJ2NoZWNrX3N0YXR1c19yZWZyZXNoJywgb3duZXJPbmx5LCBhc3luYyAoY3R4KSA9PiB7CiAgICBhd2FpdCBjdHguYW5zd2VyQ2JRdWVyeSgiTWVsYWt1a2FuIEZvcmNlZCBDaGVjayBkYW4gdXBkYXRlIHN0YXR1cy4uLiIpOwogICAgY29uc3QgbWVzc2FnZUlkID0gY3R4LmNhbGxiYWNrUXVlcnkubWVzc2FnZS5tZXNzYWdlX2lkOwogICAgdHJ5IHsgYXdhaXQgY3R4LnRlbGVncmFtLmVkaXRNZXNzYWdlVGV4dChjdHguY2hhdC5pZCwgbWVzc2FnZUlkLCBudWxsLCAn4o+zIE1lbGFrdWthbiBGb3JjZWQgQ2hlY2sgc3RhdHVzIGtvbmVrc2kuLi4nLCB7IHBhcnNlX21vZGU6ICdIVE1MJyB9KTsgfSBjYXRjaChlKSB7fQoKICAgIGF3YWl0IGNvbm5lY3RSb2J1c3RMaXZlU21zKCk7CiAgICBhd2FpdCB1cGRhdGVTdGF0dXNNZXNzYWdlKGN0eCwgbnVsbCwgbWVzc2FnZUlkKTsKfSk7CmJvdC5hY3Rpb24oJ2xvZ2luX2Z1bGwnLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsKICAgIGNvbnN0IHVzZXJJZCA9IGN0eC5mcm9tLmlkOwogICAgbGV0IHN0YXRlID0gZ2V0VXNlclN0YXRlKHVzZXJJZCk7CiAgICAKICAgIC8vIEppa2Egc3RhdGUgdGlkYWsgYWRhIGF0YXUgYnVrYW4gdHlwZSBMT0dJTiwgYnVhdCBiYXJ1CiAgICBpZiAoIXN0YXRlIHx8IHN0YXRlLnR5cGUgIT09ICdMT0dJTicpIHsKICAgICAgICBjb25zdCBzZW50TXNnID0gYXdhaXQgY3R4LnJlcGx5V2l0aEhUTUwoYDxwcmU+8J+UkSBGVUxMIExPR0lOIFNFVFVQPC9wcmU+XG5cbvCflIQgTWVtdWxhaSBwcm9zZXMgbG9naW4uLi5gKTsKICAgICAgICBzdGF0ZSA9IHNldFVzZXJTdGF0ZSh1c2VySWQsICdMT0dJTicsIHsKICAgICAgICAgICAgbWVzc2FnZUlkOiBzZW50TXNnLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIGNoYXRJZDogY3R4LmNoYXQuaWQsCiAgICAgICAgICAgIGxvZ2luU3RlcDogJ3VzZXJuYW1lJywKICAgICAgICAgICAgbG9naW5EYXRhOiB7fQogICAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBzdGF0ZS5kYXRhLmxvZ2luU3RlcCA9ICd1c2VybmFtZSc7CiAgICAgICAgc3RhdGUuZGF0YS5sb2dpbkRhdGEgPSB7fTsKICAgICAgICBzdGF0ZS5zdGVwID0gJ2F3YWl0aW5nX2lucHV0JzsKICAgIH0KICAgIAogICAgYXdhaXQgY3R4LmFuc3dlckNiUXVlcnkoJ1N0YXJ0aW5nIGZ1bGwgbG9naW4gcHJvY2Vzcy4uLicpOwogICAgCiAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBzdGF0ZS5kYXRhLm1lc3NhZ2VJZCwgCiAgICAgICAgYDxwcmU+8J+UkSBGVUxMIExPR0lOIFNFVFVQPC9wcmU+XG5cbuKame+4jyA8Yj5TdGF0dXM6PC9iPiBNZW51bmdndSBpbnB1dC4uLlxu8J+TpyA8Yj5NYXN1a2thbiBVc2VybmFtZS9FbWFpbCBJVkFTTVM6PC9iPmAKICAgICk7Cn0pOwoKYm90LmFjdGlvbignbG9naW5fY2Zfb25seScsIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgdXNlcklkID0gY3R4LmZyb20uaWQ7CiAgICBsZXQgc3RhdGUgPSBnZXRVc2VyU3RhdGUodXNlcklkKTsKICAgIAogICAgaWYgKCFzdGF0ZSB8fCBzdGF0ZS50eXBlICE9PSAnTE9HSU4nKSB7CiAgICAgICAgY29uc3Qgc2VudE1zZyA9IGF3YWl0IGN0eC5yZXBseVdpdGhIVE1MKGA8cHJlPvCfjaogVVBEQVRFIENGIENMRUFSQU5DRTwvcHJlPlxuXG7wn5SEIE1lbXVsYWkgdXBkYXRlIGNvb2tpZS4uLmApOwogICAgICAgIHN0YXRlID0gc2V0VXNlclN0YXRlKHVzZXJJZCwgJ0xPR0lOJywgewogICAgICAgICAgICBtZXNzYWdlSWQ6IHNlbnRNc2cubWVzc2FnZV9pZCwKICAgICAgICAgICAgY2hhdElkOiBjdHguY2hhdC5pZCwKICAgICAgICAgICAgbG9naW5TdGVwOiAnY2Zfb25seScsCiAgICAgICAgICAgIGxvZ2luRGF0YToge30KICAgICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgc3RhdGUuZGF0YS5sb2dpblN0ZXAgPSAnY2Zfb25seSc7CiAgICAgICAgc3RhdGUuZGF0YS5sb2dpbkRhdGEgPSB7fTsKICAgICAgICBzdGF0ZS5zdGVwID0gJ2F3YWl0aW5nX2lucHV0JzsKICAgIH0KICAgIAogICAgYXdhaXQgY3R4LmFuc3dlckNiUXVlcnkoJ1VwZGF0aW5nIENGIGNsZWFyYW5jZSBvbmx5Li4uJyk7CiAgICAKICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHN0YXRlLmRhdGEubWVzc2FnZUlkLAogICAgICAgIGA8cHJlPvCfjaogVVBEQVRFIENGIENMRUFSQU5DRTwvcHJlPlxuXG7wn5GkIDxiPlVzZXI6PC9iPiA8Y29kZT4ke3NldHRpbmdzLklWQVNfVVNFUk5BTUUgfHwgJ05vdCBzZXQnfTwvY29kZT5cbuKame+4jyA8Yj5TdGF0dXM6PC9iPiBNZW51bmdndSBjb29raWUuLi5cblxu8J+TiyA8Yj5NYXN1a2thbiBDRiBDbGVhcmFuY2UgYmFydTo8L2I+XG48aT4oQW1iaWwgbmlsYWkgY2ZfY2xlYXJhbmNlIGRhcmkgYnJvd3Nlcik8L2k+YAogICAgKTsKfSk7CmJvdC5hY3Rpb24oJ2xvZ2luX3Jlc2V0X2FsbCcsIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgdXNlcklkID0gY3R4LmZyb20uaWQ7CiAgICBjb25zdCBzdGF0ZSA9IGdldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgCiAgICBpZiAoIXN0YXRlIHx8IHN0YXRlLnR5cGUgIT09ICdMT0dJTicpIHsKICAgICAgICBhd2FpdCBjdHguYW5zd2VyQ2JRdWVyeSgn4p2MIFN0YXRlIHRpZGFrIHZhbGlkLiBVbGFuZ2kgL2xvZ2luJyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICBhd2FpdCBjdHguYW5zd2VyQ2JRdWVyeSgnUmVzZXR0aW5nIGFsbCBsb2dpbiBkYXRhLi4uJyk7CiAgICAKICAgIHRyeSB7CiAgICAgICAgd3JpdGVTZXR0aW5nVG9GaWxlU3luYygnSVZBU19VU0VSTkFNRScsICcnKTsKICAgICAgICB3cml0ZVNldHRpbmdUb0ZpbGVTeW5jKCdJVkFTX1BBU1NXT1JEJywgJycpOwogICAgICAgIHdyaXRlU2V0dGluZ1RvRmlsZVN5bmMoJ0NGX0NMRUFSQU5DRV9WQUxVRScsICcnKTsKICAgICAgICAKICAgICAgICBjb25zdCBrZXlib2FyZCA9IE1hcmt1cC5pbmxpbmVLZXlib2FyZChbCiAgICAgICAgICAgIFtNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCfwn5SRIFN0YXJ0IEZ1bGwgTG9naW4nLCAnbG9naW5fZnVsbCcpXQogICAgICAgIF0pOwoKICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBzdGF0ZS5kYXRhLm1lc3NhZ2VJZCwgYDxwcmU+8J+UhCBSRVNFVCBDT01QTEVURTwvcHJlPlxuXG7inIUgPGI+U3RhdHVzOjwvYj4gRGF0YSBkaWJlcnNpaGthblxu8J+TiiA8Yj5JbmZvOjwvYj4gU2VtdWEga3JlZGVuc2lhbCB0ZWxhaCBkaWhhcHVzLlxuXG48aT5TaWxha2FuIGxha3VrYW4gbG9naW4gdWxhbmcgdW50dWsgbWVtdWxhaS48L2k+YCwga2V5Ym9hcmQpOwogICAgICAgICAgICAKICAgICAgICByZXNldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgICAgIAogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBzdGF0ZS5kYXRhLm1lc3NhZ2VJZCwgYDxwcmU+8J+UhCBSRVNFVCBGQUlMRUQ8L3ByZT5cblxu4p2MIDxiPkVycm9yOjwvYj4gJHtlcnJvci5tZXNzYWdlfWApOwogICAgfQp9KTsKCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09IEFDVElPTiBIQU5ETEVSUyA9PT09PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpib3QuYWN0aW9uKCdsb2dpbl90cnlfY29ubmVjdCcsIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgYXdhaXQgY3R4LmFuc3dlckNiUXVlcnkoJ01lbXVsYWkgcHJvc2VzIGtvbmVrc2kuLi4nKTsKICAgIGNvbnN0IG1lc3NhZ2VJZCA9IGN0eC5jYWxsYmFja1F1ZXJ5Lm1lc3NhZ2UubWVzc2FnZV9pZDsKCiAgICAvLyBVcGRhdGUgcGVzYW4gZGVuZ2FuIHByb2dyZXNzIGJhcgogICAgYXdhaXQgY3R4LnRlbGVncmFtLmVkaXRNZXNzYWdlVGV4dCgKICAgICAgICBjdHguY2hhdC5pZCwKICAgICAgICBtZXNzYWdlSWQsCiAgICAgICAgbnVsbCwKICAgICAgICBgPGJsb2NrcXVvdGU+8J+UjCBQUk9TRVMgS09ORUtTSTwvYmxvY2txdW90ZT5cbmAgKwogICAgICAgIGDilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIFcbmAgKwogICAgICAgIGBb4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paRXSAwJWAsCiAgICAgICAgeyBwYXJzZV9tb2RlOiAnSFRNTCcgfQogICAgKTsKCiAgICAvLyBKYWxhbmthbiBrb25la3NpIGRpIGJhY2tncm91bmQKICAgIHNldEltbWVkaWF0ZShhc3luYyAoKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gU3RlcCAxOiBQZXJzaWFwYW4KICAgICAgICAgICAgYXdhaXQgY3R4LnRlbGVncmFtLmVkaXRNZXNzYWdlVGV4dCgKICAgICAgICAgICAgICAgIGN0eC5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZUlkLAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIGA8YmxvY2txdW90ZT7wn5SMIFBST1NFUyBLT05FS1NJPC9ibG9ja3F1b3RlPlxuYCArCiAgICAgICAgICAgICAgICBg4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG5gICsKICAgICAgICAgICAgICAgIGBb4paI4paI4paI4paI4paI4paI4paI4paI4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paR4paRXSAzMyVgLAogICAgICAgICAgICAgICAgeyBwYXJzZV9tb2RlOiAnSFRNTCcgfQogICAgICAgICAgICApOwoKICAgICAgICAgICAgLy8gU3RlcCAyOiBQcm9zZXMga29uZWtzaQogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgY3R4LnRlbGVncmFtLmVkaXRNZXNzYWdlVGV4dCgKICAgICAgICAgICAgICAgIGN0eC5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZUlkLAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIGA8YmxvY2txdW90ZT7wn5SMIFBST1NFUyBLT05FS1NJPC9ibG9ja3F1b3RlPlxuYCArCiAgICAgICAgICAgICAgICBg4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG5gICsKICAgICAgICAgICAgICAgIGBb4paI4paI4paI4paI4paI4paI4paI4paI4paI4paI4paI4paI4paI4paI4paI4paI4paR4paR4paR4paRXSA2NiVgLAogICAgICAgICAgICAgICAgeyBwYXJzZV9tb2RlOiAnSFRNTCcgfQogICAgICAgICAgICApOwoKICAgICAgICAgICAgLy8gRWtzZWt1c2kgZnVuZ3NpIGtvbmVrc2kKICAgICAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGNvbm5lY3RSb2J1c3RMaXZlU21zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoc3VjY2VzcykgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFVybCA9IGxpdmVTbXNQYWdlID8gYXdhaXQgbGl2ZVNtc1BhZ2UudXJsKCkgOiAnTi9BJzsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gaXNQb2xsaW5nQWN0aXZlID8gJ+KchSBBS1RJRicgOiAn4p2MIE5PTi1BS1RJRic7CiAgICAgICAgICAgICAgICBjb25zdCBpc1N0YWJsZSA9IGlzQ29ubmVjdGlvblN0YWJsZSA/ICfinIUgU1RBQklMJyA6ICfimqDvuI8gVElEQUsgU1RBQklMJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYXdhaXQgY3R4LnRlbGVncmFtLmVkaXRNZXNzYWdlVGV4dCgKICAgICAgICAgICAgICAgICAgICBjdHguY2hhdC5pZCwKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlSWQsCiAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgICBgPGJsb2NrcXVvdGU+8J+UjCBLT05FS1NJIEJFUkhBU0lMPC9ibG9ja3F1b3RlPlxuYCArCiAgICAgICAgICAgICAgICAgICAgYOKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuYCArCiAgICAgICAgICAgICAgICAgICAgYOKchSA8Yj5TdGF0dXMgS29uZWtzaTo8L2I+IFRFUkhVQlVOR1xuYCArCiAgICAgICAgICAgICAgICAgICAgYPCfk4ogPGI+U3RhdHVzIEJvdDo8L2I+ICR7Ym90U3RhdHVzfVxuYCArCiAgICAgICAgICAgICAgICAgICAgYPCfjJAgPGI+VVJMOjwvYj4gPGNvZGU+JHtjdXJyZW50VXJsfTwvY29kZT5cbmAgKwogICAgICAgICAgICAgICAgICAgIGDwn5OhIDxiPkxpdmUgU01TOjwvYj4gJHtpc0FjdGl2ZX1cbmAgKwogICAgICAgICAgICAgICAgICAgIGDimqEgPGI+U3RhYmlsaXRhczo8L2I+ICR7aXNTdGFibGV9XG5gICsKICAgICAgICAgICAgICAgICAgICBg4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG5gICsKICAgICAgICAgICAgICAgICAgICBg8J+VkCA8Yj5XYWt0dTo8L2I+ICR7bmV3IERhdGUoKS50b0xvY2FsZVRpbWVTdHJpbmcoJ2lkLUlEJyl9XG5gLAogICAgICAgICAgICAgICAgICAgIHsgcGFyc2VfbW9kZTogJ0hUTUwnIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignS29uZWtzaSBnYWdhbCAtIGZ1bmdzaSBjb25uZWN0Um9idXN0TGl2ZVNtcyBtZW5nZW1iYWxpa2FuIGZhbHNlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFtBQ1RJT05dIOKdjCBFcnJvciBrb25la3NpOiAke2Vycm9yLm1lc3NhZ2V9YCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IHN1Z2dlc3Rpb25zID0gJyc7CiAgICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdDbG91ZGZsYXJlJykgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnQ0YnKSkgewogICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnMgPSAnMS4gR3VuYWthbiAvbG9naW4gdW50dWsgdXBkYXRlIENGIENsZWFyYW5jZVxuMi4gQW1iaWwgY29va2llIGNmX2NsZWFyYW5jZSB0ZXJiYXJ1XG4zLiBDb2JhIGFrc2VzIG1hbnVhbCBkaSBicm93c2VyJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdsb2dpbicpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ2NyZWRlbnRpYWwnKSkgewogICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnMgPSAnMS4gUGFzdGlrYW4gdXNlcm5hbWUvcGFzc3dvcmQgYmVuYXJcbjIuIEd1bmFrYW4gL2xvZ2luIHVudHVrIHNldHVwIHVsYW5nXG4zLiBDZWsga29uZWtzaSBpbnRlcm5ldCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdWdnZXN0aW9ucyA9ICcxLiBDb2JhIC9sb2dpbiB1bGFuZ1xuMi4gUmVzdGFydCBib3RcbjMuIEh1YnVuZ2kgZGV2ZWxvcGVyJzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgY3R4LnRlbGVncmFtLmVkaXRNZXNzYWdlVGV4dCgKICAgICAgICAgICAgICAgIGN0eC5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZUlkLAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIGA8YmxvY2txdW90ZT7inYwgS09ORUtTSSBHQUdBTDwvYmxvY2txdW90ZT5cbmAgKwogICAgICAgICAgICAgICAgYOKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuYCArCiAgICAgICAgICAgICAgICBg4pqg77iPIDxiPkVycm9yOjwvYj4gPGNvZGU+JHtlcnJvci5tZXNzYWdlfTwvY29kZT5cblxuYCArCiAgICAgICAgICAgICAgICBg8J+UpyA8Yj5TYXJhbiBQZXJiYWlrYW46PC9iPlxuJHtzdWdnZXN0aW9uc31cblxuYCArCiAgICAgICAgICAgICAgICBg8J+UhCA8aT5TaWxha2FuIGNvYmEgbGFnaSBhdGF1IGd1bmFrYW4gL2xvZ2luPC9pPmAsCiAgICAgICAgICAgICAgICB7IHBhcnNlX21vZGU6ICdIVE1MJyB9CiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgfSk7Cn0pOwoKCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09IFVUSUxJVFkgRlVOQ1RJT05TID09PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpjb25zdCBzYWZlRWRpdE1lc3NhZ2UgPSBhc3luYyAoY3R4LCBtZXNzYWdlSWQsIG5ld1RleHQsIGtleWJvYXJkID0gbnVsbCkgPT4gewogICAgdHJ5IHsKICAgICAgICBjb25zdCBvcHRpb25zID0geyBwYXJzZV9tb2RlOiAnSFRNTCcsIGRpc2FibGVfd2ViX3BhZ2VfcHJldmlldzogdHJ1ZSB9OwogICAgICAgIGlmIChrZXlib2FyZCAmJiBrZXlib2FyZC5yZXBseV9tYXJrdXApIG9wdGlvbnMucmVwbHlfbWFya3VwID0ga2V5Ym9hcmQucmVwbHlfbWFya3VwOwogICAgICAgIAogICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5lZGl0TWVzc2FnZVRleHQoY3R4LmNoYXQuaWQsIG1lc3NhZ2VJZCwgbnVsbCwgbmV3VGV4dCwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmIChlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5lcnJvcl9jb2RlID09PSA0MDAgJiYgZXJyb3IucmVzcG9uc2UuZGVzY3JpcHRpb24uaW5jbHVkZXMoJ21lc3NhZ2UgaXMgbm90IG1vZGlmaWVkJykpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5lcnJvcl9jb2RlID09PSA0MDAgJiYgZXJyb3IucmVzcG9uc2UuZGVzY3JpcHRpb24uaW5jbHVkZXMoJ21lc3NhZ2UgdG8gZWRpdCBub3QgZm91bmQnKSkgewogICAgICAgICAgICBjb25zdCBzZW5kT3B0aW9ucyA9IHsgcGFyc2VfbW9kZTogJ0hUTUwnLCBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc6IHRydWUgfTsKICAgICAgICAgICAgaWYgKGtleWJvYXJkICYmIGtleWJvYXJkLnJlcGx5X21hcmt1cCkgc2VuZE9wdGlvbnMucmVwbHlfbWFya3VwID0ga2V5Ym9hcmQucmVwbHlfbWFya3VwOwogICAgICAgICAgICBhd2FpdCBjdHgudGVsZWdyYW0uc2VuZE1lc3NhZ2UoY3R4LmNoYXQuaWQsIG5ld1RleHQsIHNlbmRPcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfTsKCmNvbnN0IGhhbmRsZUxvZ2luVGV4dCA9IGFzeW5jIChjdHgsIHN0YXRlLCB0ZXh0KSA9PiB7CiAgICBjb25zdCB1c2VySWQgPSBjdHguZnJvbS5pZDsKICAgIGNvbnN0IG1lc3NhZ2VJZCA9IHN0YXRlLmRhdGEubWVzc2FnZUlkOwogICAgY29uc3QgaGVhZGVyID0gYDxibG9ja3F1b3RlPvCflJEgTE9HSU4gU0VUVVA8L2Jsb2NrcXVvdGU+XG7ilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIFcbmA7CiAgICAKICAgIGlmICghc3RhdGUuZGF0YS5sb2dpblN0ZXApIHsgcmVzZXRVc2VyU3RhdGUodXNlcklkKTsgcmV0dXJuOyB9CiAgICAKICAgIHN3aXRjaCAoc3RhdGUuZGF0YS5sb2dpblN0ZXApIHsKICAgICAgICBjYXNlICd1c2VybmFtZSc6CiAgICAgICAgICAgIGNvbnN0IHVzZXJuYW1lID0gdGV4dC50cmltKCk7CiAgICAgICAgICAgIGlmICghdXNlcm5hbWUpIHsKICAgICAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIG1lc3NhZ2VJZCwgYCR7aGVhZGVyfeKdjCBVc2VybmFtZSB0aWRhayBib2xlaCBrb3NvbmchXG5cbvCfk6cgPGI+TWFzdWtrYW4gVXNlcm5hbWUvRW1haWw6PC9iPmApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0YXRlLmRhdGEubG9naW5EYXRhID0gc3RhdGUuZGF0YS5sb2dpbkRhdGEgfHwge307CiAgICAgICAgICAgIHN0YXRlLmRhdGEubG9naW5EYXRhLnVzZXJuYW1lID0gdXNlcm5hbWU7CiAgICAgICAgICAgIHN0YXRlLmRhdGEubG9naW5TdGVwID0gJ3Bhc3N3b3JkJzsKICAgICAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgbWVzc2FnZUlkLCBgJHtoZWFkZXJ98J+RpCBVc2VybmFtZTogPGNvZGU+JHt1c2VybmFtZX08L2NvZGU+XG5cbvCflJAgPGI+TWFzdWtrYW4gUGFzc3dvcmQ6PC9iPmApOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgY2FzZSAncGFzc3dvcmQnOgogICAgICAgICAgICBjb25zdCBwYXNzd29yZCA9IHRleHQudHJpbSgpOwogICAgICAgICAgICBpZiAoIXBhc3N3b3JkKSB7CiAgICAgICAgICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBtZXNzYWdlSWQsIGAke2hlYWRlcn3inYwgUGFzc3dvcmQgdGlkYWsgYm9sZWgga29zb25nIVxuXG7wn5SQIDxiPk1hc3Vra2FuIFBhc3N3b3JkOjwvYj5gKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdGF0ZS5kYXRhLmxvZ2luRGF0YS5wYXNzd29yZCA9IHBhc3N3b3JkOwogICAgICAgICAgICBzdGF0ZS5kYXRhLmxvZ2luU3RlcCA9ICdjZl9jbGVhcmFuY2UnOwogICAgICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBtZXNzYWdlSWQsIGAke2hlYWRlcn3wn5GkIFVzZXI6IDxjb2RlPiR7c3RhdGUuZGF0YS5sb2dpbkRhdGEudXNlcm5hbWV9PC9jb2RlPlxu8J+UkSBQYXNzOiA8Y29kZT4qKioqKioqKjwvY29kZT5cblxu8J+NqiA8Yj5NYXN1a2thbiBDRiBDbGVhcmFuY2U6PC9iPmApOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgY2FzZSAnY2ZfY2xlYXJhbmNlJzoKICAgICAgICAgICAgY29uc3QgY2ZWYWx1ZSA9IHRleHQudHJpbSgpOwogICAgICAgICAgICBpZiAoY2ZWYWx1ZS5sZW5ndGggPCAxMCkgewogICAgICAgICAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgbWVzc2FnZUlkLCBgJHtoZWFkZXJ94p2MIENvb2tpZSB0ZXJsYWx1IHBlbmRlayFcblxu8J+NqiA8Yj5NYXN1a2thbiBDRiBDbGVhcmFuY2U6PC9iPmApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZVNldHRpbmdTaWxlbnQoJ0lWQVNfVVNFUk5BTUUnLCBzdGF0ZS5kYXRhLmxvZ2luRGF0YS51c2VybmFtZSk7CiAgICAgICAgICAgIHVwZGF0ZVNldHRpbmdTaWxlbnQoJ0lWQVNfUEFTU1dPUkQnLCBzdGF0ZS5kYXRhLmxvZ2luRGF0YS5wYXNzd29yZCk7CiAgICAgICAgICAgIHVwZGF0ZVNldHRpbmdTaWxlbnQoJ0NGX0NMRUFSQU5DRV9WQUxVRScsIGNmVmFsdWUpOwogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgbWVzc2FnZUlkLCBgJHtoZWFkZXJ94pyFIDxiPkRhdGEgYmVyaGFzaWwgZGlzaW1wYW4hPC9iPlxuXG7wn5SEIDxpPk1lbmNvYmEga29uZWtzaSBvdG9tYXRpcy4uLjwvaT5gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgY29ubmVjdFJvYnVzdExpdmVTbXMoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXNNc2cgPSBzdWNjZXNzID8gYOKchSA8Yj5Mb2dpbiAmIEtvbmVrc2kgQmVyaGFzaWwhPC9iPmAgOiBg4pqg77iPIDxiPkRhdGEgdGVyc2ltcGFuLCBrb25la3NpIGdhZ2FsLjwvYj5gOwogICAgICAgICAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIG1lc3NhZ2VJZCwgYDxibG9ja3F1b3RlPvCflJEgU1RBVFVTIExPR0lOPC9ibG9ja3F1b3RlPlxu4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG4ke3N0YXR1c01zZ31cblxu8J+RpCBVc2VyOiAke3NldHRpbmdzLklWQVNfVVNFUk5BTUV9XG7wn5OhIFNNUzogJHtpc1BvbGxpbmdBY3RpdmUgPyAnQUtUSUYnIDogJ09GRid9YCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgbWVzc2FnZUlkLCBgPGJsb2NrcXVvdGU+4pqg77iPIExPR0lOIEVSUk9SPC9ibG9ja3F1b3RlPlxu4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG7inYwgPGI+RXJyb3I6PC9iPiAke2UubWVzc2FnZX1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0VXNlclN0YXRlKHVzZXJJZCk7CiAgICAgICAgICAgIH0sIDIwMDApOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgY2FzZSAnY2Zfb25seSc6CiAgICAgICAgICAgIGNvbnN0IGNmT25seVZhbHVlID0gdGV4dC50cmltKCk7CiAgICAgICAgICAgIGlmIChjZk9ubHlWYWx1ZS5sZW5ndGggPCAxMCkgewogICAgICAgICAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgbWVzc2FnZUlkLCBgPGJsb2NrcXVvdGU+8J+NqiBVUERBVEUgQ09PS0lFPC9ibG9ja3F1b3RlPlxu4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG7inYwgQ29va2llIHRlcmxhbHUgcGVuZGVrIVxuXG7wn5OLIDxiPk1hc3Vra2FuIENGIENsZWFyYW5jZSBiYXJ1OjwvYj5gKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVTZXR0aW5nU2lsZW50KCdDRl9DTEVBUkFOQ0VfVkFMVUUnLCBjZk9ubHlWYWx1ZSk7CiAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIG1lc3NhZ2VJZCwgYDxibG9ja3F1b3RlPvCfjaogVVBEQVRFIEJFUkhBU0lMPC9ibG9ja3F1b3RlPlxu4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG7inIUgQ29va2llIGRpcGVyYmFydWkuXG5cbvCflIQgPGk+TWVuY29iYSBrb25la3NpLi4uPC9pPmApOwogICAgICAgICAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBjb25uZWN0Um9idXN0TGl2ZVNtcygpOwogICAgICAgICAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgbWVzc2FnZUlkLCBgPGJsb2NrcXVvdGU+8J+UjCBTVEFUVVMgS09ORUtTSTwvYmxvY2txdW90ZT5cbuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuU3RhdHVzOiAke3N1Y2Nlc3MgPyAnQ29ubmVjdGVkJyA6ICdGYWlsZWQnfVxu8J+ToSBTTVM6ICR7aXNQb2xsaW5nQWN0aXZlID8gJ0FLVElGJyA6ICdPRkYnfWApOwogICAgICAgICAgICAgICAgcmVzZXRVc2VyU3RhdGUodXNlcklkKTsKICAgICAgICAgICAgfSwgMjAwMCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgfQp9OwoKY29uc3QgaGFuZGxlVXNlckFnZW50VGV4dCA9IGFzeW5jIChjdHgsIHN0YXRlLCB0ZXh0KSA9PiB7CiAgICBjb25zdCB1c2VySWQgPSBjdHguZnJvbS5pZDsKICAgIGNvbnN0IHVzZXJBZ2VudCA9IHRleHQudHJpbSgpOwogICAgY29uc3QgaGVhZGVyID0gYDxibG9ja3F1b3RlPvCfkrsgVVNFUiBBR0VOVCBTRVRVUDwvYmxvY2txdW90ZT5cbuKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuYDsKICAgIAogICAgaWYgKHVzZXJBZ2VudC5sZW5ndGggPCAyMCkgewogICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHN0YXRlLmRhdGEubWVzc2FnZUlkLCBgJHtoZWFkZXJ94p2MIDxiPlVzZXIgQWdlbnQgdGVybGFsdSBwZW5kZWshPC9iPlxuXG7wn5OdIDxiPktpcmltIFVzZXIgQWdlbnQgYmFydTo8L2I+YCk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICB1cGRhdGVTZXR0aW5nU2lsZW50KCdDVVJSRU5UX1VTRVJfQUdFTlQnLCB1c2VyQWdlbnQpOwogICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgc3RhdGUuZGF0YS5tZXNzYWdlSWQsIGAke2hlYWRlcn3inIUgPGI+VXNlciBBZ2VudCBkaXBlcmJhcnVpITwvYj5cblxuPGNvZGU+JHt1c2VyQWdlbnQuc3Vic3RyaW5nKDAsIDQwKX0uLi48L2NvZGU+XG5cbvCflIQgPGk+UmVzdGFydGluZyBicm93c2VyLi4uPC9pPmApOwogICAgCiAgICByZXNldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgc2V0VGltZW91dChhc3luYyAoKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGxpdmVTbXNQYWdlKSB7IGF3YWl0IGxpdmVTbXNQYWdlLmNsb3NlKCkuY2F0Y2goKCkgPT4ge30pOyBsaXZlU21zUGFnZSA9IG51bGw7IH0KICAgICAgICAgICAgbGl2ZVNtc1BhZ2UgPSBhd2FpdCBicm93c2VyLm5ld1BhZ2UoKTsKICAgICAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2Uuc2V0VXNlckFnZW50KHVzZXJBZ2VudCk7CiAgICAgICAgICAgIGlmIChzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUpIHsKICAgICAgICAgICAgICAgIGF3YWl0IGxpdmVTbXNQYWdlLnNldENvb2tpZSh7IG5hbWU6ICdjZl9jbGVhcmFuY2UnLCB2YWx1ZTogc2V0dGluZ3MuQ0ZfQ0xFQVJBTkNFX1ZBTFVFLCBkb21haW46ICcuaXZhc21zLmNvbScgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXdhaXQgbGl2ZVNtc1BhZ2UuZ290byhMSVZFX1NNU19VUkwsIHsgd2FpdFVudGlsOiAnZG9tY29udGVudGxvYWRlZCcsIHRpbWVvdXQ6IDMwMDAwIH0pOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9LCAxMDAwKTsKfTsKCmNvbnN0IGhhbmRsZUNWVGV4dCA9IGFzeW5jIChjdHgsIHN0YXRlLCB0ZXh0KSA9PiB7CiAgICBjb25zdCB1c2VySWQgPSBjdHguZnJvbS5pZDsKICAgIGNvbnN0IGhlYWRlciA9IGA8YmxvY2txdW90ZT7wn5OBIENPTlZFUlQgU1RBVFVTPC9ibG9ja3F1b3RlPlxu4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG5gOwogICAgCiAgICBpZiAoc3RhdGUuc3RlcCA9PT0gJ2F3YWl0aW5nX2FsbF9zZXJ2aWNlX2lucHV0JykgewogICAgICAgIGNvbnN0IHNlcnZpY2VOYW1lID0gdGV4dC50cmltKCk7CiAgICAgICAgaWYgKCFzZXJ2aWNlTmFtZSkgewogICAgICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBzdGF0ZS5kYXRhLm1lc3NhZ2VJZCwgYCR7aGVhZGVyfeKdjCBOYW1hIFNlcnZpY2Uga29zb25nIVxuXG5NYXN1a2thbiBuYW1hIHNlcnZpY2UuYCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgc3RhdGUuZGF0YS5zZXJ2aWNlTmFtZSA9IHNlcnZpY2VOYW1lOwogICAgICAgIHN0YXRlLmRhdGEuZmlsZUxpc3QuZm9yRWFjaChmaWxlID0+IGZpbGUuc2VydmljZU5hbWUgPSBzZXJ2aWNlTmFtZSk7CiAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgc3RhdGUuZGF0YS5tZXNzYWdlSWQsIGAke2hlYWRlcn3inIUgU2VydmljZTogPGI+JHtzZXJ2aWNlTmFtZX08L2I+XG7wn5OmIEZpbGU6ICR7c3RhdGUuZGF0YS5maWxlTGlzdC5sZW5ndGh9XG5cbuKPsyA8aT5NZW1wcm9zZXMga29udmVyc2kuLi48L2k+YCk7CiAgICAgICAgYXdhaXQgc2VuZENvbnZlcnRlZEZpbGVzKGN0eCwgc3RhdGUuZGF0YSk7CiAgICAgICAgcmVzZXRVc2VyU3RhdGUodXNlcklkKTsKICAgICAgICAKICAgIH0gZWxzZSBpZiAoc3RhdGUuc3RlcCA9PT0gJ2F3YWl0aW5nX3NpbmdsZV9zZXJ2aWNlX2lucHV0JykgewogICAgICAgIGNvbnN0IHNlcnZpY2VOYW1lID0gdGV4dC50cmltKCk7CiAgICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gc3RhdGUuZGF0YS5jdXJyZW50RmlsZUluZGV4OwogICAgICAgIGlmICghc2VydmljZU5hbWUpIHsKICAgICAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgc3RhdGUuZGF0YS5tZXNzYWdlSWQsIGAke2hlYWRlcn3inYwgTmFtYSBTZXJ2aWNlIGtvc29uZyFcblxuSW5wdXQgc2VydmljZSB1bnR1ayBmaWxlIGtlLSR7Y3VycmVudEluZGV4ICsgMX0uYCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgc3RhdGUuZGF0YS5maWxlTGlzdFtjdXJyZW50SW5kZXhdLnNlcnZpY2VOYW1lID0gc2VydmljZU5hbWU7CiAgICAgICAgaWYgKGN1cnJlbnRJbmRleCArIDEgPCBzdGF0ZS5kYXRhLmZpbGVMaXN0Lmxlbmd0aCkgewogICAgICAgICAgICBzdGF0ZS5kYXRhLmN1cnJlbnRGaWxlSW5kZXgrKzsKICAgICAgICAgICAgY29uc3QgbmV4dEZpbGUgPSBzdGF0ZS5kYXRhLmZpbGVMaXN0W3N0YXRlLmRhdGEuY3VycmVudEZpbGVJbmRleF07CiAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHN0YXRlLmRhdGEubWVzc2FnZUlkLCBgJHtoZWFkZXJ94pyFIFNlcnZpY2UgJHtjdXJyZW50SW5kZXggKyAxfSBkaXNpbXBhbi5cblxu8J+TnSBJbnB1dCBzZXJ2aWNlIHVudHVrIGZpbGUga2UtJHtzdGF0ZS5kYXRhLmN1cnJlbnRGaWxlSW5kZXggKyAxfTpcbiR7bmV4dEZpbGUuY291bnRyeX0gKCR7bmV4dEZpbGUuY291bnR9IE5vKWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHN0YXRlLmRhdGEubWVzc2FnZUlkLCBgJHtoZWFkZXJ94pyFIFNlbXVhIHNlcnZpY2UgZGlpc2khXG5cbuKPsyA8aT5NZW1wcm9zZXMga29udmVyc2kuLi48L2k+YCk7CiAgICAgICAgICAgIGF3YWl0IHNlbmRDb252ZXJ0ZWRGaWxlcyhjdHgsIHN0YXRlLmRhdGEpOwogICAgICAgICAgICByZXNldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgICAgIH0KICAgIH0KfTsKYm90LmFjdGlvbignbG9naW5fdHJ5X2Nvbm5lY3QnLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsKICAgIGF3YWl0IGN0eC5hbnN3ZXJDYlF1ZXJ5KCdNZW11bGFpIHByb3NlcyBrb25la3NpLi4uJyk7CiAgICBjb25zdCBtZXNzYWdlSWQgPSBjdHguY2FsbGJhY2tRdWVyeS5tZXNzYWdlLm1lc3NhZ2VfaWQ7CgogICAgLy8gVXBkYXRlIHBlc2FuIGRlbmdhbiBwcm9ncmVzcyBiYXIKICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5lZGl0TWVzc2FnZVRleHQoCiAgICAgICAgY3R4LmNoYXQuaWQsCiAgICAgICAgbWVzc2FnZUlkLAogICAgICAgIG51bGwsCiAgICAgICAgYDxibG9ja3F1b3RlPvCflIwgUFJPU0VTIEtPTkVLU0k8L2Jsb2NrcXVvdGU+XG5gICsKICAgICAgICBg4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG5gICsKICAgICAgICBgW+KWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkV0gMCVgLAogICAgICAgIHsgcGFyc2VfbW9kZTogJ0hUTUwnIH0KICAgICk7CgogICAgLy8gSmFsYW5rYW4ga29uZWtzaSBkaSBiYWNrZ3JvdW5kCiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIFN0ZXAgMTogUGVyc2lhcGFuCiAgICAgICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5lZGl0TWVzc2FnZVRleHQoCiAgICAgICAgICAgICAgICBjdHguY2hhdC5pZCwKICAgICAgICAgICAgICAgIG1lc3NhZ2VJZCwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICBgPGJsb2NrcXVvdGU+8J+UjCBQUk9TRVMgS09ORUtTSTwvYmxvY2txdW90ZT5cbmAgKwogICAgICAgICAgICAgICAgYOKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuYCArCiAgICAgICAgICAgICAgICBgW+KWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkeKWkV0gMzMlYCwKICAgICAgICAgICAgICAgIHsgcGFyc2VfbW9kZTogJ0hUTUwnIH0KICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIC8vIFN0ZXAgMjogUHJvc2VzIGtvbmVrc2kKICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5lZGl0TWVzc2FnZVRleHQoCiAgICAgICAgICAgICAgICBjdHguY2hhdC5pZCwKICAgICAgICAgICAgICAgIG1lc3NhZ2VJZCwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICBgPGJsb2NrcXVvdGU+8J+UjCBQUk9TRVMgS09ORUtTSTwvYmxvY2txdW90ZT5cbmAgKwogICAgICAgICAgICAgICAgYOKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuYCArCiAgICAgICAgICAgICAgICBgW+KWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWiOKWkeKWkeKWkeKWkV0gNjYlYCwKICAgICAgICAgICAgICAgIHsgcGFyc2VfbW9kZTogJ0hUTUwnIH0KICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIC8vIEVrc2VrdXNpIGZ1bmdzaSBrb25la3NpCiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBjb25uZWN0Um9idXN0TGl2ZVNtcygpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRVcmwgPSBsaXZlU21zUGFnZSA/IGF3YWl0IGxpdmVTbXNQYWdlLnVybCgpIDogJ04vQSc7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IGlzUG9sbGluZ0FjdGl2ZSA/ICfinIUgQUtUSUYnIDogJ+KdjCBOT04tQUtUSUYnOwogICAgICAgICAgICAgICAgY29uc3QgaXNTdGFibGUgPSBpc0Nvbm5lY3Rpb25TdGFibGUgPyAn4pyFIFNUQUJJTCcgOiAn4pqg77iPIFRJREFLIFNUQUJJTCc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5lZGl0TWVzc2FnZVRleHQoCiAgICAgICAgICAgICAgICAgICAgY3R4LmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUlkLAogICAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgICAgYDxibG9ja3F1b3RlPvCflIwgS09ORUtTSSBCRVJIQVNJTDwvYmxvY2txdW90ZT5cbmAgKwogICAgICAgICAgICAgICAgICAgIGDilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIFcbmAgKwogICAgICAgICAgICAgICAgICAgIGDinIUgPGI+U3RhdHVzIEtvbmVrc2k6PC9iPiBURVJIVUJVTkdcbmAgKwogICAgICAgICAgICAgICAgICAgIGDwn5OKIDxiPlN0YXR1cyBCb3Q6PC9iPiAke2JvdFN0YXR1c31cbmAgKwogICAgICAgICAgICAgICAgICAgIGDwn4yQIDxiPlVSTDo8L2I+IDxjb2RlPiR7Y3VycmVudFVybH08L2NvZGU+XG5gICsKICAgICAgICAgICAgICAgICAgICBg8J+ToSA8Yj5MaXZlIFNNUzo8L2I+ICR7aXNBY3RpdmV9XG5gICsKICAgICAgICAgICAgICAgICAgICBg4pqhIDxiPlN0YWJpbGl0YXM6PC9iPiAke2lzU3RhYmxlfVxuYCArCiAgICAgICAgICAgICAgICAgICAgYOKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuYCArCiAgICAgICAgICAgICAgICAgICAgYPCflZAgPGI+V2FrdHU6PC9iPiAke25ldyBEYXRlKCkudG9Mb2NhbGVUaW1lU3RyaW5nKCdpZC1JRCcpfVxuYCwKICAgICAgICAgICAgICAgICAgICB7IHBhcnNlX21vZGU6ICdIVE1MJyB9CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0tvbmVrc2kgZ2FnYWwgLSBmdW5nc2kgY29ubmVjdFJvYnVzdExpdmVTbXMgbWVuZ2VtYmFsaWthbiBmYWxzZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY2hhbGsucmVkKGBbQUNUSU9OXSDinYwgRXJyb3Iga29uZWtzaTogJHtlcnJvci5tZXNzYWdlfWApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBzdWdnZXN0aW9ucyA9ICcnOwogICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnQ2xvdWRmbGFyZScpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0NGJykpIHsKICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb25zID0gJzEuIEd1bmFrYW4gL2xvZ2luIHVudHVrIHVwZGF0ZSBDRiBDbGVhcmFuY2VcbjIuIEFtYmlsIGNvb2tpZSBjZl9jbGVhcmFuY2UgdGVyYmFydVxuMy4gQ29iYSBha3NlcyBtYW51YWwgZGkgYnJvd3Nlcic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnbG9naW4nKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdjcmVkZW50aWFsJykpIHsKICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb25zID0gJzEuIFBhc3Rpa2FuIHVzZXJuYW1lL3Bhc3N3b3JkIGJlbmFyXG4yLiBHdW5ha2FuIC9sb2dpbiB1bnR1ayBzZXR1cCB1bGFuZ1xuMy4gQ2VrIGtvbmVrc2kgaW50ZXJuZXQnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnMgPSAnMS4gQ29iYSAvbG9naW4gdWxhbmdcbjIuIFJlc3RhcnQgYm90XG4zLiBIdWJ1bmdpIGRldmVsb3Blcic7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5lZGl0TWVzc2FnZVRleHQoCiAgICAgICAgICAgICAgICBjdHguY2hhdC5pZCwKICAgICAgICAgICAgICAgIG1lc3NhZ2VJZCwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICBgPGJsb2NrcXVvdGU+4p2MIEtPTkVLU0kgR0FHQUw8L2Jsb2NrcXVvdGU+XG5gICsKICAgICAgICAgICAgICAgIGDilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIFcbmAgKwogICAgICAgICAgICAgICAgYOKaoO+4jyA8Yj5FcnJvcjo8L2I+IDxjb2RlPiR7ZXJyb3IubWVzc2FnZX08L2NvZGU+XG5cbmAgKwogICAgICAgICAgICAgICAgYPCflKcgPGI+U2FyYW4gUGVyYmFpa2FuOjwvYj5cbiR7c3VnZ2VzdGlvbnN9XG5cbmAgKwogICAgICAgICAgICAgICAgYPCflIQgPGk+U2lsYWthbiBjb2JhIGxhZ2kgYXRhdSBndW5ha2FuIC9sb2dpbjwvaT5gLAogICAgICAgICAgICAgICAgeyBwYXJzZV9tb2RlOiAnSFRNTCcgfQogICAgICAgICAgICApOwogICAgICAgIH0KICAgIH0pOwp9KTsKCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09IFRFWFQgSEFORExFUiA9PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpib3Qub24oJ3RleHQnLCBvd25lck9ubHksIGFzeW5jIChjdHgsIG5leHQpID0+IHsKICAgIGNvbnN0IHVzZXJJZCA9IGN0eC5mcm9tLmlkOwogICAgY29uc3QgdGV4dCA9IGN0eC5tZXNzYWdlLnRleHQudHJpbSgpOwogICAgY29uc3Qgc3RhdGUgPSBnZXRVc2VyU3RhdGUodXNlcklkKTsKCiAgICBpZiAodGV4dC5zdGFydHNXaXRoKCcvJykpIHJldHVybiBuZXh0KCk7CiAgICBpZiAoIXN0YXRlIHx8ICFzdGF0ZS5zdGVwKSByZXR1cm4gbmV4dCgpOwoKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgY3R4LnRlbGVncmFtLmRlbGV0ZU1lc3NhZ2UoY3R4LmNoYXQuaWQsIGN0eC5tZXNzYWdlLm1lc3NhZ2VfaWQpLmNhdGNoKCgpID0+IHt9KTsKICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgdHJ5IHsKICAgICAgICBzd2l0Y2ggKHN0YXRlLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnTE9HSU4nOiBhd2FpdCBoYW5kbGVMb2dpblRleHQoY3R4LCBzdGF0ZSwgdGV4dCk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdVU0VSX0FHRU5UJzogYXdhaXQgaGFuZGxlVXNlckFnZW50VGV4dChjdHgsIHN0YXRlLCB0ZXh0KTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ0NWJzogYXdhaXQgaGFuZGxlQ1ZUZXh0KGN0eCwgc3RhdGUsIHRleHQpOyBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDogcmVzZXRVc2VyU3RhdGUodXNlcklkKTsgcmV0dXJuIG5leHQoKTsKICAgICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoY2hhbGsucmVkKGBbVEVYVCBIQU5ETEVSXSBFcnJvcjogJHtlcnJvci5tZXNzYWdlfWApKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBjdHgucmVwbHlXaXRoSFRNTCgKICAgICAgICAgICAgICAgIGA8YmxvY2txdW90ZT7imqDvuI8gRVJST1IgU1lTVEVNPC9ibG9ja3F1b3RlPlxu4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBXG7inYwgPGI+RXJyb3I6PC9iPiAke2Vycm9yLm1lc3NhZ2V9XG5cbjxpPlVsYW5naSBwZXJpbnRhaCBkYXJpIGF3YWwuPC9pPmAsIAogICAgICAgICAgICAgICAgeyByZXBseV90b19tZXNzYWdlX2lkOiBjdHgubWVzc2FnZS5tZXNzYWdlX2lkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIHJlc2V0VXNlclN0YXRlKHVzZXJJZCk7CiAgICB9Cn0pOwoKCgovLyA9PT09PT09PT09IENWIEZJTEUgU1lTVEVNID09PT09PT09PT0gLy8KLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCgpjb25zdCByZWFkQ29udGFjdHMgPSAobG9jYWxQYXRoLCB0eXBlKSA9PiB7CiAgICBpZiAoIWZzLmV4aXN0c1N5bmMobG9jYWxQYXRoKSkgcmV0dXJuIFtdOwogICAgY29uc3QgY29udGFjdHMgPSBbXTsKCiAgICBpZiAodHlwZSA9PT0gJ2NzdicgfHwgdHlwZSA9PT0gJ3R4dCcpIHsKICAgICAgICBsZXQgZmlsZUNvbnRlbnQgPSAnJzsKICAgICAgICB0cnkgewogICAgICAgICAgICBmaWxlQ29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhsb2NhbFBhdGgsICd1dGY4Jyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQoKICAgICAgICBsZXQgbGluZXMgPSBmaWxlQ29udGVudC50cmltKCkuc3BsaXQoJ1xuJyk7CiAgICAgICAgY29uc3QgRklSU1RfREFUQV9ST1dfSU5ERVggPSAwOwogICAgICAgIGlmIChsaW5lcy5sZW5ndGggPT09IDApIHJldHVybiBbXTsKCiAgICAgICAgbGV0IHBob25lQ29sdW1uSW5kZXggPSAtMTsKICAgICAgICBsZXQgZmluYWxTZXBhcmF0b3IgPSAnLCc7CiAgICAgICAgbGV0IG1heFZhbGlkQ291bnQgPSAtMTsKCiAgICAgICAgY29uc3QgcG9zc2libGVTZXBhcmF0b3JzID0gWycsJywgJ1x0JywgJzsnLCAnfCddOwogICAgICAgIGNvbnN0IG1heFJvd3NDaGVjayA9IE1hdGgubWluKGxpbmVzLmxlbmd0aCwgNTApOwoKICAgICAgICBmb3IgKGNvbnN0IGN1cnJlbnRTZXAgb2YgcG9zc2libGVTZXBhcmF0b3JzKSB7CiAgICAgICAgICAgIGxldCBtYXhDb2xzID0gMDsKICAgICAgICAgICAgZm9yKGxldCBpID0gRklSU1RfREFUQV9ST1dfSU5ERVg7IGkgPCBtYXhSb3dzQ2hlY2s7IGkrKykgewogICAgICAgICAgICAgICAgIGNvbnN0IHJvd0NvbHMgPSBsaW5lc1tpXS50cmltKCkuc3BsaXQoY3VycmVudFNlcCk7CiAgICAgICAgICAgICAgICAgbWF4Q29scyA9IE1hdGgubWF4KG1heENvbHMsIHJvd0NvbHMubGVuZ3RoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChsZXQgY29sSW5kZXggPSAwOyBjb2xJbmRleCA8IG1heENvbHM7IGNvbEluZGV4KyspIHsKICAgICAgICAgICAgICAgIGxldCB2YWxpZENvdW50ID0gMDsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gRklSU1RfREFUQV9ST1dfSU5ERVg7IGkgPCBtYXhSb3dzQ2hlY2s7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvd0NvbHMgPSBsaW5lc1tpXS50cmltKCkuc3BsaXQoY3VycmVudFNlcCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJvd0NvbHMubGVuZ3RoID4gY29sSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTGlrZWx5UGhvbmVOdW1iZXIocm93Q29sc1tjb2xJbmRleF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZENvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHZhbGlkQ291bnQgPj0gNSAmJiB2YWxpZENvdW50ID4gbWF4VmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgIG1heFZhbGlkQ291bnQgPSB2YWxpZENvdW50OwogICAgICAgICAgICAgICAgICAgIHBob25lQ29sdW1uSW5kZXggPSBjb2xJbmRleDsKICAgICAgICAgICAgICAgICAgICBmaW5hbFNlcGFyYXRvciA9IGN1cnJlbnRTZXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChwaG9uZUNvbHVtbkluZGV4ID09PSAtMSB8fCBtYXhWYWxpZENvdW50IDw9IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KCiAgICAgICAgbGV0IHNlcGFyYXRvciA9IGZpbmFsU2VwYXJhdG9yOwoKICAgICAgICBmb3IobGV0IGkgPSBGSVJTVF9EQVRBX1JPV19JTkRFWDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBsaW5lc1tpXTsKICAgICAgICAgICAgY29uc3QgdHJpbW1lZExpbmUgPSBsaW5lLnRyaW0oKTsKCiAgICAgICAgICAgIGlmICh0cmltbWVkTGluZS5sZW5ndGggPCA4IHx8IHRyaW1tZWRMaW5lLm1hdGNoKC9eWyxcXHNcXHRdKiQvKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGNvbHVtbnMgPSB0cmltbWVkTGluZS5zcGxpdChzZXBhcmF0b3IpOwoKICAgICAgICAgICAgaWYgKGNvbHVtbnMubGVuZ3RoID4gcGhvbmVDb2x1bW5JbmRleCkgewogICAgICAgICAgICAgICAgbGV0IHJhd051bWJlciA9IGNvbHVtbnNbcGhvbmVDb2x1bW5JbmRleF0udHJpbSgpLnJlcGxhY2UoL1teMC05K10vZywgJycpOwoKICAgICAgICAgICAgICAgIGlmIChyYXdOdW1iZXIubGVuZ3RoID49IDgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3VudHJ5TmFtZSA9IGdldENvdW50cnlJbmZvKHJhd051bWJlcik7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb3VudHJ5TmFtZSAhPT0gIlVOS05PV04iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3RzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiByYXdOdW1iZXIuc3RhcnRzV2l0aCgnKycpID8gcmF3TnVtYmVyLnN1YnN0cmluZygxKSA6IHJhd051bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50cnk6IGNvdW50cnlOYW1lLnRvVXBwZXJDYXNlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PT0gJ3ZjZicpIHsKICAgICAgICBsZXQgZmlsZUNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMobG9jYWxQYXRoLCAndXRmOCcpOwogICAgICAgIGNvbnN0IGxpbmVzID0gZmlsZUNvbnRlbnQudHJpbSgpLnNwbGl0KCdcbicpOwoKICAgICAgICBjb25zdCB0ZWxSZWdleCA9IC9URUw7KD86VFlQRT1DRUxMfFRZUEU9V09SS3xUWVBFPUhPTUV8VFlQRT1WT0lDRXxWT0lDRXxDRUxMfFdPUkt8SE9NRSk6KFsrXSpcZCspL2k7CgogICAgICAgIGxpbmVzLmZvckVhY2gobGluZSA9PiB7CiAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gbGluZS5tYXRjaCh0ZWxSZWdleCk7CiAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgbGV0IHJhd051bWJlciA9IG1hdGNoWzFdLnRyaW0oKS5yZXBsYWNlKC9bXjAtOStdL2csICcnKTsKCiAgICAgICAgICAgICAgICBpZiAocmF3TnVtYmVyLnN0YXJ0c1dpdGgoJysnKSkgewogICAgICAgICAgICAgICAgICAgIHJhd051bWJlciA9IHJhd051bWJlci5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHJhd051bWJlci5sZW5ndGggPj0gOSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50cnlOYW1lID0gZ2V0Q291bnRyeUluZm8ocmF3TnVtYmVyKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvdW50cnlOYW1lICE9PSAiVU5LTk9XTiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGFjdHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXI6IHJhd051bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50cnk6IGNvdW50cnlOYW1lLnRvVXBwZXJDYXNlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT09ICd4bHN4JykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHdvcmtib29rID0gWExTWC5yZWFkRmlsZShsb2NhbFBhdGgpOwogICAgICAgICAgICBjb25zdCBzaGVldE5hbWUgPSB3b3JrYm9vay5TaGVldE5hbWVzWzBdOwogICAgICAgICAgICBjb25zdCB3b3Jrc2hlZXQgPSB3b3JrYm9vay5TaGVldHNbc2hlZXROYW1lXTsKCiAgICAgICAgICAgIGNvbnN0IGpzb24gPSBYTFNYLnV0aWxzLnNoZWV0X3RvX2pzb24od29ya3NoZWV0LCB7IGhlYWRlcjogMSB9KTsKCiAgICAgICAgICAgIGlmIChqc29uLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdOwoKICAgICAgICAgICAgbGV0IHBob25lQ29sdW1uSW5kZXggPSAtMTsKICAgICAgICAgICAgbGV0IHN0YXJ0SW5kZXggPSAwOwogICAgICAgICAgICBsZXQgbWF4VmFsaWRDb3VudCA9IDA7CiAgICAgICAgICAgIGNvbnN0IG1heENvbHMgPSBqc29uLnJlZHVjZSgobWF4LCByb3cpID0+IE1hdGgubWF4KG1heCwgcm93Lmxlbmd0aCksIDApOwogICAgICAgICAgICBjb25zdCBtYXhSb3dzQ2hlY2sgPSBNYXRoLm1pbihqc29uLmxlbmd0aCwgNTApOwoKICAgICAgICAgICAgZm9yIChsZXQgY29sSW5kZXggPSAwOyBjb2xJbmRleCA8IG1heENvbHM7IGNvbEluZGV4KyspIHsKICAgICAgICAgICAgICAgIGxldCB2YWxpZENvdW50ID0gMDsKICAgICAgICAgICAgICAgIGxldCBmaXJzdERhdGFSb3cgPSAtMTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1heFJvd3NDaGVjazsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm93ID0ganNvbltpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocm93Lmxlbmd0aCA+IGNvbEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbGxWYWx1ZSA9IFN0cmluZyhyb3dbY29sSW5kZXhdIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0xpa2VseVBob25lTnVtYmVyKGNlbGxWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdERhdGFSb3cgPT09IC0xKSBmaXJzdERhdGFSb3cgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh2YWxpZENvdW50ID49IDUgJiYgdmFsaWRDb3VudCA+IG1heFZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICBtYXhWYWxpZENvdW50ID0gdmFsaWRDb3VudDsKICAgICAgICAgICAgICAgICAgICBwaG9uZUNvbHVtbkluZGV4ID0gY29sSW5kZXg7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRJbmRleCA9IGZpcnN0RGF0YVJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBob25lQ29sdW1uSW5kZXggPT09IC0xIHx8IG1heFZhbGlkQ291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAobGV0IGkgPSBzdGFydEluZGV4OyBpIDwganNvbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3Qgcm93ID0ganNvbltpXTsKICAgICAgICAgICAgICAgIGlmIChyb3cubGVuZ3RoID4gcGhvbmVDb2x1bW5JbmRleCkgewogICAgICAgICAgICAgICAgICAgIGxldCByYXdOdW1iZXIgPSBTdHJpbmcocm93W3Bob25lQ29sdW1uSW5kZXhdIHx8ICcnKS50cmltKCkucmVwbGFjZSgvW14wLTkrXS9nLCAnJyk7CgogICAgICAgICAgICAgICAgICAgIGlmIChyYXdOdW1iZXIubGVuZ3RoID49IDgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY291bnRyeU5hbWUgPSBnZXRDb3VudHJ5SW5mbyhyYXdOdW1iZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvdW50cnlOYW1lICE9PSAiVU5LTk9XTiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3RzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogcmF3TnVtYmVyLnN0YXJ0c1dpdGgoJysnKSA/IHJhd051bWJlci5zdWJzdHJpbmcoMSkgOiByYXdOdW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnRyeTogY291bnRyeU5hbWUudG9VcHBlckNhc2UoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIltTVEFUVVNdIEVycm9yIHJlYWRpbmcgWExTWDoiLCBlKTsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCB1bmlxdWVDb250YWN0cyA9IEFycmF5LmZyb20obmV3IE1hcChjb250YWN0cy5tYXAoaXRlbSA9PiBbaXRlbS5udW1iZXIsIGl0ZW1dKSkudmFsdWVzKCkpOwogICAgcmV0dXJuIHVuaXF1ZUNvbnRhY3RzOwp9OwoKY29uc3QgZ2V0Q291bnRyeURhdGEgPSAoY29udGFjdHMpID0+IHsKICAgIGNvbnN0IGNvdW50cnlEYXRhID0ge307CiAgICBjb25zdCBjb3VudHJ5TGlzdCA9IFtdOwogICAgCiAgICBjb250YWN0cy5mb3JFYWNoKGNvbnRhY3QgPT4gewogICAgICAgIGlmICghY291bnRyeURhdGFbY29udGFjdC5jb3VudHJ5XSkgewogICAgICAgICAgICBjb3VudHJ5RGF0YVtjb250YWN0LmNvdW50cnldID0gMDsKICAgICAgICB9CiAgICAgICAgY291bnRyeURhdGFbY29udGFjdC5jb3VudHJ5XSsrOwogICAgfSk7CiAgICAKICAgIE9iamVjdC5rZXlzKGNvdW50cnlEYXRhKS5mb3JFYWNoKGNvdW50cnkgPT4gewogICAgICAgIGNvdW50cnlMaXN0LnB1c2goYCR7Z2V0Q291bnRyeUZsYWcoY291bnRyeSl9ICR7Y291bnRyeX06ICR7Y291bnRyeURhdGFbY291bnRyeV19IE51bWJlcmApOwogICAgfSk7CiAgICAKICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogY291bnRyeURhdGEsCiAgICAgICAgbGlzdDogY291bnRyeUxpc3Quam9pbignXG4nKQogICAgfTsKfTsKCmNvbnN0IHByb2Nlc3NDb250YWN0cyA9IChjb250YWN0cywgdGFyZ2V0VHlwZSwgc3BsaXRCeUNvdW50cnksIGNvdW50cnlEYXRhTWFwKSA9PiB7CiAgICBmcy5ta2RpclN5bmMoVEVNUF9ESVIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pOwogICAgY29uc3QgcmVzdWx0cyA9IFtdOwoKICAgIGNvbnN0IHdyaXRlQ29udGFjdEZpbGUgPSAoY291bnRyeU5hbWUsIGxpc3RDb250YWN0cykgPT4gewogICAgICAgIGNvbnN0IGNvdW50cnlGaWxlTmFtZSA9IGNvdW50cnlOYW1lLnJlcGxhY2UoL1tccy1dL2csICdfJyk7CiAgICAgICAgY29uc3QgdGFyZ2V0UGF0aCA9IHBhdGguam9pbihURU1QX0RJUiwgYCR7Y291bnRyeUZpbGVOYW1lfV8ke0RhdGUubm93KCl9X3RlbXAuJHt0YXJnZXRUeXBlfWApOwoKICAgICAgICBjb25zdCBjb250YWN0TnVtYmVycyA9IGxpc3RDb250YWN0cy5tYXAoYyA9PiBbYy5udW1iZXJdKTsKCiAgICAgICAgaWYgKHRhcmdldFR5cGUgPT09ICd4bHN4JykgewogICAgICAgICAgICBjb25zdCB3cyA9IFhMU1gudXRpbHMuYW9hX3RvX3NoZWV0KFtbJ05VTUJFUiddLCAuLi5jb250YWN0TnVtYmVyc10pOwogICAgICAgICAgICBjb25zdCB3YiA9IFhMU1gudXRpbHMuYm9va19uZXcoKTsKICAgICAgICAgICAgWExTWC51dGlscy5ib29rX2FwcGVuZF9zaGVldCh3Yiwgd3MsICJDb250YWN0cyIpOwogICAgICAgICAgICBYTFNYLndyaXRlRmlsZSh3YiwgdGFyZ2V0UGF0aCk7CgogICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0VHlwZSA9PT0gJ3ZjZicpIHsKICAgICAgICAgICAgbGV0IHZjZkNvbnRlbnQgPSAnJzsKICAgICAgICAgICAgbGlzdENvbnRhY3RzLmZvckVhY2goKGMpID0+IHsKICAgICAgICAgICAgICAgIHZjZkNvbnRlbnQgKz0gYEJFR0lOOlZDQVJEXG5WRVJTSU9OOjMuMFxuTjo7JHtjLm51bWJlcn07OztcbkZOOiR7Yy5udW1iZXJ9XG5URUw7VFlQRT1DRUxMOiR7Yy5udW1iZXJ9XG5FTkQ6VkNBUkRcbmA7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRhcmdldFBhdGgsIHZjZkNvbnRlbnQsICd1dGY4Jyk7CgogICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0VHlwZSA9PT0gJ2NzdicgfHwgdGFyZ2V0VHlwZSA9PT0gJ3R4dCcpIHsKICAgICAgICAgICAgbGV0IGZpbGVDb250ZW50ID0gJyc7CiAgICAgICAgICAgIGxpc3RDb250YWN0cy5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZnVsbE51bWJlciA9IGMubnVtYmVyOwogICAgICAgICAgICAgICAgZmlsZUNvbnRlbnQgKz0gYCR7ZnVsbE51bWJlcn1cbmA7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRhcmdldFBhdGgsIGZpbGVDb250ZW50LCAndXRmOCcpOwogICAgICAgIH0KCiAgICAgICAgcmVzdWx0cy5wdXNoKHsKICAgICAgICAgICAgcGF0aDogdGFyZ2V0UGF0aCwKICAgICAgICAgICAgY291bnRyeTogY291bnRyeU5hbWUsCiAgICAgICAgICAgIGNvdW50OiBsaXN0Q29udGFjdHMubGVuZ3RoLAogICAgICAgICAgICBzZXJ2aWNlTmFtZTogbnVsbAogICAgICAgIH0pOwogICAgfTsKCiAgICBpZiAoc3BsaXRCeUNvdW50cnkpIHsKICAgICAgICAvLyBHcm91cCBjb250YWN0cyBieSBjb3VudHJ5CiAgICAgICAgY29uc3QgY29udGFjdHNCeUNvdW50cnkgPSB7fTsKICAgICAgICBjb250YWN0cy5mb3JFYWNoKGNvbnRhY3QgPT4gewogICAgICAgICAgICBpZiAoIWNvbnRhY3RzQnlDb3VudHJ5W2NvbnRhY3QuY291bnRyeV0pIHsKICAgICAgICAgICAgICAgIGNvbnRhY3RzQnlDb3VudHJ5W2NvbnRhY3QuY291bnRyeV0gPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb250YWN0c0J5Q291bnRyeVtjb250YWN0LmNvdW50cnldLnB1c2goY29udGFjdCk7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgLy8gQnVhdCBmaWxlIHVudHVrIHNldGlhcCBuZWdhcmEKICAgICAgICBmb3IgKGNvbnN0IGNvdW50cnlOYW1lIGluIGNvbnRhY3RzQnlDb3VudHJ5KSB7CiAgICAgICAgICAgIGlmIChjb250YWN0c0J5Q291bnRyeVtjb3VudHJ5TmFtZV0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgd3JpdGVDb250YWN0RmlsZShjb3VudHJ5TmFtZSwgY29udGFjdHNCeUNvdW50cnlbY291bnRyeU5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gUGVyaWtzYSBiZXJhcGEgYmFueWFrIG5lZ2FyYSB1bmlrIGRhbGFtIGtvbnRhawogICAgICAgIGNvbnN0IHVuaXF1ZUNvdW50cmllcyA9IFsuLi5uZXcgU2V0KGNvbnRhY3RzLm1hcChjID0+IGMuY291bnRyeSkpXTsKICAgICAgICAKICAgICAgICBpZiAodW5pcXVlQ291bnRyaWVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAvLyBKaWthIGhhbnlhIGFkYSAxIG5lZ2FyYSwgZ3VuYWthbiBuYW1hIG5lZ2FyYSB0ZXJzZWJ1dAogICAgICAgICAgICBjb25zdCBzaW5nbGVDb3VudHJ5TmFtZSA9IHVuaXF1ZUNvdW50cmllc1swXTsKICAgICAgICAgICAgd3JpdGVDb250YWN0RmlsZShzaW5nbGVDb3VudHJ5TmFtZSwgY29udGFjdHMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIEppa2EgYWRhIG11bHRpcGxlIGNvdW50cmllcywgZ3VuYWthbiAnQUxMX0NPVU5UUklFUycKICAgICAgICAgICAgd3JpdGVDb250YWN0RmlsZSgnQUxMX0NPVU5UUklFUycsIGNvbnRhY3RzKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdHM7Cn07Cgpjb25zdCBzZW5kQ29udmVydGVkRmlsZXMgPSBhc3luYyAoY3R4LCBjdkRhdGEpID0+IHsKICAgIGNvbnN0IHVzZXJJZCA9IGN0eC5mcm9tLmlkOwogICAgY29uc3Qgd2FpdE1lc3NhZ2UgPSBhd2FpdCBjdHgucmVwbHlXaXRoSFRNTCgi4o+zIFNlZGFuZyBtZW5na29udmVyc2kgZGFuIG1lbmdpcmltIGZpbGUuLi4iKTsKCiAgICB0cnkgewogICAgICAgIGNvbnN0IGZpbGVzVG9TZW5kID0gY3ZEYXRhLmZpbGVMaXN0OwoKICAgICAgICBpZiAoIWZpbGVzVG9TZW5kIHx8IGZpbGVzVG9TZW5kLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBhd2FpdCBjdHgudGVsZWdyYW0uZGVsZXRlTWVzc2FnZShjdHguY2hhdC5pZCwgd2FpdE1lc3NhZ2UubWVzc2FnZV9pZCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgIGF3YWl0IGN0eC5yZXBseVdpdGhIVE1MKCLinYwgVGlkYWsgYWRhIGZpbGUgeWFuZyBkYXBhdCBkaWtpcmltLiIpOwogICAgICAgICAgICByZXNldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCkudG9Mb2NhbGVEYXRlU3RyaW5nKCdpZC1JRCcsIHsKICAgICAgICAgICAgeWVhcjogJ251bWVyaWMnLCBtb250aDogJ2xvbmcnLCBkYXk6ICdudW1lcmljJwogICAgICAgIH0pOwoKICAgICAgICBmb3IgKGNvbnN0IGZpbGVJbmZvIG9mIGZpbGVzVG9TZW5kKSB7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsU2VydmljZU5hbWUgPSBmaWxlSW5mby5zZXJ2aWNlTmFtZSB8fCBjdkRhdGEuc2VydmljZU5hbWUgfHwgJ05vX1NlcnZpY2UnOwogICAgICAgICAgICBjb25zdCBjb3VudHJ5RmxhZyA9IGdldENvdW50cnlGbGFnKGZpbGVJbmZvLmNvdW50cnkpOwoKICAgICAgICAgICAgY29uc3QgY291bnRyeUZpbGVOYW1lID0gZmlsZUluZm8uY291bnRyeS5yZXBsYWNlKC9bXHMtXS9nLCAnXycpOwogICAgICAgICAgICBjb25zdCBzZXJ2aWNlRmlsZU5hbWUgPSBmaW5hbFNlcnZpY2VOYW1lLnJlcGxhY2UoL1tccy1dL2csICdfJyk7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsRmlsZU5hbWUgPSBgJHtjb3VudHJ5RmxhZ31fJHtjb3VudHJ5RmlsZU5hbWV9XyR7c2VydmljZUZpbGVOYW1lfV8ke2ZpbGVJbmZvLmNvdW50fS4ke2N2RGF0YS50YXJnZXRUeXBlfWA7CgogICAgICAgICAgICBjb25zdCBmaW5hbENhcHRpb24gPSBgPGJsb2NrcXVvdGU+JHtjb3VudHJ5RmxhZ30gJHtmaWxlSW5mby5jb3VudHJ5LnRvVXBwZXJDYXNlKCl9PC9ibG9ja3F1b3RlPgrilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIEKJHtmaWxlSW5mby5jb3VudH0gTnVtYmVyCiR7ZmluYWxTZXJ2aWNlTmFtZX0K4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCjxiPjxpPkRhdGUgOiAke2N1cnJlbnREYXRlfTwvaT48L2I+YC50cmltKCk7CgogICAgICAgICAgICBhd2FpdCBjdHgucmVwbHlXaXRoRG9jdW1lbnQoeyBzb3VyY2U6IGZpbGVJbmZvLnBhdGgsIGZpbGVuYW1lOiBmaW5hbEZpbGVOYW1lIH0sIHsgCiAgICAgICAgICAgICAgICBjYXB0aW9uOiBmaW5hbENhcHRpb24sIAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZTogJ0hUTUwnIAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIENsZWFudXAgZmlsZSB0ZW1wb3JhcnkKICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZUluZm8ucGF0aCkpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMudW5saW5rU3luYyhmaWxlSW5mby5wYXRoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJbU1RBVFVTXSBHYWdhbCBtZW5naGFwdXMgZmlsZSBzZW1lbnRhcmE6IiwgZS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXdhaXQgY3R4LnRlbGVncmFtLmRlbGV0ZU1lc3NhZ2UoY3R4LmNoYXQuaWQsIHdhaXRNZXNzYWdlLm1lc3NhZ2VfaWQpLmNhdGNoKGUgPT4ge30pOwogICAgICAgIGF3YWl0IGN0eC5yZXBseVdpdGhIVE1MKGDinIUgU2VsZXNhaSEgJHtmaWxlc1RvU2VuZC5sZW5ndGh9IGZpbGUgYmVyaGFzaWwgZGlraXJpbS5gKTsKICAgICAgICAKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiW1NUQVRVU10gRXJyb3Igc2FhdCBtZW5naXJpbSBmaWxlIGtvbnZlcnNpOiIsIGVycm9yKTsKICAgICAgICBhd2FpdCBjdHgudGVsZWdyYW0uZGVsZXRlTWVzc2FnZShjdHguY2hhdC5pZCwgd2FpdE1lc3NhZ2UubWVzc2FnZV9pZCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgYXdhaXQgY3R4LnJlcGx5V2l0aEhUTUwoYOKdjCBFcnJvcjogJHtlcnJvci5tZXNzYWdlfWApOwogICAgfSBmaW5hbGx5IHsKICAgICAgICByZXNldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgfQp9OwoKY29uc3Qgc2hvd1NwbGl0T3B0aW9ucyA9IGFzeW5jIChjdHgsIHN0YXRlLCB0YXJnZXRUeXBlKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlSWQgPSBzdGF0ZS5kYXRhLm1lc3NhZ2VJZDsKICAgIGNvbnN0IG51bUNvdW50cmllcyA9IE9iamVjdC5rZXlzKHN0YXRlLmRhdGEuY291bnRyeURhdGEpLmxlbmd0aDsKICAgIHN0YXRlLmRhdGEudGFyZ2V0VHlwZSA9IHRhcmdldFR5cGU7CgogICAgY29uc3QgbmV3VGV4dCA9IGA8cHJlPkNvbnZlcnQgU3RhdHVzCgrinqHvuI8gUGlsaWhhbiBGb3JtYXQgOiAke3RhcmdldFR5cGUudG9VcHBlckNhc2UoKX0K4p6h77iPIEp1bWxhaCBOZWdhcmEgOiAke251bUNvdW50cmllc30KJHtudW1Db3VudHJpZXMgPiAxID8KICAgIGBUZXJkZXRla3NpICR7bnVtQ291bnRyaWVzfSBuZWdhcmEuIEFwYWthaCBBbmRhIGluZ2luIFtwaXNhaF0gZmlsZSBwZXIgbmVnYXJhIGF0YXUgW2dhYnVuZ10gbWVuamFkaSBzYXR1IGZpbGU/YCA6CiAgICBgSGFueWEgdGVyZGV0ZWtzaSAxIG5lZ2FyYS4gU2lsYWthbiBsYW5qdXQuYAp9PC9wcmU+YDsKCiAgICBjb25zdCBrZXlib2FyZCA9IE1hcmt1cC5pbmxpbmVLZXlib2FyZChbCiAgICAgICAgW01hcmt1cC5idXR0b24uY2FsbGJhY2soJ1BJU0FIJywgJ2N2X3NwbGl0X3RydWUnKSwgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygnR0FCVU5HJywgJ2N2X3NwbGl0X2ZhbHNlJyldCiAgICBdKTsKCiAgICBzdGF0ZS5zdGVwID0gJ3NlcnZpY2Vfc2VsZWN0aW9uJzsKICAgIAogICAgaWYgKG51bUNvdW50cmllcyA8PSAxKSB7CiAgICAgICAgc3RhdGUuZGF0YS5zcGxpdEJ5Q291bnRyeSA9IGZhbHNlOwogICAgICAgIGF3YWl0IHNob3dTZXJ2aWNlT3B0aW9ucyhjdHgsIHN0YXRlKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgbWVzc2FnZUlkLCBuZXdUZXh0LCBrZXlib2FyZCk7Cn07Cgpjb25zdCBzaG93U2VydmljZU9wdGlvbnMgPSBhc3luYyAoY3R4LCBzdGF0ZSkgPT4gewogICAgY29uc3QgbWVzc2FnZUlkID0gc3RhdGUuZGF0YS5tZXNzYWdlSWQ7CiAgICBjb25zdCBudW1Db3VudHJpZXMgPSBPYmplY3Qua2V5cyhzdGF0ZS5kYXRhLmNvdW50cnlEYXRhKS5sZW5ndGg7CgogICAgc3RhdGUuZGF0YS5maWxlTGlzdCA9IHByb2Nlc3NDb250YWN0cyhzdGF0ZS5kYXRhLmNvbnRhY3RzLCBzdGF0ZS5kYXRhLnRhcmdldFR5cGUsIHN0YXRlLmRhdGEuc3BsaXRCeUNvdW50cnksIHN0YXRlLmRhdGEuY291bnRyeURhdGEpOwoKICAgIGNvbnN0IGZpbGVzVG9DcmVhdGUgPSBzdGF0ZS5kYXRhLmZpbGVMaXN0Lmxlbmd0aDsKICAgIGNvbnN0IHNwbGl0VGV4dCA9IHN0YXRlLmRhdGEuc3BsaXRCeUNvdW50cnkgPyAnUElTQUgnIDogKG51bUNvdW50cmllcyA+IDEgPyAnR0FCVU5HJyA6ICdTQVRVJyk7CgogICAgY29uc3QgbmV3VGV4dCA9IGA8cHJlPkNvbnZlcnQgU3RhdHVzCgrinqHvuI8gRm9ybWF0IEtvbnZlcnNpIDogJHtzdGF0ZS5kYXRhLnRhcmdldFR5cGUudG9VcHBlckNhc2UoKX0K4p6h77iPIE1vZGUgRmlsZSA6ICR7c3BsaXRUZXh0fSAoJHtmaWxlc1RvQ3JlYXRlfSBmaWxlIGFrYW4gZGlidWF0KQoKU2lsYWthbiBrb25maXJtYXNpIHRlcmxlYmloIGRhaHVsdTogU2VydmljZSBha2FuIGRpaXNpIHNhdHUtc2F0dSAocGVyIGZpbGUpIGF0YXUgbGFuZ3N1bmcgc2VtdWEgZGVuZ2FuIG5hbWEgc2VydmljZSB5YW5nIHNhbWEuLj8KPC9wcmU+YDsKCiAgICBzdGF0ZS5zdGVwID0gJ3NlcnZpY2VfaW5wdXRfbW9kZSc7CgogICAgY29uc3Qga2V5Ym9hcmQgPSBNYXJrdXAuaW5saW5lS2V5Ym9hcmQoWwogICAgICAgIFtNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCdTQVRVQU4nLCAnY3Zfc2VydmljZV9tb2RlX3NpbmdsZScpLCBNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCdTRU1VQScsICdjdl9zZXJ2aWNlX21vZGVfYWxsJyldCiAgICBdKTsKCiAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBtZXNzYWdlSWQsIG5ld1RleHQsIGtleWJvYXJkKTsKfTsKCmJvdC5jb21tYW5kKCdjdicsIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgdXNlcklkID0gY3R4LmZyb20uaWQ7CiAgICAKICAgIC8vIENsZWFyIGFueSBleGlzdGluZyBzdGF0ZQogICAgcmVzZXRVc2VyU3RhdGUodXNlcklkKTsKICAgIAogICAgbGV0IGRvYyA9IG51bGw7CiAgICBsZXQgbG9jYWxQYXRoID0gbnVsbDsKCiAgICAvLyBDYXNlIDE6IFJlcGx5IHRvIGEgZmlsZSB3aXRoIC9jdgogICAgaWYgKGN0eC5tZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2UgJiYgY3R4Lm1lc3NhZ2UucmVwbHlfdG9fbWVzc2FnZS5kb2N1bWVudCkgewogICAgICAgIGRvYyA9IGN0eC5tZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2UuZG9jdW1lbnQ7CiAgICB9CiAgICAvLyBDYXNlIDI6IE1lc3NhZ2Ugd2l0aCBkb2N1bWVudCBhbmQgY2FwdGlvbiAvY3YKICAgIGVsc2UgaWYgKGN0eC5tZXNzYWdlLmRvY3VtZW50KSB7CiAgICAgICAgY29uc3QgbWVzc2FnZVRleHQgPSBjdHgubWVzc2FnZS50ZXh0IHx8ICcnOwogICAgICAgIGlmIChtZXNzYWdlVGV4dC50cmltKCkgPT09ICcvY3YnIHx8IG1lc3NhZ2VUZXh0LmluY2x1ZGVzKCcvY3YgJykpIHsKICAgICAgICAgICAgZG9jID0gY3R4Lm1lc3NhZ2UuZG9jdW1lbnQ7CiAgICAgICAgfQogICAgfQoKICAgIGlmICghZG9jKSB7CiAgICAgICAgcmV0dXJuIHJlcGx5SFRNTChjdHgsCiAgICAgICAgICAgIGA8cHJlPkVycm9yCgrimqDvuI8gQ2FyYSBwZW5nZ3VuYWFuOgoxLiBCYWxhcyBmaWxlIGRlbmdhbiBtZW5nZXRpayAvY3YKMi4gQXRhdSBraXJpbSBmaWxlIGRlbmdhbiBjYXB0aW9uIC9jdgoKRm9ybWF0IGZpbGUgeWFuZyBkaWR1a3VuZzoKLmNzdiwgLnR4dCwgLnZjZiwgLnhsc3gsIC54bHM8L3ByZT5gLAogICAgICAgICAgICB7IHJlcGx5X3RvX21lc3NhZ2VfaWQ6IGN0eC5tZXNzYWdlLm1lc3NhZ2VfaWQgfQogICAgICAgICk7CiAgICB9CgogICAgdHJ5IHsKICAgICAgICBjb25zdCBmaWxlTmFtZSA9IGRvYy5maWxlX25hbWUgfHwgJ2ZpbGUnOwogICAgICAgIGNvbnN0IGluaXRpYWxUeXBlID0gZGV0ZWN0VHlwZUJ5TmFtZShmaWxlTmFtZSk7CgogICAgICAgIGlmICghaW5pdGlhbFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIHJlcGx5SFRNTChjdHgsCiAgICAgICAgICAgICAgICBgPHByZT5FcnJvcgoK4p2MIEZvcm1hdCBmaWxlIHRpZGFrIGRpZHVrdW5nLgpGb3JtYXQgeWFuZyBkaWR1a3VuZzogLmNzdiwgLnR4dCwgLnZjZiwgLnhsc3gsIC54bHM8L3ByZT5gLAogICAgICAgICAgICAgICAgeyByZXBseV90b19tZXNzYWdlX2lkOiBjdHgubWVzc2FnZS5tZXNzYWdlX2lkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGRvd25sb2FkTXNnID0gYXdhaXQgcmVwbHlIVE1MKGN0eCwKICAgICAgICAgICAgYDxwcmU+Q29udmVydCBTdGF0dXMKCuKPsyBNZW5ndW5kdWggZmlsZSAke2ZpbGVOYW1lfS4uLjwvcHJlPmAsCiAgICAgICAgICAgIHsgcmVwbHlfdG9fbWVzc2FnZV9pZDogY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZCB9CiAgICAgICAgKTsKCiAgICAgICAgbG9jYWxQYXRoID0gYXdhaXQgZG93bmxvYWRGaWxlKGRvYy5maWxlX2lkLCBmaWxlTmFtZSk7CgogICAgICAgIHRyeSB7IGF3YWl0IGN0eC50ZWxlZ3JhbS5kZWxldGVNZXNzYWdlKGN0eC5jaGF0LmlkLCBkb3dubG9hZE1zZy5tZXNzYWdlX2lkKTsgfSBjYXRjaCB7IH0KCiAgICAgICAgY29uc3QgY29udGFjdHMgPSByZWFkQ29udGFjdHMobG9jYWxQYXRoLCBpbml0aWFsVHlwZSkgfHwgW107CgogICAgICAgIGlmIChjb250YWN0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHJlcGx5SFRNTChjdHgsCiAgICAgICAgICAgICAgICBgPHByZT5FcnJvcgoK4p2MIFRpZGFrIGFkYSBub21vciB0ZWxlcG9uIHlhbmcgdGVyZGV0ZWtzaSBkYWxhbSBmaWxlLgpQYXN0aWthbiBmaWxlIG1lbWlsaWtpIGtvbG9tIG5vbW9yIHRlbGVwb24geWFuZyB2YWxpZC48L3ByZT5gLAogICAgICAgICAgICAgICAgeyByZXBseV90b19tZXNzYWdlX2lkOiBjdHgubWVzc2FnZS5tZXNzYWdlX2lkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHsgZGF0YTogY291bnRyeURhdGEsIGxpc3Q6IGNvdW50cnlMaXN0IH0gPSBnZXRDb3VudHJ5RGF0YShjb250YWN0cyk7CiAgICAgICAgY29uc3QgbnVtQ291bnRyaWVzID0gT2JqZWN0LmtleXMoY291bnRyeURhdGEpLmxlbmd0aDsKCiAgICAgICAgLy8gU2V0IHN0YXRlIHVudHVrIENWIGRlbmdhbiBzaXN0ZW0gYmFydQogICAgICAgIGNvbnN0IHN0YXRlID0gc2V0VXNlclN0YXRlKHVzZXJJZCwgJ0NWJywgewogICAgICAgICAgICBjb250YWN0czogY29udGFjdHMsCiAgICAgICAgICAgIGNvdW50cnlEYXRhOiBjb3VudHJ5RGF0YSwKICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGVOYW1lLAogICAgICAgICAgICBmaWxlVHlwZTogaW5pdGlhbFR5cGUsCiAgICAgICAgICAgIGNoYXRJZDogY3R4LmNoYXQuaWQsCiAgICAgICAgICAgIHRhcmdldFR5cGU6ICcnLAogICAgICAgICAgICBzcGxpdEJ5Q291bnRyeTogZmFsc2UsCiAgICAgICAgICAgIHNlcnZpY2VNb2RlOiBudWxsLAogICAgICAgICAgICBmaWxlTGlzdDogW10sCiAgICAgICAgICAgIGN1cnJlbnRGaWxlSW5kZXg6IDAsCiAgICAgICAgICAgIHNlcnZpY2VOYW1lOiBudWxsCiAgICAgICAgfSk7CiAgICAgICAgc3RhdGUuc3RlcCA9ICdjb3VudHJ5X3NwbGl0X3NlbGVjdGlvbic7CgogICAgICAgIGNvbnN0IGluZm8gPSBgPHByZT5Db252ZXJ0IFN0YXR1cwoK8J+ThCBGaWxlIEFzbGk6ICR7ZmlsZU5hbWV9ICgke2luaXRpYWxUeXBlLnRvVXBwZXJDYXNlKCl9KQrwn5GlIFRvdGFsIE5vbW9yOiAke2NvbnRhY3RzLmxlbmd0aH0KCvCfk4sgRGFmdGFyIE5lZ2FyYSBUZXJkZXRla3NpICgke251bUNvdW50cmllc30gTmVnYXJhKToKJHtjb3VudHJ5TGlzdH0KCuKchSBTaWxha2FuIHBpbGloIGZvcm1hdCBrb252ZXJzaSB5YW5nIEFuZGEgaW5naW5rYW4uPC9wcmU+YDsKCiAgICAgICAgY29uc3QgYnV0dG9ucyA9IFsKICAgICAgICAgICAgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygn8J+ThCBUWFQnLCAnY3ZfdG9fdHh0JyksCiAgICAgICAgICAgIE1hcmt1cC5idXR0b24uY2FsbGJhY2soJ/Cfk5ggWExTWCcsICdjdl90b194bHN4JyksCiAgICAgICAgICAgIE1hcmt1cC5idXR0b24uY2FsbGJhY2soJ/Cfk7EgVkNGJywgJ2N2X3RvX3ZjZicpLAogICAgICAgICAgICBNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCfwn5OOIENTVicsICdjdl90b19jc3YnKQogICAgICAgIF07CgogICAgICAgIGNvbnN0IHNlbnRNZXNzYWdlID0gYXdhaXQgcmVwbHlIVE1MKGN0eCwgaW5mbywgTWFya3VwLmlubGluZUtleWJvYXJkKGNodW5rQXJyYXkoYnV0dG9ucywgMikpKTsKICAgICAgICBzdGF0ZS5kYXRhLm1lc3NhZ2VJZCA9IHNlbnRNZXNzYWdlLm1lc3NhZ2VfaWQ7CgogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIltTVEFUVVNdIEVycm9yIENWOiIsIGUubWVzc2FnZSk7CiAgICAgICAgcmV0dXJuIHJlcGx5SFRNTChjdHgsCiAgICAgICAgICAgIGA8cHJlPkVycm9yCgrinYwgVGVyamFkaSBrZXNhbGFoYW4gc2FhdCBtZW1wcm9zZXMgZmlsZToKJHtlLm1lc3NhZ2V9PC9wcmU+YCwKICAgICAgICAgICAgeyByZXBseV90b19tZXNzYWdlX2lkOiBjdHgubWVzc2FnZS5tZXNzYWdlX2lkIH0KICAgICAgICApOwogICAgfSBmaW5hbGx5IHsKICAgICAgICBpZiAobG9jYWxQYXRoICYmIGZzLmV4aXN0c1N5bmMobG9jYWxQYXRoKSkgewogICAgICAgICAgICB0cnkgeyBmcy51bmxpbmtTeW5jKGxvY2FsUGF0aCk7IH0gY2F0Y2ggeyB9CiAgICAgICAgfQogICAgfQp9KTsKCmJvdC5hY3Rpb24oL2N2X3RvXyh0eHR8eGxzeHx2Y2Z8Y3N2KS8sIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgdXNlcklkID0gY3R4LmZyb20uaWQ7CiAgICBjb25zdCBzdGF0ZSA9IGdldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgCiAgICBpZiAoIXN0YXRlIHx8IHN0YXRlLnR5cGUgIT09ICdDVicgfHwgc3RhdGUuc3RlcCAhPT0gJ2NvdW50cnlfc3BsaXRfc2VsZWN0aW9uJykgewogICAgICAgIGF3YWl0IGN0eC5hbnN3ZXJDYlF1ZXJ5KCfimqDvuI8gU2VzaSBiZXJha2hpci4nKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgdGFyZ2V0VHlwZSA9IGN0eC5tYXRjaFsxXTsKICAgIAogICAgLy8gVXBkYXRlIHN0YXRlCiAgICBzdGF0ZS5kYXRhLnRhcmdldFR5cGUgPSB0YXJnZXRUeXBlOwogICAgY29uc3QgbnVtQ291bnRyaWVzID0gT2JqZWN0LmtleXMoc3RhdGUuZGF0YS5jb3VudHJ5RGF0YSkubGVuZ3RoOwoKICAgIGNvbnN0IG5ld1RleHQgPSBgPHByZT5Db252ZXJ0IFN0YXR1cwoK4p6h77iPIFBpbGloYW4gRm9ybWF0IDogJHt0YXJnZXRUeXBlLnRvVXBwZXJDYXNlKCl9CuKeoe+4jyBKdW1sYWggTmVnYXJhIDogJHtudW1Db3VudHJpZXN9CiR7bnVtQ291bnRyaWVzID4gMSA/CiAgICBgVGVyZGV0ZWtzaSAke251bUNvdW50cmllc30gbmVnYXJhLiBBcGFrYWggQW5kYSBpbmdpbiBbcGlzYWhdIGZpbGUgcGVyIG5lZ2FyYSBhdGF1IFtnYWJ1bmddIG1lbmphZGkgc2F0dSBmaWxlP2AgOgogICAgYEhhbnlhIHRlcmRldGVrc2kgMSBuZWdhcmEuIFNpbGFrYW4gbGFuanV0LmAKfTwvcHJlPmA7CgogICAgaWYgKG51bUNvdW50cmllcyA8PSAxKSB7CiAgICAgICAgc3RhdGUuZGF0YS5zcGxpdEJ5Q291bnRyeSA9IGZhbHNlOwogICAgICAgIHN0YXRlLnN0ZXAgPSAnc2VydmljZV9zZWxlY3Rpb24nOwogICAgICAgIHN0YXRlLmRhdGEuZmlsZUxpc3QgPSBwcm9jZXNzQ29udGFjdHMoc3RhdGUuZGF0YS5jb250YWN0cywgc3RhdGUuZGF0YS50YXJnZXRUeXBlLCBzdGF0ZS5kYXRhLnNwbGl0QnlDb3VudHJ5LCBzdGF0ZS5kYXRhLmNvdW50cnlEYXRhKTsKICAgICAgICAKICAgICAgICBjb25zdCBmaWxlc1RvQ3JlYXRlID0gc3RhdGUuZGF0YS5maWxlTGlzdC5sZW5ndGg7CiAgICAgICAgY29uc3QgbmV3VGV4dDIgPSBgPHByZT5Db252ZXJ0IFN0YXR1cwoK4p6h77iPIEZvcm1hdCBLb252ZXJzaSA6ICR7c3RhdGUuZGF0YS50YXJnZXRUeXBlLnRvVXBwZXJDYXNlKCl9CuKeoe+4jyBNb2RlIEZpbGUgOiBTQVRVICgke2ZpbGVzVG9DcmVhdGV9IGZpbGUgYWthbiBkaWJ1YXQpCgpTaWxha2FuIGtvbmZpcm1hc2kgdGVybGViaWggZGFodWx1OiBTZXJ2aWNlIGFrYW4gZGlpc2kgc2F0dS1zYXR1IChwZXIgZmlsZSkgYXRhdSBsYW5nc3VuZyBzZW11YSBkZW5nYW4gbmFtYSBzZXJ2aWNlIHlhbmcgc2FtYS4uPwo8L3ByZT5gOwoKICAgICAgICBzdGF0ZS5zdGVwID0gJ3NlcnZpY2VfaW5wdXRfbW9kZSc7CiAgICAgICAgY29uc3Qga2V5Ym9hcmQgPSBNYXJrdXAuaW5saW5lS2V5Ym9hcmQoWwogICAgICAgICAgICBbTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygnU0FUVUFOJywgJ2N2X3NlcnZpY2VfbW9kZV9zaW5nbGUnKSwgTWFya3VwLmJ1dHRvbi5jYWxsYmFjaygnU0VNVUEnLCAnY3Zfc2VydmljZV9tb2RlX2FsbCcpXQogICAgICAgIF0pOwoKICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBzdGF0ZS5kYXRhLm1lc3NhZ2VJZCwgbmV3VGV4dDIsIGtleWJvYXJkKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3Qga2V5Ym9hcmQgPSBNYXJrdXAuaW5saW5lS2V5Ym9hcmQoWwogICAgICAgIFtNYXJrdXAuYnV0dG9uLmNhbGxiYWNrKCdQSVNBSCcsICdjdl9zcGxpdF90cnVlJyksIE1hcmt1cC5idXR0b24uY2FsbGJhY2soJ0dBQlVORycsICdjdl9zcGxpdF9mYWxzZScpXQogICAgXSk7CgogICAgc3RhdGUuc3RlcCA9ICdzZXJ2aWNlX3NlbGVjdGlvbic7CiAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCBzdGF0ZS5kYXRhLm1lc3NhZ2VJZCwgbmV3VGV4dCwga2V5Ym9hcmQpOwp9KTsKCmJvdC5hY3Rpb24oL2N2X3NwbGl0Xyh0cnVlfGZhbHNlKS8sIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgdXNlcklkID0gY3R4LmZyb20uaWQ7CiAgICBjb25zdCBzdGF0ZSA9IGdldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgCiAgICBpZiAoIXN0YXRlIHx8IHN0YXRlLnR5cGUgIT09ICdDVicgfHwgc3RhdGUuc3RlcCAhPT0gJ3NlcnZpY2Vfc2VsZWN0aW9uJykgewogICAgICAgIGF3YWl0IGN0eC5hbnN3ZXJDYlF1ZXJ5KCfimqDvuI8gU2VzaSBiZXJha2hpci4nKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgc3RhdGUuZGF0YS5zcGxpdEJ5Q291bnRyeSA9IGN0eC5tYXRjaFsxXSA9PT0gJ3RydWUnOwogICAgc3RhdGUuZGF0YS5maWxlTGlzdCA9IHByb2Nlc3NDb250YWN0cyhzdGF0ZS5kYXRhLmNvbnRhY3RzLCBzdGF0ZS5kYXRhLnRhcmdldFR5cGUsIHN0YXRlLmRhdGEuc3BsaXRCeUNvdW50cnksIHN0YXRlLmRhdGEuY291bnRyeURhdGEpOwoKICAgIGNvbnN0IGZpbGVzVG9DcmVhdGUgPSBzdGF0ZS5kYXRhLmZpbGVMaXN0Lmxlbmd0aDsKICAgIGNvbnN0IHNwbGl0VGV4dCA9IHN0YXRlLmRhdGEuc3BsaXRCeUNvdW50cnkgPyAnUElTQUgnIDogJ0dBQlVORyc7CiAgICBjb25zdCBudW1Db3VudHJpZXMgPSBPYmplY3Qua2V5cyhzdGF0ZS5kYXRhLmNvdW50cnlEYXRhKS5sZW5ndGg7CgogICAgY29uc3QgbmV3VGV4dCA9IGA8cHJlPkNvbnZlcnQgU3RhdHVzCgrinqHvuI8gRm9ybWF0IEtvbnZlcnNpIDogJHtzdGF0ZS5kYXRhLnRhcmdldFR5cGUudG9VcHBlckNhc2UoKX0K4p6h77iPIE1vZGUgRmlsZSA6ICR7c3BsaXRUZXh0fSAoJHtmaWxlc1RvQ3JlYXRlfSBmaWxlIGFrYW4gZGlidWF0KQoKU2lsYWthbiBrb25maXJtYXNpIHRlcmxlYmloIGRhaHVsdTogU2VydmljZSBha2FuIGRpaXNpIHNhdHUtc2F0dSAocGVyIGZpbGUpIGF0YXUgbGFuZ3N1bmcgc2VtdWEgZGVuZ2FuIG5hbWEgc2VydmljZSB5YW5nIHNhbWEuLj8KPC9wcmU+YDsKCiAgICBzdGF0ZS5zdGVwID0gJ3NlcnZpY2VfaW5wdXRfbW9kZSc7CiAgICBjb25zdCBrZXlib2FyZCA9IE1hcmt1cC5pbmxpbmVLZXlib2FyZChbCiAgICAgICAgW01hcmt1cC5idXR0b24uY2FsbGJhY2soJ1NBVFVBTicsICdjdl9zZXJ2aWNlX21vZGVfc2luZ2xlJyksIE1hcmt1cC5idXR0b24uY2FsbGJhY2soJ1NFTVVBJywgJ2N2X3NlcnZpY2VfbW9kZV9hbGwnKV0KICAgIF0pOwoKICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHN0YXRlLmRhdGEubWVzc2FnZUlkLCBuZXdUZXh0LCBrZXlib2FyZCk7Cn0pOwoKYm90LmFjdGlvbigvY3Zfc2VydmljZV9tb2RlXyhzaW5nbGV8YWxsKS8sIG93bmVyT25seSwgYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3QgdXNlcklkID0gY3R4LmZyb20uaWQ7CiAgICBjb25zdCBzdGF0ZSA9IGdldFVzZXJTdGF0ZSh1c2VySWQpOwogICAgCiAgICBpZiAoIXN0YXRlIHx8IHN0YXRlLnR5cGUgIT09ICdDVicgfHwgc3RhdGUuc3RlcCAhPT0gJ3NlcnZpY2VfaW5wdXRfbW9kZScpIHsKICAgICAgICBhd2FpdCBjdHguYW5zd2VyQ2JRdWVyeSgn4pqg77iPIFNlc2kgYmVyYWtoaXIuJyk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IG1vZGUgPSBjdHgubWF0Y2hbMV07CiAgICBzdGF0ZS5kYXRhLnNlcnZpY2VNb2RlID0gbW9kZTsKICAgIHN0YXRlLmRhdGEuY3VycmVudEZpbGVJbmRleCA9IDA7CgogICAgYXdhaXQgY3R4LmFuc3dlckNiUXVlcnkobW9kZSA9PT0gJ3NpbmdsZScgPyAnTW9kZSBTYXR1YW4gZGlwaWxpaC4nIDogJ01vZGUgU2VtdWEgZGlwaWxpaC4nKTsKCiAgICBpZiAobW9kZSA9PT0gJ3NpbmdsZScpIHsKICAgICAgICBzdGF0ZS5zdGVwID0gJ2F3YWl0aW5nX3NpbmdsZV9zZXJ2aWNlX2lucHV0JzsKICAgICAgICBjb25zdCBjdXJyZW50RmlsZSA9IHN0YXRlLmRhdGEuZmlsZUxpc3RbMF07CiAgICAgICAgY29uc3QgbmV3VGV4dCA9IGA8cHJlPkNvbnZlcnQgU3RhdHVzCgrinqHvuI8gU2VydmljZSBNb2RlIDogU0FUVUFOICgke3N0YXRlLmRhdGEuZmlsZUxpc3QubGVuZ3RofSBGaWxlKQoKU2lsYWthbiBiZXJpa2FuIG5hbWEgU2VydmljZSAoQ29udG9oOiBXaGF0c0FwcCwgR29vZ2xlLCBkbGwuKSB1bnR1ayBmaWxlIDEgZGFyaSAke3N0YXRlLmRhdGEuZmlsZUxpc3QubGVuZ3RofSA6CiR7Z2V0Q291bnRyeUZsYWcoY3VycmVudEZpbGUuY291bnRyeSl9ICR7Y3VycmVudEZpbGUuY291bnRyeX0gKCR7Y3VycmVudEZpbGUuY291bnR9IE51bWJlcik8L3ByZT4KYDsKCiAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgc3RhdGUuZGF0YS5tZXNzYWdlSWQsIG5ld1RleHQpOwogICAgfSBlbHNlIHsKICAgICAgICBzdGF0ZS5zdGVwID0gJ2F3YWl0aW5nX2FsbF9zZXJ2aWNlX2lucHV0JzsKICAgICAgICBjb25zdCBuZXdUZXh0ID0gYDxwcmU+Q29udmVydCBTdGF0dXMKCuKeoe+4jyBTZXJ2aWNlIE1vZGUgOiBTRU1VQSAoJHtzdGF0ZS5kYXRhLmZpbGVMaXN0Lmxlbmd0aH0gRmlsZSkKClNpbGFrYW4gYmVyaWthbiBzYXR1IG5hbWEgU2VydmljZSAoQ29udG9oOiBXaGF0c0FwcCkgeWFuZyBha2FuIGRpZ3VuYWthbiB1bnR1ayBzZW11YSAke3N0YXRlLmRhdGEuZmlsZUxpc3QubGVuZ3RofSBmaWxlIHlhbmcgYWthbiBkaWtvbnZlcnNpLjwvcHJlPgogICAgICAgIGA7CiAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgc3RhdGUuZGF0YS5tZXNzYWdlSWQsIG5ld1RleHQpOwogICAgfQp9KTsKCgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBTQ1JFRU5TSE9UIFNZU1RFTSA9PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgdGFrZVNjcmVlbnNob3QgPSBhc3luYyAoY3R4LCB1cmwsIGNhcHRpb25UaXRsZSkgPT4gewogICAgaWYgKCFpc0Jyb3dzZXJSZWFkeSB8fCAhYnJvd3NlcikgewogICAgICAgIHJldHVybiByZXBseUhUTUwoY3R4LCAi4p2MIEJyb3dzZXIgdGlkYWsgcmVhZHkuIik7CiAgICB9CgogICAgbGV0IHBhZ2UgPSBudWxsOwogICAgbGV0IHNzUGF0aCA9IG51bGw7CiAgICBjb25zdCB3YWl0TXNnID0gYXdhaXQgcmVwbHlIVE1MKGN0eCwgYOKPsyBTZWRhbmcgbWVtcHJvc2VzLi4uYCk7CgogICAgdHJ5IHsKICAgICAgICBwYWdlID0gYXdhaXQgYnJvd3Nlci5uZXdQYWdlKCk7CiAgICAgICAgYXdhaXQgcGFnZS5zZXREZWZhdWx0VGltZW91dChTQ1JFRU5TSE9UX1RJTUVPVVRfTVMpOwogICAgICAgIGF3YWl0IHBhZ2Uuc2V0Vmlld3BvcnQobnVsbCk7CiAgICAgICAgYXdhaXQgcGFnZS5zZXRVc2VyQWdlbnQoc2V0dGluZ3MuQ1VSUkVOVF9VU0VSX0FHRU5UKTsKCiAgICAgICAgaWYgKHVybC5pbmNsdWRlcygnaXZhc21zLmNvbScpICYmIHNldHRpbmdzLkNGX0NMRUFSQU5DRV9WQUxVRSkgewogICAgICAgICAgICBhd2FpdCBwYWdlLnNldENvb2tpZSh7CiAgICAgICAgICAgICAgICBuYW1lOiAnY2ZfY2xlYXJhbmNlJywKICAgICAgICAgICAgICAgIHZhbHVlOiBzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUsCiAgICAgICAgICAgICAgICBkb21haW46ICcuaXZhc21zLmNvbScKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHBhZ2UuZ290byh1cmwsIHsgCiAgICAgICAgICAgIHdhaXRVbnRpbDogJ25ldHdvcmtpZGxlMicsIAogICAgICAgICAgICB0aW1lb3V0OiBTQ1JFRU5TSE9UX1RJTUVPVVRfTVMgCiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgY29uc3Qgc3RhdHVzID0gcmVzcG9uc2UgPyByZXNwb25zZS5zdGF0dXMoKSA6ICdOL0EnOwogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAzMDAwKSk7CgogICAgICAgIHNzUGF0aCA9IHBhdGguam9pbihTU19ESVIsIGBzY3JlZW5zaG90XyR7RGF0ZS5ub3coKX0uanBlZ2ApOwogICAgICAgIGF3YWl0IHBhZ2Uuc2NyZWVuc2hvdCh7IAogICAgICAgICAgICBwYXRoOiBzc1BhdGgsIAogICAgICAgICAgICBmdWxsUGFnZTogZmFsc2UsCiAgICAgICAgICAgIHR5cGU6ICdqcGVnJywgCiAgICAgICAgICAgIHF1YWxpdHk6IDg1CiAgICAgICAgfSk7CgogICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5kZWxldGVNZXNzYWdlKGN0eC5jaGF0LmlkLCB3YWl0TXNnLm1lc3NhZ2VfaWQpLmNhdGNoKCgpID0+IHt9KTsKCiAgICAgICAgY29uc3QgY2FwdGlvblRleHQgPSBgPHByZT7wn5O4IEhhc2lsIHNjcmVlbnNob3RcblxuVVJMIDogJHt1cmx9XG5TdGF0dXMgOiAke3N0YXR1c31cbldha3R1IDogJHtuZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygnaWQtSUQnKX08L3ByZT5gOwogICAgICAgIGF3YWl0IGN0eC5yZXBseVdpdGhQaG90byh7IHNvdXJjZTogc3NQYXRoIH0sIHsgY2FwdGlvbjogY2FwdGlvblRleHQsIHBhcnNlX21vZGU6ICdIVE1MJyB9KTsKCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5lZGl0TWVzc2FnZVRleHQoCiAgICAgICAgICAgIGN0eC5jaGF0LmlkLCAKICAgICAgICAgICAgd2FpdE1zZy5tZXNzYWdlX2lkLCAKICAgICAgICAgICAgbnVsbCwgCiAgICAgICAgICAgIGA8cHJlPuKdjCBHYWdhbCBhbWJpbCBzY3JlZW5zaG90XG4ke2Vycm9yLm1lc3NhZ2V9PC9wcmU+YCwgCiAgICAgICAgICAgIHsgcGFyc2VfbW9kZTogJ0hUTUwnIH0KICAgICAgICApOwogICAgfSBmaW5hbGx5IHsKICAgICAgICBpZiAocGFnZSkgYXdhaXQgcGFnZS5jbG9zZSgpOwogICAgICAgIGlmIChzc1BhdGggJiYgZnMuZXhpc3RzU3luYyhzc1BhdGgpKSBmcy51bmxpbmtTeW5jKHNzUGF0aCk7CiAgICB9Cn07Cgpjb25zdCB0YWtlRGFzaGJvYXJkU2NyZWVuc2hvdCA9IGFzeW5jIChjdHgpID0+IHsKICAgIGF3YWl0IHRha2VTY3JlZW5zaG90KGN0eCwgREFTSF9VUkwsICdEYXNoYm9hcmQgc2NyZWVuc2hvdCcpOwp9OwoKY29uc3QgdGFrZUxpdmVTbXNTY3JlZW5zaG90ID0gYXN5bmMgKGN0eCkgPT4gewogICAgYXdhaXQgdGFrZVNjcmVlbnNob3QoY3R4LCBMSVZFX1NNU19VUkwsICdMaXZlIFNNUyBzY3JlZW5zaG90Jyk7Cn07Cgpjb25zdCB0YWtlTWFjYm9va1NjcmVlbnNob3QgPSBhc3luYyAoY3R4LCB0YXJnZXRVcmwpID0+IHsKICAgIGlmICghaXNCcm93c2VyUmVhZHkgfHwgIWJyb3dzZXIpIHsKICAgICAgICByZXR1cm4gcmVwbHlIVE1MKGN0eCwgIuKdjCBCcm93c2VyIHRpZGFrIHJlYWR5LiIpOwogICAgfQoKICAgIGxldCBwYWdlID0gbnVsbDsKICAgIGxldCBzc1BhdGggPSBudWxsOwogICAgY29uc3Qgd2FpdE1zZyA9IGF3YWl0IHJlcGx5SFRNTChjdHgsIGA8cHJlPlNjcmVlbnNob3QgU3RhdHVzXG5cblNlZGFuZyBtZW5nYW1iaWwgc2NyZWVuc2hvdFxu4o+zIExvYWRpbmcgOiAke3RhcmdldFVybH08L3ByZT5gKTsKCiAgICB0cnkgewogICAgICAgIGlmICghdGFyZ2V0VXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VSTCBoYXJ1cyBkaWF3YWxpIGRlbmdhbiBodHRwOi8vIGF0YXUgaHR0cHM6Ly8nKTsKICAgICAgICB9CgogICAgICAgIHBhZ2UgPSBhd2FpdCBicm93c2VyLm5ld1BhZ2UoKTsKICAgICAgICBhd2FpdCBwYWdlLnNldFZpZXdwb3J0KG51bGwpOwogICAgICAgIGF3YWl0IHBhZ2Uuc2V0VXNlckFnZW50KE1BQ0JPT0tfVVNFUl9BR0VOVCk7CiAgICAgICAgCiAgICAgICAgYXdhaXQgcGFnZS5ldmFsdWF0ZU9uTmV3RG9jdW1lbnQoKCkgPT4gewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobmF2aWdhdG9yLCAnd2ViZHJpdmVyJywgewogICAgICAgICAgICAgICAgZ2V0OiAoKSA9PiB1bmRlZmluZWQKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIGlmICh0YXJnZXRVcmwuaW5jbHVkZXMoJ2l2YXNtcy5jb20nKSAmJiBzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUpIHsKICAgICAgICAgICAgYXdhaXQgcGFnZS5zZXRDb29raWUoewogICAgICAgICAgICAgICAgbmFtZTogJ2NmX2NsZWFyYW5jZScsCiAgICAgICAgICAgICAgICB2YWx1ZTogc2V0dGluZ3MuQ0ZfQ0xFQVJBTkNFX1ZBTFVFLAogICAgICAgICAgICAgICAgZG9tYWluOiAnLml2YXNtcy5jb20nCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBwYWdlLmdvdG8odGFyZ2V0VXJsLCB7IAogICAgICAgICAgICB3YWl0VW50aWw6ICduZXR3b3JraWRsZTInLAogICAgICAgICAgICB0aW1lb3V0OiA0NTAwMAogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlc3BvbnNlID8gcmVzcG9uc2Uuc3RhdHVzKCkgOiAnTi9BJzsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMzAwMCkpOwoKICAgICAgICBzc1BhdGggPSBwYXRoLmpvaW4oU1NfRElSLCBgbWFjYm9va19zc18ke0RhdGUubm93KCl9LmpwZWdgKTsKICAgICAgICBhd2FpdCBwYWdlLnNjcmVlbnNob3QoeyAKICAgICAgICAgICAgcGF0aDogc3NQYXRoLCAKICAgICAgICAgICAgZnVsbFBhZ2U6IGZhbHNlLAogICAgICAgICAgICB0eXBlOiAnanBlZycsIAogICAgICAgICAgICBxdWFsaXR5OiA5MAogICAgICAgIH0pOwoKICAgICAgICBhd2FpdCBjdHgudGVsZWdyYW0uZGVsZXRlTWVzc2FnZShjdHguY2hhdC5pZCwgd2FpdE1zZy5tZXNzYWdlX2lkKS5jYXRjaCgoKSA9PiB7fSk7CgogICAgICAgIGNvbnN0IGNhcHRpb25UZXh0ID0gYDxwcmU+SGFzaWwgU2NyZWVuc2hvdFxuXG5VUkwgOiAke3RhcmdldFVybH1cblN0YXR1cyA6ICR7c3RhdHVzfTwvcHJlPmA7CiAgICAgICAgCiAgICAgICAgYXdhaXQgY3R4LnJlcGx5V2l0aFBob3RvKAogICAgICAgICAgICB7IHNvdXJjZTogc3NQYXRoIH0sIAogICAgICAgICAgICB7IGNhcHRpb246IGNhcHRpb25UZXh0LCBwYXJzZV9tb2RlOiAnSFRNTCcgfQogICAgICAgICk7CgogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZChgW1NUQVRVU10g4p2MIFNjcmVlbnNob3QgRXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gKSk7CiAgICAgICAgYXdhaXQgY3R4LnRlbGVncmFtLmVkaXRNZXNzYWdlVGV4dCgKICAgICAgICAgICAgY3R4LmNoYXQuaWQsIAogICAgICAgICAgICB3YWl0TXNnLm1lc3NhZ2VfaWQsIAogICAgICAgICAgICBudWxsLCAKICAgICAgICAgICAgYDxwcmU+RXJyb3Jcblxu4p2MIEdhZ2FsIG1lbmdhbWJpbCBzY3JlZW5zaG90XG4ke2Vycm9yLm1lc3NhZ2V9PC9wcmU+YCwgCiAgICAgICAgICAgIHsgcGFyc2VfbW9kZTogJ0hUTUwnIH0KICAgICAgICApOwogICAgfSBmaW5hbGx5IHsKICAgICAgICBpZiAocGFnZSkgYXdhaXQgcGFnZS5jbG9zZSgpLmNhdGNoKCgpID0+IHt9KTsKICAgICAgICBpZiAoc3NQYXRoICYmIGZzLmV4aXN0c1N5bmMoc3NQYXRoKSkgewogICAgICAgICAgICB0cnkgeyBmcy51bmxpbmtTeW5jKHNzUGF0aCk7IH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgfQp9OwoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gRVhQT1JUIE5VTUJFUlMgPT09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCmNvbnN0IHNpbXBsZURpcmVjdEV4cG9ydCA9IGFzeW5jIChjdHgpID0+IHsKICAgIC8vIENlayBhcGFrYWggc3VkYWggYWRhIGNyZWRlbnRpYWxzCiAgICBpZiAoIXNldHRpbmdzLkNGX0NMRUFSQU5DRV9WQUxVRSkgewogICAgICAgIHJldHVybiBhd2FpdCBjdHgucmVwbHlXaXRoSFRNTCgKICAgICAgICAgICAgYDxwcmU+RXhwb3J0IFN0YXR1c1xuXG7inYwgPGI+Q0YgQ2xlYXJhbmNlIHRpZGFrIGRpdGVtdWthbjwvYj5cblxuU2lsYWthbiBsb2dpbiBkdWx1IGRlbmdhbiAvbG9naW48L3ByZT5gLAogICAgICAgICAgICB7IHJlcGx5X3RvX21lc3NhZ2VfaWQ6IGN0eC5tZXNzYWdlLm1lc3NhZ2VfaWQgfQogICAgICAgICk7CiAgICB9CiAgICAKICAgIGNvbnN0IHdhaXRNc2cgPSBhd2FpdCByZXBseUhUTUwoY3R4LCBgPHByZT5FWFBPUlQgTlVNQkVSXG5cbvCfk6UgTWVtdWxhaSBleHBvcnQgbnVtYmVycy4uLjwvcHJlPmApOwogICAgCiAgICBsZXQgcGFnZSA9IG51bGw7CiAgICAKICAgIHRyeSB7CiAgICAgICAgaWYgKCFpc0Jyb3dzZXJSZWFkeSB8fCAhYnJvd3NlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgdGlkYWsgcmVhZHkiKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gQnVhdCBwYWdlIGJhcnUKICAgICAgICBwYWdlID0gYXdhaXQgYnJvd3Nlci5uZXdQYWdlKCk7CiAgICAgICAgYXdhaXQgcGFnZS5zZXREZWZhdWx0TmF2aWdhdGlvblRpbWVvdXQoNDUwMDApOwogICAgICAgIGF3YWl0IHBhZ2Uuc2V0RGVmYXVsdFRpbWVvdXQoNDUwMDApOwogICAgICAgIAogICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHdhaXRNc2cubWVzc2FnZV9pZCwgYDxwcmU+RVhQT1JUIE5VTUJFUlxuXG7wn4yQIFNldHVwIGJyb3dzZXIuLi48L3ByZT5gKTsKICAgICAgICAKICAgICAgICAvLyBTZXQgVXNlciBBZ2VudAogICAgICAgIGF3YWl0IHBhZ2Uuc2V0VXNlckFnZW50KHNldHRpbmdzLkNVUlJFTlRfVVNFUl9BR0VOVCB8fCBNQUNCT09LX1VTRVJfQUdFTlQpOwogICAgICAgIAogICAgICAgIC8vIFNldCBjb29raWVzIChoYW55YSBjZl9jbGVhcmFuY2UgeWFuZyBwZW50aW5nKQogICAgICAgIGF3YWl0IHBhZ2Uuc2V0Q29va2llKHsKICAgICAgICAgICAgbmFtZTogJ2NmX2NsZWFyYW5jZScsCiAgICAgICAgICAgIHZhbHVlOiBzZXR0aW5ncy5DRl9DTEVBUkFOQ0VfVkFMVUUsCiAgICAgICAgICAgIGRvbWFpbjogJy5pdmFzbXMuY29tJywKICAgICAgICAgICAgcGF0aDogJy8nLAogICAgICAgICAgICBodHRwT25seTogdHJ1ZSwKICAgICAgICAgICAgc2VjdXJlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgLy8gU2V0dXAgZG93bmxvYWQgcGF0aAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHBhZ2UudGFyZ2V0KCkuY3JlYXRlQ0RQU2Vzc2lvbigpOwogICAgICAgICAgICBhd2FpdCBjbGllbnQuc2VuZCgnUGFnZS5zZXREb3dubG9hZEJlaGF2aW9yJywgewogICAgICAgICAgICAgICAgYmVoYXZpb3I6ICdhbGxvdycsCiAgICAgICAgICAgICAgICBkb3dubG9hZFBhdGg6IFRFTVBfRElSCiAgICAgICAgICAgIH0pOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsueWVsbG93KCdbRVhQT1JUXSDimqDvuI8gQ0RQU2Vzc2lvbiBlcnJvciwgY29udGludWUgYW55d2F5JykpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdGVwIDE6IEFrc2VzIGhhbGFtYW4gbnVtYmVycwogICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHdhaXRNc2cubWVzc2FnZV9pZCwgYDxwcmU+RVhQT1JUIE5VTUJFUlxuXG7wn4yQIE1lbmdha3NlcyBoYWxhbWFuIG51bWJlcnMuLi48L3ByZT5gKTsKICAgICAgICAKICAgICAgICBjb25zdCBudW1iZXJzVXJsID0gJ2h0dHBzOi8vd3d3Lml2YXNtcy5jb20vcG9ydGFsL251bWJlcnMnOwogICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmN5YW4oYFtFWFBPUlRdIE1lbmdha3NlczogJHtudW1iZXJzVXJsfWApKTsKICAgICAgICAKICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHBhZ2UuZ290byhudW1iZXJzVXJsLCB7CiAgICAgICAgICAgIHdhaXRVbnRpbDogJ2RvbWNvbnRlbnRsb2FkZWQnLAogICAgICAgICAgICB0aW1lb3V0OiAzMDAwMAogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlc3BvbnNlID8gcmVzcG9uc2Uuc3RhdHVzKCkgOiAnTi9BJzsKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5jeWFuKGBbRVhQT1JUXSBTdGF0dXM6ICR7c3RhdHVzfWApKTsKICAgICAgICAKICAgICAgICAvLyBUdW5nZ3UgaGFsYW1hbiBsb2FkCiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTsKICAgICAgICAKICAgICAgICAvLyBTdGVwIDI6IENlayBhcGFrYWggZGkgaGFsYW1hbiBudW1iZXJzCiAgICAgICAgY29uc3QgY3VycmVudFVybCA9IGF3YWl0IHBhZ2UudXJsKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICBpZiAoIWN1cnJlbnRVcmwuaW5jbHVkZXMoJy9udW1iZXJzJykpIHsKICAgICAgICAgICAgLy8gTXVuZ2tpbiBkaWFyYWhrYW4ga2UgbG9naW4gYXRhdSBlcnJvcgogICAgICAgICAgICBpZiAoY3VycmVudFVybC5pbmNsdWRlcygnL2xvZ2luJykpIHsKICAgICAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHdhaXRNc2cubWVzc2FnZV9pZCwgYDxwcmU+RVhQT1JUIE5VTUJFUlxuXG7wn5SRIFRlcmRldGVrc2kgaGFsYW1hbiBsb2dpbjwvcHJlPmApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDb2JhIGxvZ2luIGRlbmdhbiB1c2VybmFtZS9wYXNzd29yZCBqaWthIGFkYQogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLklWQVNfVVNFUk5BTUUgJiYgc2V0dGluZ3MuSVZBU19QQVNTV09SRCkgewogICAgICAgICAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHdhaXRNc2cubWVzc2FnZV9pZCwgYDxwcmU+RVhQT1JUIE5VTUJFUlxuXG7wn5OnIExvZ2luIGRlbmdhbiAke3NldHRpbmdzLklWQVNfVVNFUk5BTUV9Li4uPC9wcmU+YCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcGFnZS5ldmFsdWF0ZSgodXNlcm5hbWUsIHBhc3N3b3JkKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhcmkgZmllbGQgbG9naW4KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW1haWxGaWVsZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W3R5cGU9ImVtYWlsIl0sIGlucHV0W25hbWU9ImVtYWlsIl0sIGlucHV0W25hbWU9InVzZXJuYW1lIl0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFzc3dvcmRGaWVsZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W3R5cGU9InBhc3N3b3JkIl0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3VibWl0QnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYnV0dG9uW3R5cGU9InN1Ym1pdCJdLCBpbnB1dFt0eXBlPSJzdWJtaXQiXScpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVtYWlsRmllbGQpIGVtYWlsRmllbGQudmFsdWUgPSB1c2VybmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhc3N3b3JkRmllbGQpIHBhc3N3b3JkRmllbGQudmFsdWUgPSBwYXNzd29yZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN1Ym1pdEJ0bikgc3VibWl0QnRuLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgc2V0dGluZ3MuSVZBU19VU0VSTkFNRSwgc2V0dGluZ3MuSVZBU19QQVNTV09SRCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDb2JhIGFrc2VzIG51bWJlcnMgbGFnaQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHBhZ2UuZ290byhudW1iZXJzVXJsLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdhaXRVbnRpbDogJ2RvbWNvbnRlbnRsb2FkZWQnLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0OiAzMDAwMAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAzMDAwKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRGlhcmFoa2FuIGtlIGxvZ2luIHBhZ2UuIFNldHVwIGxvZ2luIGRlbmdhbiAvbG9naW4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGlkYWsgYmlzYSBtZW5nYWtzZXMgaGFsYW1hbiBudW1iZXJzLiBVUkw6ICR7Y3VycmVudFVybH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdGVwIDM6IENhcmkgZGFuIGtsaWsgdG9tYm9sIGV4cG9ydAogICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHdhaXRNc2cubWVzc2FnZV9pZCwgYDxwcmU+RVhQT1JUIE5VTUJFUlxuXG7wn5SNIE1lbmNhcmkgdG9tYm9sIGV4cG9ydC4uLjwvcHJlPmApOwogICAgICAgIAogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDAwKSk7CiAgICAgICAgCiAgICAgICAgbGV0IGV4cG9ydENsaWNrZWQgPSBmYWxzZTsKICAgICAgICAKICAgICAgICAvLyBDb2JhIGJlYmVyYXBhIGNhcmEga2xpayBleHBvcnQKICAgICAgICBleHBvcnRDbGlja2VkID0gYXdhaXQgcGFnZS5ldmFsdWF0ZSgoKSA9PiB7CiAgICAgICAgICAgIC8vIENhcmEgMTogQ2FyaSB0b21ib2wgZGVuZ2FuIHRleHQgIkV4cG9ydCIKICAgICAgICAgICAgY29uc3QgYnV0dG9ucyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2J1dHRvbiwgYSwgLmJ0biwgaW5wdXRbdHlwZT0iYnV0dG9uIl0nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoY29uc3QgYnRuIG9mIGJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSAoYnRuLnRleHRDb250ZW50IHx8IGJ0bi5pbm5lclRleHQgfHwgJycpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBjb25zdCBocmVmID0gYnRuLmdldEF0dHJpYnV0ZSgnaHJlZicpIHx8ICcnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGV4dC5pbmNsdWRlcygnZXhwb3J0JykgfHwgdGV4dC5pbmNsdWRlcygnZG93bmxvYWQnKSB8fCAKICAgICAgICAgICAgICAgICAgICB0ZXh0LmluY2x1ZGVzKCd1bmR1aCcpIHx8IHRleHQuaW5jbHVkZXMoJ2Vrc3BvcicpIHx8CiAgICAgICAgICAgICAgICAgICAgaHJlZi5pbmNsdWRlcygnZXhwb3J0JykgfHwgaHJlZi5pbmNsdWRlcygnZG93bmxvYWQnKSkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGb3VuZCBleHBvcnQgYnV0dG9uOicsIHRleHQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChidG4udGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnYScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW50dWsgbGluaywga2xpayBsYW5nc3VuZwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW50dWsgYnV0dG9uLCBrbGlrCiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGljaygpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhcmEgMjogQ2FyaSBsaW5rIGRlbmdhbiBocmVmIHlhbmcgbWVuZ2FuZHVuZyBleHBvcnQKICAgICAgICAgICAgY29uc3QgbGlua3MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdhW2hyZWYqPSJleHBvcnQiXSwgYVtocmVmKj0iZG93bmxvYWQiXScpOwogICAgICAgICAgICBpZiAobGlua3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgbGlua3NbMF0uY2xpY2soKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKCFleHBvcnRDbGlja2VkKSB7CiAgICAgICAgICAgIC8vIENhcmEgMzogQ29iYSBjYXJpIGRlbmdhbiBjbGFzcyBhdGF1IElECiAgICAgICAgICAgIGV4cG9ydENsaWNrZWQgPSBhd2FpdCBwYWdlLmV2YWx1YXRlKCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGV4cG9ydEVsZW1lbnRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2NsYXNzKj0iZXhwb3J0Il0sIFtpZCo9ImV4cG9ydCJdLCBbY2xhc3MqPSJkb3dubG9hZCJdLCBbaWQqPSJkb3dubG9hZCJdJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZWwgb2YgZXhwb3J0RWxlbWVudHMpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBlbC5jbGljaygpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ2xpY2tlZCBleHBvcnQgZWxlbWVudCBieSBjbGFzcy9pZCcpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICghZXhwb3J0Q2xpY2tlZCkgewogICAgICAgICAgICAvLyBDYXJhIDQ6IENvYmEgYWtzZXMgVVJMIGV4cG9ydCBsYW5nc3VuZwogICAgICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCB3YWl0TXNnLm1lc3NhZ2VfaWQsIGA8cHJlPkVYUE9SVCBOVU1CRVJcblxu8J+UlyBNZW5jb2JhIFVSTCBleHBvcnQgbGFuZ3N1bmcuLi48L3ByZT5gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGV4cG9ydFVybCA9ICdodHRwczovL3d3dy5pdmFzbXMuY29tL3BvcnRhbC9udW1iZXJzL2V4cG9ydCc7CiAgICAgICAgICAgIAogICAgICAgICAgICBhd2FpdCBwYWdlLmdvdG8oZXhwb3J0VXJsLCB7CiAgICAgICAgICAgICAgICB3YWl0VW50aWw6ICduZXR3b3JraWRsZTAnLAogICAgICAgICAgICAgICAgdGltZW91dDogMzAwMDAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBleHBvcnRDbGlja2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKCFleHBvcnRDbGlja2VkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGlkYWsgYmlzYSBtZW5lbXVrYW4gdG9tYm9sIGV4cG9ydCIpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdGVwIDQ6IFR1bmdndSBmaWxlIGRvd25sb2FkCiAgICAgICAgYXdhaXQgc2FmZUVkaXRNZXNzYWdlKGN0eCwgd2FpdE1zZy5tZXNzYWdlX2lkLCBgPHByZT5FWFBPUlQgTlVNQkVSXG5cbuKPsyBNZW51bmdndSBmaWxlIGRvd25sb2FkLi4uICgxNSBkZXRpayk8L3ByZT5gKTsKICAgICAgICAKICAgICAgICBsZXQgZG93bmxvYWRlZEZpbGUgPSBudWxsOwogICAgICAgIGNvbnN0IG1heFdhaXRUaW1lID0gMTUwMDA7IC8vIDE1IGRldGlrCiAgICAgICAgY29uc3QgY2hlY2tJbnRlcnZhbCA9IDEwMDA7IC8vIENlayBzZXRpYXAgMSBkZXRpawogICAgICAgIAogICAgICAgIGZvciAobGV0IGVsYXBzZWQgPSAwOyBlbGFwc2VkIDwgbWF4V2FpdFRpbWU7IGVsYXBzZWQgKz0gY2hlY2tJbnRlcnZhbCkgewogICAgICAgICAgICAvLyBDYXJpIGZpbGUgYmFydSBkaSBURU1QX0RJUgogICAgICAgICAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKFRFTVBfRElSKTsKICAgICAgICAgICAgY29uc3QgZXhjZWxGaWxlcyA9IGZpbGVzLmZpbHRlcihmID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGxvd2VyID0gZi50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGxvd2VyLmVuZHNXaXRoKCcueGxzeCcpIHx8IAogICAgICAgICAgICAgICAgICAgICAgIGxvd2VyLmVuZHNXaXRoKCcueGxzJykgfHwKICAgICAgICAgICAgICAgICAgICAgICBsb3dlci5pbmNsdWRlcygnbnVtYmVycycpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgbG93ZXIuaW5jbHVkZXMoJ2V4cG9ydCcpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChleGNlbEZpbGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIC8vIEFtYmlsIGZpbGUgdGVyYmFydSBiZXJkYXNhcmthbiB3YWt0dSBtb2RpZmlrYXNpCiAgICAgICAgICAgICAgICBleGNlbEZpbGVzLnNvcnQoKGEsIGIpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0QSA9IGZzLnN0YXRTeW5jKHBhdGguam9pbihURU1QX0RJUiwgYSkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRCID0gZnMuc3RhdFN5bmMocGF0aC5qb2luKFRFTVBfRElSLCBiKSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRCLm10aW1lTXMgLSBzdGF0QS5tdGltZU1zOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGxhdGVzdEZpbGUgPSBleGNlbEZpbGVzWzBdOwogICAgICAgICAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oVEVNUF9ESVIsIGxhdGVzdEZpbGUpOwogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHMgPSBmcy5zdGF0U3luYyhmaWxlUGF0aCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBhc3Rpa2FuIGZpbGUgY3VrdXAgYmVzYXIgKHRpZGFrIGNvcnJ1cHRlZCkKICAgICAgICAgICAgICAgIGlmIChzdGF0cy5zaXplID4gMTAyNCkgewogICAgICAgICAgICAgICAgICAgIGRvd25sb2FkZWRGaWxlID0gewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiBmaWxlUGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbGF0ZXN0RmlsZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZTogc3RhdHMuc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbXRpbWU6IHN0YXRzLm10aW1lCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwcm9ncmVzcyBzZXRpYXAgNSBkZXRpawogICAgICAgICAgICBpZiAoZWxhcHNlZCA+IDAgJiYgZWxhcHNlZCAlIDUwMDAgPT09IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbWFpbmluZyA9IChtYXhXYWl0VGltZSAtIGVsYXBzZWQpIC8gMTAwMDsKICAgICAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHdhaXRNc2cubWVzc2FnZV9pZCwgCiAgICAgICAgICAgICAgICAgICAgYDxwcmU+RVhQT1JUIE5VTUJFUlxuXG7ij7MgTWVudW5nZ3UgZmlsZS4uLiAoJHtyZW1haW5pbmd9cyB0ZXJzaXNhKTwvcHJlPmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgY2hlY2tJbnRlcnZhbCkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoIWRvd25sb2FkZWRGaWxlKSB7CiAgICAgICAgICAgIC8vIENvYmEgdHVuZ2d1IGVrc3RyYSA1IGRldGlrCiAgICAgICAgICAgIGF3YWl0IHNhZmVFZGl0TWVzc2FnZShjdHgsIHdhaXRNc2cubWVzc2FnZV9pZCwgYDxwcmU+RVhQT1JUIE5VTUJFUlxuXG7ij7MgVHVuZ2d1IGVrc3RyYSA1IGRldGlrLi4uPC9wcmU+YCk7CiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MDAwKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDZWsgbGFnaQogICAgICAgICAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKFRFTVBfRElSKTsKICAgICAgICAgICAgY29uc3QgZXhjZWxGaWxlcyA9IGZpbGVzLmZpbHRlcihmID0+IGYudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnLnhsc3gnKSB8fCBmLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy54bHMnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZXhjZWxGaWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBleGNlbEZpbGVzLnNvcnQoKGEsIGIpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0QSA9IGZzLnN0YXRTeW5jKHBhdGguam9pbihURU1QX0RJUiwgYSkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRCID0gZnMuc3RhdFN5bmMocGF0aC5qb2luKFRFTVBfRElSLCBiKSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRCLm10aW1lTXMgLSBzdGF0QS5tdGltZU1zOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGxhdGVzdEZpbGUgPSBleGNlbEZpbGVzWzBdOwogICAgICAgICAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oVEVNUF9ESVIsIGxhdGVzdEZpbGUpOwogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHMgPSBmcy5zdGF0U3luYyhmaWxlUGF0aCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChzdGF0cy5zaXplID4gMTAyNCkgewogICAgICAgICAgICAgICAgICAgIGRvd25sb2FkZWRGaWxlID0gewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiBmaWxlUGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbGF0ZXN0RmlsZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZTogc3RhdHMuc2l6ZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghZG93bmxvYWRlZEZpbGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRmlsZSB0aWRhayB0ZXJkb3dubG9hZCBzZXRlbGFoIDIwIGRldGlrIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU3RlcCA1OiBQcm9zZXMgZmlsZSB5YW5nIGRpZG93bmxvYWQKICAgICAgICBhd2FpdCBzYWZlRWRpdE1lc3NhZ2UoY3R4LCB3YWl0TXNnLm1lc3NhZ2VfaWQsIGA8cHJlPkVYUE9SVCBOVU1CRVJcblxu8J+TiiBNZW1wcm9zZXMgZmlsZS4uLjwvcHJlPmApOwogICAgICAgIAogICAgICAgIC8vIFJlbmFtZSBmaWxlIGRlbmdhbiB0aW1lc3RhbXAKICAgICAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvTG9jYWxlU3RyaW5nKCdpZC1JRCcpLnJlcGxhY2UoL1svOlxzXS9nLCAnLScpOwogICAgICAgIGNvbnN0IG5ld0ZpbGVOYW1lID0gYGl2YXNtc19udW1iZXJzXyR7dGltZXN0YW1wfS54bHN4YDsKICAgICAgICBjb25zdCBuZXdGaWxlUGF0aCA9IHBhdGguam9pbihURU1QX0RJUiwgbmV3RmlsZU5hbWUpOwogICAgICAgIAogICAgICAgIC8vIFBhc3Rpa2FuIGV4dGVuc2lvbiAueGxzeAogICAgICAgIGlmICghZG93bmxvYWRlZEZpbGUucGF0aC50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCcueGxzeCcpKSB7CiAgICAgICAgICAgIGZzLnJlbmFtZVN5bmMoZG93bmxvYWRlZEZpbGUucGF0aCwgZG93bmxvYWRlZEZpbGUucGF0aCArICcueGxzeCcpOwogICAgICAgICAgICBmcy5yZW5hbWVTeW5jKGRvd25sb2FkZWRGaWxlLnBhdGggKyAnLnhsc3gnLCBuZXdGaWxlUGF0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnMucmVuYW1lU3luYyhkb3dubG9hZGVkRmlsZS5wYXRoLCBuZXdGaWxlUGF0aCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIEhpdHVuZyBqdW1sYWggYmFyaXMgZGF0YQogICAgICAgIGxldCByb3dDb3VudCA9IDA7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3Qgd29ya2Jvb2sgPSBYTFNYLnJlYWRGaWxlKG5ld0ZpbGVQYXRoKTsKICAgICAgICAgICAgY29uc3Qgc2hlZXROYW1lID0gd29ya2Jvb2suU2hlZXROYW1lc1swXTsKICAgICAgICAgICAgY29uc3QgZGF0YSA9IFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbih3b3JrYm9vay5TaGVldHNbc2hlZXROYW1lXSk7CiAgICAgICAgICAgIHJvd0NvdW50ID0gZGF0YS5sZW5ndGg7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay55ZWxsb3coYFtFWFBPUlRdIOKdjCBUaWRhayBiaXNhIG1lbWJhY2EgZmlsZTogJHtlLm1lc3NhZ2V9YCkpOwogICAgICAgICAgICByb3dDb3VudCA9ICdOL0EnOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdGVwIDY6IEtpcmltIGZpbGUga2UgVGVsZWdyYW0KICAgICAgICBhd2FpdCBjdHgudGVsZWdyYW0uZGVsZXRlTWVzc2FnZShjdHguY2hhdC5pZCwgd2FpdE1zZy5tZXNzYWdlX2lkKS5jYXRjaCgoKSA9PiB7fSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZmlsZVNpemVLQiA9IChkb3dubG9hZGVkRmlsZS5zaXplIC8gMTAyNCkudG9GaXhlZCgxKTsKICAgICAgICAKICAgICAgICBhd2FpdCBjdHgucmVwbHlXaXRoRG9jdW1lbnQoCiAgICAgICAgICAgIHsgc291cmNlOiBuZXdGaWxlUGF0aCwgZmlsZW5hbWU6IG5ld0ZpbGVOYW1lIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhcHRpb246IGA8cHJlPuKchSBFWFBPUlQgQkVSSEFTSUxcblxu8J+TgSBGaWxlOiAke25ld0ZpbGVOYW1lfVxu8J+TiiBEYXRhOiAke3Jvd0NvdW50fSBiYXJpc1xu8J+TjyBTaXplOiAke2ZpbGVTaXplS0J9IEtCXG7ij7AgV2FrdHU6ICR7bmV3IERhdGUoKS50b0xvY2FsZVRpbWVTdHJpbmcoJ2lkLUlEJyl9XG5cbkNyZWF0ZWQgYnkgQFVzZXJycl93YXJ4eno8L3ByZT5gLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZTogJ0hUTUwnLAogICAgICAgICAgICAgICAgcmVwbHlfdG9fbWVzc2FnZV9pZDogY3R4Lm1lc3NhZ2UubWVzc2FnZV9pZAogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgICAgICAKICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbihgW0VYUE9SVF0g4pyFIEZpbGUgYmVyaGFzaWwgZGlraXJpbTogJHtuZXdGaWxlTmFtZX1gKSk7CiAgICAgICAgCiAgICAgICAgLy8gQ2xlYW51cCBmaWxlIHNldGVsYWggMTAgZGV0aWsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobmV3RmlsZVBhdGgpKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMobmV3RmlsZVBhdGgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgfQogICAgICAgIH0sIDEwMDAwKTsKICAgICAgICAKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFtFWFBPUlRdIOKdjCBFcnJvcjogJHtlcnJvci5tZXNzYWdlfWApKTsKICAgICAgICAKICAgICAgICAvLyBIYXB1cyBwZXNhbiBwcm9ncmVzcwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGN0eC50ZWxlZ3JhbS5kZWxldGVNZXNzYWdlKGN0eC5jaGF0LmlkLCB3YWl0TXNnLm1lc3NhZ2VfaWQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgCiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgbGV0IHN1Z2dlc3Rpb25zID0gJyc7CiAgICAgICAgCiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0VSUl9BQk9SVEVEJykgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnbmV0OjonKSkgewogICAgICAgICAgICBzdWdnZXN0aW9ucyA9ICdcblxu8J+SoSA8Yj5Tb2x1c2k6PC9iPlxuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAnMS4gVXBkYXRlIENGIENsZWFyYW5jZSBkZW5nYW4gL2xvZ2luXG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICcyLiBDb2JhIGFrc2VzIG1hbnVhbCBkaSBicm93c2VyIGR1bHVcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzMuIFR1bmdndSBiZWJlcmFwYSBtZW5pdCBsYWx1IGNvYmEgbGFnaSc7CiAgICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCd0aW1lb3V0JykgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnVGltZW91dCcpKSB7CiAgICAgICAgICAgIHN1Z2dlc3Rpb25zID0gJ1xuXG7wn5KhIDxiPlNvbHVzaTo8L2I+XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICcxLiBDb2JhIGxhZ2kgbmFudGlcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzIuIENlayBrb25la3NpIGludGVybmV0XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICczLiBTZXJ2ZXIgbXVuZ2tpbiBzaWJ1ayc7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGF3YWl0IGN0eC5yZXBseVdpdGhIVE1MKAogICAgICAgICAgICBgPHByZT5FeHBvcnQgU3RhdHVzXG5cbuKdjCA8Yj5HYWdhbCBFeHBvcnQ8L2I+XG5cbiR7ZXJyb3JNZXNzYWdlfSR7c3VnZ2VzdGlvbnN9PC9wcmU+YCwKICAgICAgICAgICAgeyByZXBseV90b19tZXNzYWdlX2lkOiBjdHgubWVzc2FnZS5tZXNzYWdlX2lkIH0KICAgICAgICApOwogICAgICAgIAogICAgfSBmaW5hbGx5IHsKICAgICAgICAvLyBUdXR1cCBwYWdlCiAgICAgICAgaWYgKHBhZ2UgJiYgIXBhZ2UuaXNDbG9zZWQoKSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYXdhaXQgcGFnZS5jbG9zZSgpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIH0KICAgIH0KfTsKCmJvdC5jb21tYW5kKCdleHBvcnRudW0nLCBvd25lck9ubHksIGFzeW5jIChjdHgpID0+IHsKICAgIGF3YWl0IHNpbXBsZURpcmVjdEV4cG9ydChjdHgpOwp9KTsKCgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KLy8gPT09PT09PT09PSBJTlRFUlZBTCBTWVNURU0gPT09PT09PT09IC8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAvLwoKY29uc3QgbG9nU3RhdHVzID0gKCkgPT4gewogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKCiAgICBpZiAobGFzdExvZ2dlZFN0YXR1cyAhPT0gYm90U3RhdHVzIHx8IG5vdyAtIGxhc3RTdGF0dXNMb2cgPiBTVEFUVVNfTE9HX0lOVEVSVkFMKSB7CiAgICAgICAgCiAgICAgICAgY29uc3QgdXB0aW1lID0gaXNDb25uZWN0aW9uU3RhYmxlIAogICAgICAgICAgICA/IE1hdGguZmxvb3IoKG5vdyAtIHN0YWJsZUNvbm5lY3Rpb25TdGFydFRpbWUpIC8gNjAwMDApICsgJ20nIAogICAgICAgICAgICA6ICdOL0EnOwoKICAgICAgICAvLyBTdHlsaW5nIEJvbGQKICAgICAgICBjb25zdCBiV2hpdGUgPSBjaGFsay5ib2xkLndoaXRlQnJpZ2h0OwogICAgICAgIGNvbnN0IGJDeWFuID0gY2hhbGsuYm9sZC5jeWFuQnJpZ2h0OwogICAgICAgIGNvbnN0IGJCbHVlID0gY2hhbGsuYm9sZC5ibHVlQnJpZ2h0OwogICAgICAgIGNvbnN0IGJHcmVlbiA9IGNoYWxrLmJvbGQuZ3JlZW5CcmlnaHQ7CiAgICAgICAgY29uc3QgYlllbGxvdyA9IGNoYWxrLmJvbGQueWVsbG93QnJpZ2h0OwoKICAgICAgICAvLyBQZW5lbnR1YW4gd2FybmEgc3RhdHVzCiAgICAgICAgY29uc3QgY3VycmVudFN0YXR1c0NvbG9yID0gKGJvdFN0YXR1cy5pbmNsdWRlcygnUkVBRFknKSB8fCBib3RTdGF0dXMgPT09ICdDT05ORUNURUQnKSA/IGJHcmVlbiA6IGJZZWxsb3c7CiAgICAgICAgY29uc3Qgc3RhYmlsaXR5Q29sb3IgPSBpc0Nvbm5lY3Rpb25TdGFibGUgPyBiR3JlZW4gOiBiWWVsbG93OwoKICAgICAgICBjb25zdCBzdGF0dXNCb3ggPSBgCiR7YkN5YW4oJ+KUj+KUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUkycpfQoke2JDeWFuKCfilIMnKX0gICAgJHtiQ3lhbign8J+agCBTWVNURU0gTU9OSVRPUicpfSAg4pSB4pSBICAke2JXaGl0ZShQUk9KRUNUX05BTUUgfHwgJ0JPVCcpfSAgICAgJHtiQ3lhbign4pSDJyl9CiR7YkN5YW4oJ+KUo+KUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUqycpfQoke2JDeWFuKCfilIMnKX0gICR7YldoaXRlKCfwn5WSIExBU1QgQ0hFQ0snKX0gICR7YkN5YW4oJ+KUgycpfSAke2JXaGl0ZShsYXN0Q2hlY2tUaW1lKX0gICAgICAgJHtiQ3lhbign4pSDJyl9CiR7YkN5YW4oJ+KUgycpfSAgJHtiV2hpdGUoJ/Cfk4ogQk9UIFNUQVRVUycpfSAgJHtiQ3lhbign4pSDJyl9ICR7Y3VycmVudFN0YXR1c0NvbG9yKGJvdFN0YXR1cyl9ICAgICAgICAgICAgICR7YkN5YW4oJ+KUgycpfQoke2JDeWFuKCfilIMnKX0gICR7YldoaXRlKCfwn5uh77iPICBTVEFCSUxJVFknKX0gICAke2JDeWFuKCfilIMnKX0gJHtzdGFiaWxpdHlDb2xvcihpc0Nvbm5lY3Rpb25TdGFibGUgPyAn4pyFIFNUQUJMRScgOiAn4pqg77iPIFVOU1RBQkxFJyl9ICAgICAke2JDeWFuKCfilIMnKX0KJHtiQ3lhbign4pSDJyl9ICAke2JXaGl0ZSgn4o+zIENPTk4gVElNRScpfSAgICR7YkN5YW4oJ+KUgycpfSAke2JCbHVlKHVwdGltZSl9ICAgICAgICAgICAgICAgICAgICAgICAke2JDeWFuKCfilIMnKX0KJHtiQ3lhbign4pSX4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSbJyl9CiAgICAgICAgYC50cmltKCk7CgogICAgICAgIGNvbnNvbGUubG9nKCdcbicgKyBzdGF0dXNCb3ggKyAnXG4nKTsKCiAgICAgICAgbGFzdExvZ2dlZFN0YXR1cyA9IGJvdFN0YXR1czsKICAgICAgICBsYXN0U3RhdHVzTG9nID0gbm93OwogICAgfQp9OwoKCgoKLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IC8vCi8vID09PT09PT09PT0gU1RBUlQgQk9UID09PT09PT09PT09PT09PSAvLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gLy8KCnNldEludGVydmFsKG1haW50YWluQ29ubmVjdGlvbiwgNjAwMDApOwpzZXRJbnRlcnZhbChsb2dTdGF0dXMsIDIxNjAwMDAwKTsKCnByb2Nlc3Mub25jZSgnU0lHSU5UJywgKCkgPT4gewogICAgY29uc29sZS5sb2coY2hhbGsueWVsbG93KCJcbkJvdCBTdG9wcGVkIGJ5IFNJR0lOVC4iKSk7CiAgICBib3Quc3RvcCgnU0lHSU5UJyk7Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBib3QsCiAgICBicm93c2VyLAogICAgbGl2ZVNtc1BhZ2UsCiAgICBpc1BvbGxpbmdBY3RpdmUsCiAgICBpc0Jyb3dzZXJSZWFkeSwKICAgIGdldEJvdFN0YXR1czogKCkgPT4gYm90U3RhdHVzCn07Cgo=', 'base64').toString('utf-8'));